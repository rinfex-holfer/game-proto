var Ze=Object.defineProperty;var xe=Object.getOwnPropertySymbols;var tu=Object.prototype.hasOwnProperty,eu=Object.prototype.propertyIsEnumerable;var le=(u,t,e)=>t in u?Ze(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e,ye=(u,t)=>{for(var e in t||(t={}))tu.call(t,e)&&le(u,e,t[e]);if(xe)for(var e of xe(t))eu.call(t,e)&&le(u,e,t[e]);return u};var r=(u,t,e)=>(le(u,typeof t!="symbol"?t+"":t,e),e),Be=(u,t,e)=>{if(!t.has(u))throw TypeError("Cannot "+e)};var S=(u,t,e)=>(Be(u,t,"read from private field"),e?e.call(u):t.get(u)),H=(u,t,e)=>{if(t.has(u))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(u):t.set(u,e)},U=(u,t,e,i)=>(Be(u,t,"write to private field"),i?i.call(u,e):t.set(u,e),e);import{j as be,r as Xt,P as Y,i as uu,a as su}from"./vendor.40023d1a.js";const iu=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function e(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerpolicy&&(o.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?o.credentials="include":a.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=e(a);fetch(a.href,o)}};iu();let Oe=0;var g;(function(u){u.TIME_PASSED="TIME_PASSED",u.ALL_GIVEN="ALL_GIVEN",u.PAYMENT_GIVEN="PAYMENT_GIVEN",u.BATTLE_STARTED="BATTLE_STARTED",u.BATTLE_WON="BATTLE_WON",u.BATTLE_DEFEAT="BATTLE_DEFEAT",u.BATTLE_END="BATTLE_END",u.BATTLE_TRAVELLERS_TURN_END="BATTLE_TRAVELLERS_TURN_END",u.BYPASSED="BYPASSED",u.GAME_OVER="GAME_OVER",u.GAME_WIN="GAME_WIN",u.TROLL_STATS_CHANGED="TROLL_STATS_CHANGED",u.TROLL_LOCATION_CHANGED="TROLL_LOCATION_CHANGED",u.RESOURSES_CHANGED="RESOURSES_CHANGED",u.NEGOTIATION_STARTED="NEGOTIATION_STARTED",u.TRAVELLERS_APPEAR="TRAVELLERS_APPEAR",u.ENCOUNTER_ENDED="ENCOUNTER_ENDED",u.ENCOUNTER_STARTED="ENCOUNTER_STARTED",u.CHAR_LEFT_BRIDGE="CHAR_LEFT_BRIDGE",u.CHARS_PASSED_AFTER_ASKING="CHARS_PASSED_AFTER_ASKING",u.CHAR_READY_TO_TALK="CHAR_READY_TO_TALK",u.TROLL_TURN_END="TROLL_TURN_END",u.FEAR_CHANGES="FEAR_CHANGES",u.VIGILANTE_PLANNED="VIGILANTE_PLANNED",u.CHAR_DEFEATED="CHAR_DEFEATED",u.CHAR_DEVOURED_IN_BATTLE="CHAR_DEVOURED_IN_BATTLE",u.CHAR_DEVOURED="CHAR_DEVOURED",u.CHAR_TORN_APART="CHAR_TORN_APART"})(g||(g={}));const T={subs:{},on:function(t,e){this.subs[t]||(this.subs[t]={});const i=Oe;return this.subs[t][i]=e,Oe++,i},once:function(t,e){let i=-1;return i=this.on(t,(...a)=>{this.unsubscribe(t,i),e(...a)}),i},unsubscribe:function(t,e){this.subs[t][e]&&delete this.subs[t][e]},emit:function(u,t){console.log("emit",u,this.subs[u]),!!this.subs[u]&&Object.values(this.subs[u]).forEach(e=>e(t))}};function pt(){const u=[];return{on:(t,e)=>{const i=T.on(t,e);u.push([i,t])},clear:()=>{u.forEach(([t,e])=>T.unsubscribe(e,t))}}}window.eventBus=T;var Ft,wt,Pt,vt,Mt,Gt,kt,Ht,Ut,Vt,jt,Wt,Kt,$t,Yt;const k=class{constructor(){H(this,Ft,void 0);H(this,wt,void 0);H(this,Pt,void 0);H(this,vt,void 0);H(this,Mt,void 0);H(this,Gt,void 0);H(this,kt,void 0);H(this,Ht,void 0);H(this,Ut,void 0);H(this,Vt,void 0);H(this,jt,void 0);H(this,Wt,void 0);H(this,Kt,void 0);H(this,$t,void 0);H(this,Yt,void 0);r(this,"register",{render:t=>{U(this,Ft,t)},characters:t=>{U(this,wt,t)},bridge:t=>{U(this,Pt,t)},lair:t=>{U(this,vt,t)},troll:t=>{U(this,Mt,t)},audio:t=>{U(this,Gt,t)},music:t=>{U(this,kt,t)},time:t=>{U(this,Ht,t)},game:t=>{U(this,Ut,t)},battle:t=>{U(this,Vt,t)},layers:t=>{U(this,Wt,t)},entities:t=>{U(this,Kt,t)},interaction:t=>{U(this,$t,t)},upgrade:t=>{U(this,Yt,t)},negotiations:t=>{U(this,jt,t)}})}static crashStr(t){return"trying access "+t+" before it was created"}get render(){if(!S(this,Ft))throw Error(k.crashStr("render"));return S(this,Ft)}get characters(){if(!S(this,wt))throw Error(k.crashStr("characters"));return S(this,wt)}get bridge(){if(!S(this,Pt))throw Error(k.crashStr("bridge"));return S(this,Pt)}get lair(){if(!S(this,vt))throw Error(k.crashStr("lair"));return S(this,vt)}get troll(){if(!S(this,Mt))throw Error(k.crashStr("troll"));return S(this,Mt)}get audio(){if(!S(this,Gt))throw Error(k.crashStr("audio"));return S(this,Gt)}get music(){if(!S(this,kt))throw Error(k.crashStr("music"));return S(this,kt)}get time(){if(!S(this,Ht))throw Error(k.crashStr("time"));return S(this,Ht)}get game(){if(!S(this,Ut))throw Error(k.crashStr("game"));return S(this,Ut)}get battle(){if(!S(this,Vt))throw Error(k.crashStr("battle"));return S(this,Vt)}get layers(){if(!S(this,Wt))throw Error(k.crashStr("layers"));return S(this,Wt)}get entities(){if(!S(this,Kt))throw Error(k.crashStr("entities"));return S(this,Kt)}get interaction(){if(!S(this,$t))throw Error(k.crashStr("interaction"));return S(this,$t)}get upgrade(){if(!S(this,Yt))throw Error(k.crashStr("upgrade"));return S(this,Yt)}get negotiations(){if(!S(this,jt))throw Error(k.crashStr("negotiations"));return S(this,jt)}};let Ne=k;Ft=new WeakMap,wt=new WeakMap,Pt=new WeakMap,vt=new WeakMap,Mt=new WeakMap,Gt=new WeakMap,kt=new WeakMap,Ht=new WeakMap,Ut=new WeakMap,Vt=new WeakMap,jt=new WeakMap,Wt=new WeakMap,Kt=new WeakMap,$t=new WeakMap,Yt=new WeakMap;const s=new Ne;window.o_=s;const N=be.exports.jsx,V=be.exports.jsxs,ru=()=>{const[u,t]=Xt.exports.useState("");return Xt.exports.useEffect(()=>{const e=T.on(g.GAME_OVER,()=>t(s.game.gameOverReason));return()=>T.unsubscribe(g.GAME_OVER,e)},[t]),u?V("div",{id:"gameover",children:[N("div",{className:"title",children:"GAME OVER"}),N("div",{className:"reason",children:u})]}):null},p="./assets/img",ht="./assets/img/atlases",C="./assets/audio";var ce;(function(u){u.DEFAULT="DEFAULT"})(ce||(ce={}));const Q={images:{background:`${p}/bg.png`,cursor_default:`${p}/cursor_default.png`,floor:`${p}/floor.png`,grass:`${p}/tile_grass.png`,meat_raw:`${p}/meat_raw.png`,meat_stale:`${p}/meat_stale.png`,meat_dried:`${p}/meat_dried.png`,meat_human_leg:`${p}/meat_human_leg.png`,meat_human_hand:`${p}/meat_human_hand.png`,dish:`${p}/dish.png`,bones:`${p}/bones.png`,bed:`${p}/bed.png`,rock:`${p}/rock.png`,arrow:`${p}/arrow.png`,bridge_crack:`${p}/bridge_crack.png`,bed_upgraded:`${p}/bed-upgraded.png`,drying_rack:`${p}/drying_rack.png`,button_release:`${p}/leg.png`,button_imprison:`${p}/prisoner.png`,button_strike:`${p}/icon_claws.png`,button_kill:`${p}/icon_blood.png`,button_throw_rock:`${p}/icon_rock.png`,button_throw_char:`${p}/icon_throw_char.png`,button_devour:`${p}/icon_devour.png`,button_make_food:`${p}/icon_devour.png`,button_feed:`${p}/makeFood.png`,button_upgrade:`${p}/icon_build.png`,button_wait:`${p}/icon_wait.png`,status_change_dmg:`${p}/icon_blood.png`,status_change_heal:`${p}/icon_green_plus.png`,status_change_morale:`${p}/icon_morale.png`,status_change_self_control:`${p}/icon_self_control.png`,icon_shield:`${p}/icon_shield.png`,icon_crossed_swords:`${p}/icon_crossed_swords.png`,icon_surrender:`${p}/icon_surrender.png`,icon_rage:`${p}/icon_rage.png`,icon_speed:`${p}/icon_speed.png`,icon_fear_lowest:`${p}/icon_fear_lowest.png`,icon_fear_low:`${p}/icon_fear_low.png`,icon_fear_medium:`${p}/icon_fear_medium.png`,icon_fear_high:`${p}/icon_fear_high.png`,icon_fear_highest:`${p}/icon_fire_fiend_smiling.png`,icon_hand_with_sword:`${p}/icon_hand_with_sword.png`,icon_angry_people:`${p}/icon_angry_people.png`,icon_crossed_swords_fire:`${p}/icon_crossed_swords_fire.png`,icon_pay:`${p}/icon_pay.png`,icon_give_all:`${p}/icon_give_all.png`,empty_sprite:`${p}/tile_empty.png`,particle_hit:`${p}/particle_hit.png`,particle_blood:`${p}/particle_blood.jpg`,particle_smoke_green:`${p}/particle_smoke_green.png`,treasury:`${p}/treasury.png`,statue:`${p}/statue.png`,"gold-1":`${p}/gold-1.png`,"gold-2":`${p}/gold-2.png`,"gold-3":`${p}/gold-3.png`,"gold-4-9":`${p}/gold-4-9.png`,"gold-some":`${p}/gold-some.png`,"gold-many":`${p}/gold-many.png`,"gold-almost":`${p}/gold-almost.png`,"gold-chest":`${p}/gold-chest.png`,tile_black:`${p}/tile_black.png`},atlases:{troll:`${ht}/troll.json`,peasant:`${ht}/peasant.json`,pikeman:`${ht}/pikeman.json`,shieldman:`${ht}/shieldman.json`,archer:`${ht}/archer.json`,knight:`${ht}/knight.json`,horse:`${ht}/horse.json`,pot:`${ht}/pot.json`},sounds:{hitByTroll:`${C}/hit.wav`,block:`${C}/block.wav`,torn:`${C}/torn.wav`,pick:`${C}/pick_0.mp3`,pick_big:`${C}/pick_1.mp3`,pick_thin:`${C}/pick_2.mp3`,cancel:`${C}/cancel.mp3`,collect:`${C}/collect.mp3`,bonk:`${C}/toock.mp3`,bubble:`${C}/bubble.mp3`,chew:`${C}/chew.mp3`,eating_0:`${C}/eating_0.mp3`,eating_1:`${C}/eating_1.mp3`,eating_2:`${C}/eating_2.mp3`,eating_3:`${C}/eating_3.mp3`,level_up:`${C}/level_up.mp3`,upgrade:`${C}/upgrade.mp3`,troll_breathing:`${C}/troll_breathing.mp3`,troll_breathing_slow:`${C}/troll_breathing_slow.mp3`,troll_death:`${C}/troll_death.mp3`,troll_wounded_0:`${C}/troll_wounded_0.mp3`,troll_wounded_1:`${C}/troll_wounded_1.mp3`,troll_wounded_2:`${C}/troll_wounded_2.mp3`,troll_block_0:`${C}/troll_block_0.mp3`,troll_block_1:`${C}/troll_block_1.mp3`,troll_block_2:`${C}/troll_block_2.mp3`,troll_laugh_0:`${C}/troll_laugh_0.mp3`,troll_laugh_hard:`${C}/troll_laugh_1.mp3`,troll_laugh_medium:`${C}/troll_laugh_2.mp3`,troll_hm:`${C}/troll_hm.mp3`,troll_hey:`${C}/troll_hey.mp3`,troll_oh:`${C}/troll_oh.mp3`,troll_attack_voice:`${C}/troll_attack_voice.mp3`},music:{gameplay_music:`${C}/gameplay_music.mp3`,gameover:`${C}/music_game_over_0.mp3`,combat_started_0:`${C}/music_combat_started_0.mp3`,combat_started_1:`${C}/music_combat_started_1.mp3`,combat_won_0:`${C}/music_combat_won_0.mp3`,combat_won_1:`${C}/music_combat_won_1.mp3`,music_march:`${C}/music_march.mp3`,time_passed_0:`${C}/music_time_passed_0.mp3`,time_passed_1:`${C}/music_time_passed_1.mp3`,time_passed_2:`${C}/music_time_passed_2.mp3`}};ce.DEFAULT+"",Q.images.cursor_default;let Ee=0,de=0;const tt=()=>(Ee||(Ee=window.innerWidth*window.devicePixelRatio),de||(de=window.innerHeight*window.devicePixelRatio),{height:de,width:Ee}),qt={};function au(u){return qt[u]===void 0&&(qt[u]=-1),qt[u]=qt[u]+1,u+"_"+qt[u]}const et=()=>{};function ge(u,t){const e=u.indexOf(t);return e===-1?!1:(u.splice(e,1),!0)}function Fe(){const u=[];let t=0;return{sub:e=>{const i=t;return u.push([i,e]),t++,i},unsub:e=>{const i=u.findIndex(([a,o])=>a===e);i>-1?u.splice(i,1):console.warn("no subscriber with id",e)},emit:e=>{u.forEach(i=>i[1](e))}}}function lt(u,t){window[t]=u}function b(u){return new Promise(t=>{setTimeout(t,u)})}function F(){let u=et,t=et;return{promise:new Promise((i,a)=>{u=i,t=a}),done:u,fail:t}}const ou=u=>{const{promise:t,done:e,fail:i}=F(),a=document.getElementById("loading");u.load.on("progress",_=>{a&&(a.innerText="loading progress:"+Math.ceil(+_*100)+"%")}),u.load.on("complete",()=>{console.log("completed"),a&&a.remove(),e()}),u.load.on("loaderror",_=>{console.log(_),i()});const o=Object.keys(Q.images),c=Object.keys(Q.atlases),f=Object.keys(Q.music),D=Object.keys(Q.sounds);return o.forEach(_=>u.load.image(_,Q.images[_])),c.forEach(_=>{const z=Q.atlases[_],gt=z.replace(".json",".png");u.load.atlas(_,gt,z)}),f.forEach(_=>u.load.audio(_,Q.music[_])),D.forEach(_=>u.load.audio(_,Q.sounds[_])),t},nu={load:ou};function we(){return Math.random()>.5?1:-1}function ut(){return Math.random()}function hu(u,t){return ut()>.5?u:t}function X(u){const t=B(0,u.length-1);return u[t]}function B(u,t){return u+Math.floor(ut()*(t-u+1))}function lu(u,t){return{x:t.x-u.x,y:t.y-u.y}}function j(u,t){return cu(lu(u,t))}function cu(u){return Math.sqrt(u.x*u.x+u.y*u.y)}const Eu=(u,t)=>u.sort((e,i)=>j(e,t)<j(i,t)?-1:1);function Dt(u,t,e){return Math.max(Math.min(u,e),t)}Y.Input.Pointer;class du{constructor(t,e,i,a){r(this,"obj");this.scene=t,this.obj=new Y.GameObjects.Container(t,e,i),(a==null?void 0:a.parent)?a.parent.add(this):t.add.existing(this.obj)}setInteractive(t,e,i){t?this.obj.setInteractive(e,i):this.obj.disableInteractive()}add(t){this.obj.add(t.obj)}onClick(t){this.obj.on("pointerdown",e=>{e.rightButtonDown()||t()})}onRightClick(t){this.obj.on("pointerdown",e=>{e.rightButtonDown()&&t()})}onPointerOver(t){this.obj.on("pointerover",t)}onPointerOut(t){this.obj.on("pointerout",t)}move(t,e){this.obj.setPosition(t,e)}getCoords(){return{x:this.obj.x,y:this.obj.y}}remove(t){this.obj.remove(t.obj)}get x(){return this.obj.x}set x(t){this.obj.x=t}get y(){return this.obj.y}set y(t){this.obj.y=t}get height(){return this.obj.height}get width(){return this.obj.width}get alpha(){return this.obj.alpha}set alpha(t){this.obj.alpha=t}setVisibility(t){this.obj.visible=t}destroy(){this.obj.destroy()}addPhysics(){this.scene.physics.add.existing(this.obj)}stop(){this.obj.body.stop()}depthToY(){this.obj.depth=this.y}}Y.Input.Pointer;class Pe{constructor(t,e,i,a,o){r(this,"obj");this.scene=t,this.obj=new Y.GameObjects.Sprite(this.scene,i,a,e),(o==null?void 0:o.parent)?(this.obj=new Y.GameObjects.Sprite(this.scene,i,a,e),o.parent.add(this)):this.obj=this.scene.add.sprite(i,a,e),(o==null?void 0:o.width)&&(this.obj.displayWidth=o.width),(o==null?void 0:o.height)&&(this.obj.displayHeight=o.height)}setInteractive(t,e){t?this.obj.setInteractive(e):this.obj.disableInteractive()}setOrigin(t,e){this.obj.setOrigin(t,e)}setTexture(t){this.obj.setTexture(t)}move(t,e){this.obj.setPosition(t,e)}onClick(t){this.obj.on("pointerdown",e=>{e.rightButtonDown()||t()})}onRightClick(t){this.obj.on("pointerdown",e=>{e.rightButtonDown()&&t()})}onPointerOver(t){this.obj.on("pointerover",t)}onPointerOut(t){this.obj.on("pointerout",t)}flipX(){this.obj.scaleX=-this.obj.scaleX}get x(){return this.obj.x}set x(t){this.obj.x=t}get y(){return this.obj.y}set y(t){this.obj.y=t}get height(){return this.obj.displayHeight}get width(){return this.obj.displayWidth}setHeight(t,e){this.obj.displayHeight=t,e||(this.obj.displayWidth=this.obj.displayHeight*this.obj.width/this.obj.height)}setWidth(t,e){this.obj.displayWidth=t,e||(this.obj.displayHeight=this.obj.displayWidth*this.obj.height/this.obj.width)}get alpha(){return this.obj.alpha}set alpha(t){this.obj.alpha=t}setVisibility(t){this.obj.visible=t}destroy(){this.obj.destroy()}addPhysics(){this.scene.physics.add.existing(this.obj)}stop(){this.obj.body.stop()}depthToY(){this.obj.depth=this.y}}Y.Input.Pointer;const pe={};function ve(u,t){return u+"_"+t}function gu(u,t){pe[t.atlasKey]={};const e=u.textures.get(t.atlasKey);t.animations.forEach(i=>{const a=ve(t.atlasKey,i.framesPrefix),o=Object.keys(e.frames).filter(D=>D.startsWith(a)&&!isNaN(+D[a.length+1])).length,c={key:a,frames:u.anims.generateFrameNames(t.atlasKey,{prefix:a+"_",suffix:".png",end:o-1}),frameRate:i.frameRate,repeat:i.repeat},f=u.anims.create(c);if(!f)throw Error("wrong config for animation: "+t.atlasKey+" "+i.framesPrefix);pe[t.atlasKey][i.framesPrefix]=f})}class pu{constructor(t,e){r(this,"obj");r(this,"atlasKey");r(this,"leftClickCb",null);r(this,"rightClickCb",null);this.scene=t,this.atlasKey=e.atlasKey,pe[e.atlasKey]||gu(t,e),this.obj=new Y.GameObjects.Sprite(this.scene,e.x,e.y,e.atlasKey),(e==null?void 0:e.parent)&&e.parent.add(this),this.scene.add.existing(this.obj)}play(t,e){(e==null?void 0:e.onComplete)&&this.obj.once("animationcomplete",()=>{(e==null?void 0:e.onComplete)&&e.onComplete()}),this.obj.play(ve(this.atlasKey,t))}stopAnimation(){this.obj.stop()}move(t,e){this.obj.setPosition(t,e)}setInteractive(t,e){t?this.obj.setInteractive(e):this.obj.disableInteractive()}onClick(t){this.leftClickCb&&this.obj.removeListener("pointerdown",this.leftClickCb),this.leftClickCb=e=>{e.rightButtonDown()||t()},this.obj.on("pointerdown",this.leftClickCb)}removeClickListener(){this.obj.removeListener("pointerdown")}onRightClick(t){this.rightClickCb&&this.obj.removeListener("pointerdown",this.rightClickCb),this.rightClickCb=e=>{e.rightButtonDown()&&t()},this.obj.on("pointerdown",this.rightClickCb)}onPointerOver(t){this.obj.removeListener("pointerover"),this.obj.on("pointerover",t)}onPointerOut(t){this.obj.removeListener("pointerout"),this.obj.on("pointerout",t)}setOrigin(t,e){this.obj.setOrigin(t,e)}get x(){return this.obj.x}set x(t){this.obj.x=t}get y(){return this.obj.y}set y(t){this.obj.y=t}get height(){return this.obj.height}get width(){return this.obj.width}get alpha(){return this.obj.alpha}set alpha(t){this.obj.alpha=t}setVisibility(t){this.obj.visible=t}destroy(){this.obj.destroy()}addPhysics(){this.scene.physics.add.existing(this.obj)}stop(){this.obj.body.stop()}depthToY(){this.obj.depth=this.y}}Y.Input.Pointer;class Tu{constructor(t,e,i,a,o,c){r(this,"obj");this.scene=t,this.obj=this.scene.add.tileSprite(i,a,o,c,e)}setInteractive(t,e){t?this.obj.setInteractive(e):this.obj.disableInteractive()}onClick(t){this.obj.on("pointerdown",e=>{e.rightButtonDown()||t()})}onRightClick(t){this.obj.on("pointerdown",e=>{e.rightButtonDown()&&t()})}setOrigin(t,e){this.obj.setOrigin(t,e)}get x(){return this.obj.x}set x(t){this.obj.x=t}get y(){return this.obj.y}set y(t){this.obj.y=t}get height(){return this.obj.height}get width(){return this.obj.width}get alpha(){return this.obj.alpha}set alpha(t){this.obj.alpha=t}setVisibility(t){this.obj.visible=t}destroy(){this.obj.destroy()}addPhysics(){this.scene.physics.add.existing(this.obj)}stop(){this.obj.body.stop()}depthToY(){this.obj.depth=this.y}}class Au{constructor(t,e,i,a,o,c){r(this,"obj");this.scene=t,this.obj=new Y.GameObjects.Text(this.scene,i,a,e,o),(c==null?void 0:c.parent)&&c.parent.add(this)}setOrigin(t,e){this.obj.setOrigin(t,e)}setText(t){this.obj.frame.data&&(this.obj.text=t)}get x(){return this.obj.x}set x(t){this.obj.x=t}get y(){return this.obj.y}set y(t){this.obj.y=t}get height(){return this.obj.height}get width(){return this.obj.width}get alpha(){return this.obj.alpha}set alpha(t){this.obj.alpha=t}setVisibility(t){this.obj.visible=t}destroy(){this.obj.destroy()}addPhysics(){this.scene.physics.add.existing(this.obj)}stop(){this.obj.body.stop()}depthToY(){this.obj.depth=this.y}}var I;(function(u){u.BACKGROUND="BACKGROUND",u.PARTICLES="PARTICLES",u.FIELD_OBJECTS="FIELD_OBJECTS",u.FIELD_BUTTONS="FIELD_BUTTONS",u.UNDER_BUTTONS="UNDER_BUTTONS",u.MAIN_MENUES="MAIN_MENUES"})(I||(I={}));const fu=[[I.BACKGROUND,0],[I.FIELD_OBJECTS,1],[I.UNDER_BUTTONS,2],[I.FIELD_BUTTONS,3],[I.PARTICLES,4],[I.MAIN_MENUES,5]];class _u{constructor(t){r(this,"layers",{});this.scene=t,fu.forEach(e=>this.createLayer(e[0],e[1])),s.register.layers(this),s.time.sub(()=>this.update())}createLayer(t,e){this.layers[t]=this.scene.add.layer(),this.layers[t].depth=e}addRaw(t,e){this.layers[e].add(t)}add(t,e){this.addRaw(t.obj,e)}remove(t,e){this.layers[e].remove(t.obj)}update(){this.layers.FIELD_OBJECTS.getChildren().forEach(t=>{t.depth=t.y})}}Y.GameObjects.GameObject;class mu{constructor(t){r(this,"scene");r(this,"bloodEmitter");r(this,"yellowEmitter");r(this,"greenSmokeParticles");this.scene=t,s.register.render(this);const e=this.scene.add.particles("particle_blood");this.bloodEmitter=e.createEmitter({x:{min:-5,max:5},y:{min:-5,max:5},angle:{min:0,max:360},speed:{min:100,max:300},lifespan:300,frequency:-1,quantity:50}),s.layers.addRaw(e,I.PARTICLES);const i=this.scene.add.particles("particle_hit");this.yellowEmitter=i.createEmitter({x:{min:-15,max:15},y:{min:-15,max:15},angle:{min:250,max:290},speed:{min:600,max:800},gravityY:2400,frequency:-1,quantity:50,lifespan:500}),s.layers.addRaw(i,I.PARTICLES),this.greenSmokeParticles=this.scene.add.particles("particle_smoke_green"),s.layers.addRaw(this.greenSmokeParticles,I.PARTICLES)}createGreenSmokeEmitter(){return this.greenSmokeParticles.createEmitter({scale:{min:1,max:5},angle:270,speed:{min:10,max:50},frequency:300,quantity:5,lifespan:500,active:!1})}burstBlood(t,e){this.bloodEmitter.explode(50,t,e)}burstYellow(t,e){this.yellowEmitter.explode(50,t,e)}moveTowards(t,e,i,a,o){this.scene.physics.moveTo(t.obj,e,i,a,o)}moveTo(t,e,i){this.scene.physics.moveTo(t.obj,e.x,e.y,i);const a=F(),o=s.time.sub(c=>{const f=i/1e3*c;j(t,e)>f||(t.x=e.x,t.y=e.y,t.stop(),s.time.unsub(o),a.done())});return a.promise.catch(()=>{s.time.unsub(o)}),{promise:a.promise,stop:a.fail}}directToTarget(t,e,i){t.obj.scaleX=Math.sign(e.x-(t.obj.x+(i||0)))||1}createContainer(t,e,i){return new du(this.scene,t,e,i)}createSprite(t,e,i,a){return new Pe(this.scene,t,e,i,a)}createAnimatedSprite(t){return new pu(this.scene,t)}createTiles(t,e,i,a,o){return new Tu(this.scene,t,e,i,a,o)}createText(t,e,i,a,o){return new Au(this.scene,t,e,i,a,o)}createTimeline(t){return this.scene.tweens.createTimeline(t)}flyTo(t,e,i,a){const{promise:o,done:c}=F(),f=this.createTimeline();let _=j(t,e)/(i/1e3);return a&&a<_&&(_=a),f.add({targets:t.obj,x:e.x,y:e.y,ease:"Linear",duration:_,onComplete:c}),f.play(),o}flyWithBounceTo(t,e,i,a){const{promise:o,done:c}=F(),f=this.createTimeline();let _=j(t,e)/(i/1e3);return a&&a<_&&(_=a),f.add({targets:t.obj,x:e.x,y:e.y,ease:"Bounce.easeOut",duration:_,onComplete:c}),f.play(),o}jumpTo(t,e){const{promise:i,done:a}=F(),o=this.createTimeline(),c=j(t,e),f=400,D=c/3;return o.add({targets:t.obj,x:e.x,ease:"Linear",duration:f}),o.add({targets:t.obj,y:e.y-D,ease:"Linear",duration:f/2,offset:0}),o.add({targets:t.obj,y:e.y,ease:"Linear",duration:f/2,offset:f/2,onComplete:a}),o.play(),i}thrownTo(t,e,i){const{promise:a,done:o}=F(),c=this.createTimeline(),f=j(t,e);return c.add({targets:t.obj,x:e.x,ease:"Linear",duration:i,onComplete:o}),c.add({targets:t.obj,y:Math.min(t.y,e.y)-f/2,ease:"Quad.easeOut",duration:i/3,offset:0}),c.add({targets:t.obj,y:e.y,ease:"Bounce.easeOut",duration:i*2/3,offset:i/3}),c.play(),a}createPulseTimeline(t){const e=this.createTimeline();return e.add({targets:Array.isArray(t)?t.map(i=>i.obj):t.obj,ease:"Power2.easeInOut",yoyo:!0,repeat:-1,duration:300,scale:1.4}),e}bounceOfGround(t,e,i){const{promise:a,done:o}=F(),c=this.createTimeline();return c.add({targets:t.obj,y:t.y-e,ease:"Quad.easeOut",duration:i/3,offset:0}),c.add({targets:t.obj,y:t.y,ease:"Bounce.easeOut",duration:i*2/3,offset:i/3,onComplete:o}),c.play(),a}createJumpingTimeline(t,e=10,i=-1){const a=this.createTimeline();return a.add({targets:Array.isArray(t)?t.map(o=>o.obj):t.obj,ease:"Power2.easeInOut",yoyo:!0,repeat:i,duration:200,y:"-="+e}),a}fadeIn(t,e=500){const{promise:i,done:a}=F(),o=this.createTimeline();return o.add({targets:Array.isArray(t)?t.map(c=>c.obj):t.obj,ease:"Power2.easeOut",duration:e,alpha:1,onComplete:a}),o.play(),i}fadeOut(t,e=500){const{promise:i,done:a}=F(),o=this.createTimeline();return o.add({targets:Array.isArray(t)?t.map(c=>c.obj):t.obj,ease:"Power2.easeOut",duration:e,alpha:0,onComplete:a}),o.play(),i}}var Tt;(function(u){u.MEAT="MEAT",u.DISH="DISH"})(Tt||(Tt={}));var v;(function(u){u.BRIDGE="BRIDGE",u.LAIR="LAIR"})(v||(v={}));var At;(function(u){u.MORNING="morning",u.AFTERNOON="afternoon",u.EVENING="evening",u.NIGHT="night"})(At||(At={}));var l;(function(u){u.FARMER="peasant",u.MILITIA="militia",u.ARCHER="archer",u.SHIELDMAN="shieldman",u.KNIGHT="knight",u.VIGILANTE="vigilante",u.KING="king"})(l||(l={}));var h;(function(u){u.NONE="NONE",u.LOW="LOW",u.MEDIUM="MEDIUM",u.HIGH="HIGH",u.VERY_HIGH="VERY_HIGH",u.IMPOSSIBLE="IMPOSSIBLE"})(h||(h={}));var Lt;(function(u){u.VIGILANTE="VIGILANTE",u.KING="KING"})(Lt||(Lt={}));var ft;(function(u){u.GOLD="gold",u.FOOD="food"})(ft||(ft={}));var K;(function(u){u[u.THROW_ROCK=0]="THROW_ROCK",u[u.GRAPPLE=1]="GRAPPLE",u[u.MAN_EATER=2]="MAN_EATER"})(K||(K={}));var L;(function(u){u.ON_START="ON_START",u.DEMAND_ALL="\u041F\u043E\u0442\u0440\u0435\u0431\u043E\u0432\u0430\u0442\u044C \u0432\u0441\u0435",u.DEMAND_PAY="\u041F\u043E\u0442\u0440\u0435\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u043B\u0430\u0442\u0443",u.GO_IN_PEACE="\u041E\u0442\u043F\u0443\u0441\u0442\u0438\u0442\u044C",u.TO_BATTLE="\u0410\u0442\u0430\u043A\u043E\u0432\u0430\u0442\u044C"})(L||(L={}));const x={negotiationX(){const u=x.bridgePosition();return u.x+u.width*.7},bridgePosition(){const u=tt();return{x:0,y:u.height/6,width:u.width,height:u.height/2}},getLairPosition(){const u=tt();return{x:u.width/4,y:u.height*2/3,width:u.width/2,height:u.height/3}},getFoodStoragePosition(){const u=x.getLairPosition();return{x:u.x+150,y:u.y+u.height*4/4}},getBedPosition(){const u=x.getLairPosition();return{x:u.x+100,y:u.y+u.height*1/4}},getPotPosition(){const u=x.getLairPosition();return{x:u.x+100,y:u.y+u.height*2.5/4}},getTreasuryPosition(){const u=x.getLairPosition();return{x:u.x+u.width-300,y:u.y+u.height*1/4}},getRandomPlaceForMeat(u){const t=this.getFoodStoragePosition();let e=B(-20,20),i=B(-20,20);return u.props.isStale&&(e+=100),u.props.isHuman&&(i-=50),{x:t.x-100+e,y:t.y-50+i}},getPrisonerPosition(){const u=x.getLairPosition(),t=s.characters.getPrisoners().length;return{x:u.x+u.width/2+t*50,y:u.y+u.height*.5}},getBuildButtonPosition(){const u=x.getLairPosition();return{x:u.x-100,y:u.y+100}}};var A;(function(u){u.IDLE="IDLE",u.GO_TO="GO_TO",u.GO_ACROSS="GO_ACROSS",u.GO_TO_TALK="GO_TO_TALK",u.SURRENDER="SURRENDER",u.UNCONSCIOUS="UNCONSCIOUS",u.DEAD="DEAD",u.BONES="BONES",u.GO_TO_BATTLE_POSITION="GO_TO_BATTLE_POSITION",u.BATTLE_IDLE="BATTLE_IDLE",u.BATTLE_ATTACK="BATTLE_ATTACK",u.BATTLE_GO_DEFEND="BATTLE_GO_DEFEND",u.BATTLE_SURRENDER="BATTLE_SURRENDER"})(A||(A={}));var d;(function(u){u.WALK="walk",u.IDLE="idle",u.FALL="fall",u.UNCONSCIOUS="unconscious",u.DAMAGED="damaged",u.BLOCK="block",u.SURRENDER="scared",u.PRISONER="prisoner",u.DEAD="dead",u.STRIKE="strike",u.STRIKE_DOWN="strike_down",u.THROW_STONE="throw_stone",u.GRAPPLE="grapple",u.DEVOUR="devoure"})(d||(d={}));const te=[At.MORNING,At.AFTERNOON,At.EVENING,At.NIGHT],It={CHAR_SPEED:100,CHAR_FAST:150,CHAR_VERY_FAST:250,horse:{speed:500},BRIDGE_HOLES:[[3,0],[4,.1],[5,.33],[6,1]]},R={GREEN:"rgb(0, 256, 0)",RED:"rgb(256, 0, 0)",BLUE:"rgb(0,119,255)",LIGHT_BLUE:"rgb(173, 216, 230)",PURPLE:"rgb(138,43,226)",WHITE:"rgb(256, 256, 256)",BLACK:"rgb(0, 0, 0)",YELLOW:"rgb(255, 255, 0)",ORANGE:"rgb(255, 165, 0)"},y={GREEN:43520,ROTTEN:11206570,RED:16711680,BLUE:39423,LIGHT_BLUE:11393254,PURPLE:524296,WHITE:16777215,BLACK:0,YELLOW:16776960,ORANGE:16753920};function zt(u,t,e,i,a){const o=s.render.createText(u,t,e,{align:"center",color:i||R.WHITE,fontStyle:"bold",fontSize:"22px",stroke:R.BLACK,strokeThickness:3});o.setOrigin(.5,.5),s.layers.add(o,I.FIELD_BUTTONS);const c=s.render.scene.tweens.createTimeline();let f=e-100,D;a&&(D=a==="left"?B(t-200,t-100):B(t+100,t+200),f=B(e-100,e-10));const _=F(),z={targets:o.obj,ease:"Cubic.easeOut",y:f,duration:2e3};return D&&(z.x=D),c.add(z),c.add({targets:o.obj,ease:"Linear",alpha:0,duration:500,offset:1500,onComplete:_.done}),c.play(),_.promise}var w;(function(u){u.GAMEPLAY_MUSIC="GAMEPLAY_MUSIC",u.GAMEOVER="GAMEOVER",u.BATTLE_STARTED_0="BATTLE_STARTED_0",u.BATTLE_STARTED_1="BATTLE_STARTED_1",u.BATTLE_WON_0="BATTLE_WON_0",u.BATTLE_WON_1="BATTLE_WON_1",u.MARCH="MARCH",u.TIME_PASSED_0="TIME_PASSED_0",u.TIME_PASSED_1="TIME_PASSED_1",u.TIME_PASSED_2="TIME_PASSED_2"})(w||(w={}));var E;(function(u){u.HIT="HIT",u.BLOCK="BLOCK",u.TORN="TORN",u.PICK="PICK",u.PICK_BIG="PICK_BIG",u.PICK_THIN="PICK_THIN",u.CANCEL="CANCEL",u.COLLECT="COLLECT",u.BONK="BONK",u.BUBBLE="BUBBLE",u.CHEW="CHEW",u.EATING_0="EATING_0",u.EATING_1="EATING_1",u.EATING_2="EATING_2",u.EATING_3="EATING_3",u.LEVEL_UP="LEVEL_UP",u.UPGRADE="UPGRADE",u.TROLL_BREATHING_SLOW="TROLL_BREATHING_SLOW",u.TROLL_BREATHING="TROLL_BREATHING",u.TROLL_DEATH="TROLL_DEATH",u.TROLL_WOUNDED_0="TROLL_WOUNDED_0",u.TROLL_WOUNDED_1="TROLL_WOUNDED_1",u.TROLL_WOUNDED_2="TROLL_WOUNDED_2",u.TROLL_BLOCK_0="TROLL_BLOCK_0",u.TROLL_BLOCK_1="TROLL_BLOCK_1",u.TROLL_BLOCK_2="TROLL_BLOCK_2",u.TROLL_ATTACK_VOICE="TROLL_ATTACK_VOICE",u.TROLL_LAUGH_0="TROLL_LAUGH_0",u.TROLL_LAUGH_HARD="TROLL_LAUGH_HARD",u.TROLL_LAUGH_MEDIUM="TROLL_LAUGH_MEDIUM",u.TROLL_HM="TROLL_HM",u.TROLL_OH="TROLL_OH",u.TROLL_HEY="TROLL_HEY"})(E||(E={}));const Cu=[{key:E.HIT,src:"hitByTroll",volume:.1,loop:!1},{key:E.BLOCK,src:"block",volume:.2,loop:!1},{key:E.TORN,src:"torn",volume:.02,loop:!1},{key:E.PICK,src:"pick",volume:.2,loop:!1},{key:E.PICK_BIG,src:"pick_big",volume:.2,loop:!1},{key:E.PICK_THIN,src:"pick_thin",volume:.2,loop:!1},{key:E.CANCEL,src:"cancel",volume:.2,loop:!1},{key:E.COLLECT,src:"collect",volume:.2,loop:!1},{key:E.BONK,src:"bonk",volume:.2,loop:!1},{key:E.BUBBLE,src:"bubble",volume:.2,loop:!1},{key:E.CHEW,src:"chew",volume:1,loop:!1},{key:E.EATING_0,src:"eating_0",volume:1,loop:!1},{key:E.EATING_1,src:"eating_1",volume:1,loop:!1},{key:E.EATING_2,src:"eating_2",volume:1,loop:!1},{key:E.EATING_3,src:"eating_3",volume:1,loop:!1},{key:E.LEVEL_UP,src:"level_up",volume:.2,loop:!1},{key:E.UPGRADE,src:"upgrade",volume:.2,loop:!1},{key:E.TROLL_BREATHING,src:"troll_breathing",volume:.2,loop:!1},{key:E.TROLL_BREATHING_SLOW,src:"troll_breathing_slow",volume:.2,loop:!1},{key:E.TROLL_DEATH,src:"troll_death",volume:.2,loop:!1},{key:E.TROLL_WOUNDED_0,src:"troll_wounded_0",volume:.2,loop:!1},{key:E.TROLL_WOUNDED_1,src:"troll_wounded_1",volume:.2,loop:!1},{key:E.TROLL_WOUNDED_2,src:"troll_wounded_2",volume:.2,loop:!1},{key:E.TROLL_BLOCK_0,src:"troll_block_0",volume:.2,loop:!1},{key:E.TROLL_BLOCK_1,src:"troll_block_1",volume:.2,loop:!1},{key:E.TROLL_BLOCK_2,src:"troll_block_2",volume:.2,loop:!1},{key:E.TROLL_ATTACK_VOICE,src:"troll_attack_voice",volume:.2,loop:!1},{key:E.TROLL_LAUGH_0,src:"troll_laugh_0",volume:.2,loop:!1},{key:E.TROLL_LAUGH_HARD,src:"troll_laugh_hard",volume:.2,loop:!1},{key:E.TROLL_LAUGH_MEDIUM,src:"troll_laugh_medium",volume:.2,loop:!1},{key:E.TROLL_HM,src:"troll_hm",volume:.2,loop:!1},{key:E.TROLL_OH,src:"troll_oh",volume:.2,loop:!1},{key:E.TROLL_HEY,src:"troll_hey",volume:.2,loop:!1}],Du=[{key:w.GAMEPLAY_MUSIC,src:"gameplay_music",volume:.1,loop:!0},{key:w.GAMEOVER,src:"gameover",volume:.1,loop:!1},{key:w.BATTLE_STARTED_0,src:"combat_started_0",volume:.1,loop:!1},{key:w.BATTLE_STARTED_1,src:"combat_started_1",volume:.1,loop:!1},{key:w.BATTLE_WON_0,src:"combat_won_0",volume:.1,loop:!1},{key:w.BATTLE_WON_1,src:"combat_won_1",volume:.1,loop:!1},{key:w.MARCH,src:"music_march",volume:.1,loop:!1},{key:w.TIME_PASSED_0,src:"time_passed_0",volume:.1,loop:!1},{key:w.TIME_PASSED_1,src:"time_passed_1",volume:.1,loop:!1},{key:w.TIME_PASSED_2,src:"time_passed_2",volume:.1,loop:!1}];class Lu{constructor(t){r(this,"soundVolume",1);r(this,"musicVolume",1);r(this,"sounds",{});r(this,"music",{});r(this,"scene");r(this,"playSound",t=>{this.sounds[t]&&this.sounds[t].play()});r(this,"playingCurrently");r(this,"playMusic",t=>{this.playingCurrently&&this.music[this.playingCurrently].isPlaying&&this.music[this.playingCurrently].stop(),this.music[t].isPlaying||(this.music[t].play(),this.playingCurrently=t)});r(this,"stopSound",t=>{this.sounds[t]&&this.sounds[t].stop()});r(this,"stopMusic",t=>{this.music[t]&&this.music[t].stop()});r(this,"stopAll",()=>{});this.scene=t,Cu.forEach(e=>{this.sounds[e.key]=t.sound.add(e.src,{loop:e.loop,volume:e.volume})}),Du.forEach(e=>{this.music[e.key]=t.sound.add(e.src,{loop:e.loop,volume:e.volume})}),s.register.audio(this)}setMusicVolume(t){}setSoundVolume(t){}}var O;(function(u){u.IDLE="IDLE",u.GO_TO="GO_TO",u.SLEEP="SLEEP",u.UNCONSCIOUS="UNCONSCIOUS",u.BATTLE_ATTACK="BATTLE_ATTACK"})(O||(O={}));class Jt{constructor(t){r(this,"host");r(this,"onEndPromise");r(this,"onEndCallback");this.host=t;const{promise:e,done:i}=F();this.onEndPromise=e,this.onEndCallback=i}update(t){}start(){return this.onStart(),this.onEndPromise}onStart(){}end(){this.onEnd(),this.onEndCallback()}onEnd(){}}class Iu extends Jt{constructor(){super(...arguments);r(this,"key",O.IDLE)}onStart(){this.host.stop(),this.host.setAnimation(d.IDLE)}}class Ru extends Jt{constructor(t,e){super(t);r(this,"key",O.GO_TO);r(this,"options");r(this,"minDistance",10);var i;this.options=e,this.minDistance=(i=e.minDistance)!=null?i:10}onStart(){var t,e;this.host.setAnimation(d.WALK),this.host.moveTowards(this.options.target.x,this.options.target.y),(e=(t=this.options).onStart)==null||e.call(t),this.checkDistance()}checkDistance(){j(this.host.container,this.options.target)<=this.minDistance&&this.host.goIdle()}update(t){this.host.moveTowards(this.options.target.x,this.options.target.y),this.checkDistance()}}var W;(function(u){u.HARMLESS="HARMLESS",u.NOT_SERIOUS="NOT_SERIOUS",u.UNPREDICTABLE="UNPREDICTABLE",u.DANGEROUS="DANGEROUS",u.HORRIFIC="HORRIFIC"})(W||(W={}));const m={TROLL_MAX_HUNGER:10,TROLL_MAX_SELF_CONTROL:100,HUNGER_PER_TIME:1,HP_MINUS_WHEN_HUNGRY:.05,HP_FROM_SLEEP:.1,HP_FROM_SLEEP_ON_BED:.25,SELF_CONTROL_FROM_SLEEP:1,DMG_MODIFIER_RAGE:1.5,DMG_MODIFIER_THROW_ROCK:1.25,DMG_MODIFIER_GRAPPLE:1,TROLL_MAX_FEAR:100,FEAR_CHANGES:{DEVOUR:10,VICTORY:4,ALL_GIVEN:6,DEFEAT:-10,LET_PASS_AFTER_ASKING:-5,ASK_PAY_AFTER_ALL_REFUSED:-2,LET_PASS:-2,DAY_PASSED:-2},FEAR_LEVELS:[[-100,W.HARMLESS],[-66,W.NOT_SERIOUS],[-33,W.UNPREDICTABLE],[33,W.DANGEROUS],[66,W.HORRIFIC]],FEAR_FACTOR:.1,TROLL_SPEED:500,PASS_COST:.33,TROLL_LEVELING:{1:{maxHp:15,maxHunger:10,block:0,dmg:[3,6],xp:10,xpRewards:{[l.FARMER]:2,[l.MILITIA]:5,[l.ARCHER]:5,[l.SHIELDMAN]:10,[l.KNIGHT]:50,[l.VIGILANTE]:100,[l.KING]:100},newAbilities:[K.MAN_EATER]},2:{maxHp:30,maxHunger:15,block:0,dmg:[7,13],xp:50,xpRewards:{[l.FARMER]:2,[l.MILITIA]:4,[l.ARCHER]:10,[l.SHIELDMAN]:20,[l.KNIGHT]:50,[l.VIGILANTE]:100,[l.KING]:100},newAbilities:[K.THROW_ROCK]},3:{maxHp:60,maxHunger:20,block:0,dmg:[10,20],xp:100,xpRewards:{[l.FARMER]:0,[l.MILITIA]:4,[l.ARCHER]:10,[l.SHIELDMAN]:20,[l.KNIGHT]:100,[l.VIGILANTE]:100,[l.KING]:100},newAbilities:[K.GRAPPLE]},4:{maxHp:100,maxHunger:10,block:0,dmg:[15,30],xp:300,xpRewards:{[l.FARMER]:0,[l.MILITIA]:4,[l.ARCHER]:10,[l.SHIELDMAN]:20,[l.KNIGHT]:100,[l.VIGILANTE]:100,[l.KING]:100},newAbilities:[]},5:{maxHp:150,maxHunger:10,block:0,dmg:[20,40],xp:-1,xpRewards:{[l.FARMER]:0,[l.MILITIA]:0,[l.ARCHER]:0,[l.SHIELDMAN]:0,[l.KNIGHT]:0,[l.VIGILANTE]:0,[l.KING]:0},newAbilities:[]}}},Su=+Object.keys(m.TROLL_LEVELING).sort((u,t)=>+u-+t).pop();class xu extends Jt{constructor(){super(...arguments);r(this,"key",O.SLEEP)}onStart(){this.host.stop(),this.host.setAnimation(d.IDLE),this.host.directToTarget({x:this.host.sprite.x+1,y:this.host.sprite.y}),this.host.sprite.obj.rotation=-Math.PI/2,this.host.sprite.setOrigin(.5,.5);const t=Math.ceil((s.lair.bed.upgraded?m.HP_FROM_SLEEP_ON_BED:m.HP_FROM_SLEEP)*this.host.maxHp);this.host.hunger!==this.host.maxHunger&&this.host.heal(t),this.host.changeSelfControl(m.SELF_CONTROL_FROM_SLEEP),this.host.zzz.show(this.host.x-30,this.host.y-30),s.time.wait(),s.audio.playSound(E.TROLL_BREATHING_SLOW)}onEnd(){this.host.zzz.hide(),this.host.setInitialSpriteOrigin(),this.host.sprite.obj.rotation=0}}const yu=10;class Bu{constructor(t,e){r(this,"container");r(this,"letters");r(this,"timeline");this.x=t,this.y=e,this.container=s.render.createContainer(t,e),s.layers.add(this.container,I.FIELD_BUTTONS),this.letters=Array.from({length:3}).map((o,c)=>{const f=s.render.createText("z",0,0,{color:R.WHITE},{parent:this.container});return f.setVisibility(!1),f});const i=o=>({targets:this.letters[o],ease:"Linear",alpha:0,y:this.y-yu*6,duration:6e3,repeat:-1,offset:o*2e3,onStart:()=>this.letters[o].setVisibility(!0)}),a=o=>({targets:this.letters[o],ease:"Sine.easeInOut",yoyo:!0,x:this.x-25,duration:1500,repeat:-1,offset:o*2e3});this.timeline=s.render.createTimeline(),this.timeline.add(i(0)),this.timeline.add(a(0)),this.timeline.add(i(1)),this.timeline.add(a(1)),this.timeline.add(i(2)),this.timeline.add(a(2)),this.timeline.play(),setTimeout(()=>this.timeline.pause()),this.container.setVisibility(!1)}show(t,e){this.container.move(t,e),this.container.setVisibility(!0),this.timeline.resume()}hide(){this.container.setVisibility(!1),this.timeline.pause()}destroy(){this.container.destroy()}}class _t{constructor(t){r(this,"x");r(this,"y");r(this,"width");r(this,"height");r(this,"color");r(this,"colorOptions");r(this,"rectOuter");r(this,"rect");r(this,"container");r(this,"value");r(this,"maxValue");r(this,"minValue");r(this,"label");r(this,"text");r(this,"withoutNumbers");this.options=t,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.color=t.color||y.GREEN,this.colorOptions=t.colorOptions||[[0,y.GREEN]],this.maxValue=t.maxValue||100,this.value=t.value||this.maxValue,this.minValue=t.minValue||0,this.container=s.render.createContainer(this.x,this.y,t.parent?{parent:t.parent}:void 0),this.rect=s.render.scene.add.rectangle(0,0,this.width,this.height,this.color),this.rect.setOrigin(0,0),this.rectOuter=new Phaser.GameObjects.Graphics(s.render.scene,{x:0,y:0}),this.rectOuter.lineStyle(2,y.WHITE,.5),this.rectOuter.fillStyle(y.BLACK,.3),this.rectOuter.fillRect(0,0,this.width,this.height),this.rectOuter.strokeRect(0,0,this.width,this.height),this.container.obj.add(this.rect),this.container.obj.add(this.rectOuter),this.withoutNumbers=t.withoutNumbers||!1,this.label=t.text,this.text=s.render.createText("",this.width/2,this.height/2,t.textStyle||{},{parent:this.container}),this.text.setOrigin(.5,.5),this.updateText()}updateText(t=this.value){let e="";this.label&&(e=`${this.label}`),this.withoutNumbers||(this.label?e+=`: ${Math.round(t)}`:e+=`${Math.round(t)}`),this.text.setText(e)}updateScale(){this.rect.scaleX=this.getPercent()}getPercent(){const t=this.maxValue-this.minValue;return(this.value-this.minValue)/t}updateColor(){var e;const t=this.getPercent();for(let i=0;i<this.colorOptions.length;i++){const a=this.colorOptions[i][0],o=(e=this.colorOptions[i+1])==null?void 0:e[0];t>=a&&(o===void 0||t<o)&&(this.color=this.colorOptions[i][1],this.rect.fillColor=this.color)}}update(){this.updateScale(),this.updateText(),this.updateColor()}setMaxValue(t){t!==this.maxValue&&(this.maxValue=t,this.update())}setValue(t,e=!0){if(this.value===t)return;if(!e){this.value=t,this.update();return}const i=s.render.createTimeline();i.add({targets:this,value:t,duration:1e3,ease:"Cubic.easeOut",onUpdate:()=>{this.update()},onComplete:()=>{this.update()}}),i.play()}setVisibility(t){this.container.setVisibility(t)}setLabel(t){this.label=t,this.updateText()}}var $;(function(u){u.FADE_IN="FADE_IN",u.CHANGE="CHANGE",u.FADE_OUT="FADE_OUT",u.HIDDEN="HIDDEN"})($||($={}));const ct=450,bu=40,Ou=150;class Nu{constructor(){r(this,"xpContainer");r(this,"xpBar");r(this,"state",$.HIDDEN);r(this,"transitionsQueue",[]);r(this,"maxLevelReached",!1);const t=tt();this.xpContainer=s.render.createContainer(t.width/2,Ou),s.layers.add(this.xpContainer,I.FIELD_BUTTONS),this.xpBar=new _t({x:-ct*.5,y:0,maxValue:10,value:0,width:ct,height:bu,colorOptions:[[0,y.WHITE],[.75,y.GREEN]],text:"",parent:this.xpContainer,withoutNumbers:!0}),this.xpContainer.alpha=0}updateVal(t,e,i){e===-1||this.maxLevelReached||(this.xpBar.setMaxValue(e),this.xpBar.setValue(t,!1),this.xpBar.setLabel("\u0423\u0440\u043E\u0432\u0435\u043D\u044C "+ +i))}async addTransition(t){if(!this.maxLevelReached&&(this.transitionsQueue.push(t),this.state===$.HIDDEN))return this.setState($.FADE_IN)}async setState(t){switch(this.state=t,t){case $.FADE_IN:return this.fadeIn();case $.CHANGE:return this.change();case $.FADE_OUT:return this.fadeOut();case $.HIDDEN:return}}async fadeIn(){return await s.render.fadeIn(this.xpContainer),this.setState($.CHANGE)}async fadeOut(){return await s.render.fadeOut(this.xpContainer),this.transitionsQueue.length?this.setState($.FADE_IN):this.setState($.HIDDEN)}async change(){const t=this.transitionsQueue.shift();if(!t||this.maxLevelReached)return this.setState($.FADE_OUT);const[e,i,a]=t;return this.xpBar.setLabel("\u0423\u0440\u043E\u0432\u0435\u043D\u044C "+ +a),this.xpBar.setMaxValue(i),this.xpBar.setValue(e,!0),await b(1100),e===i&&(s.audio.playSound(E.LEVEL_UP),this.xpBar.setValue(0,!1),this.xpBar.setLabel(`\u0414\u043E\u0441\u0442\u0438\u0433\u043D\u0443\u0442 \u0443\u0440\u043E\u0432\u0435\u043D\u044C ${a+1}!`),s.render.burstYellow(this.xpContainer.x-ct/2,this.xpContainer.y),s.render.burstYellow(this.xpContainer.x+ct/2,this.xpContainer.y),await b(500),s.render.burstYellow(this.xpContainer.x-ct/2,this.xpContainer.y),s.render.burstYellow(this.xpContainer.x+ct/2,this.xpContainer.y),await b(500),s.render.burstYellow(this.xpContainer.x-ct/2,this.xpContainer.y),s.render.burstYellow(this.xpContainer.x+ct/2,this.xpContainer.y),await b(500),i===-1&&(this.maxLevelReached=!0,this.xpBar.setLabel("\u0423\u0440\u043E\u0432\u0435\u043D\u044C "+ +(a+1)+" (max!)")),await b(500)),this.setState($.CHANGE)}}const Fu=50,wu=30,Te=30,ee=300,ue=20;class Pu{constructor(t){r(this,"container");r(this,"hungerBar");r(this,"hpBar");r(this,"selfControl");r(this,"fear");r(this,"xpMeter");this.troll=t,this.container=s.render.createContainer(Fu,wu),this.hpBar=new _t({x:0,y:0,maxValue:t.maxHp,value:t.hp,width:ee,height:ue,colorOptions:[[0,y.RED],[.33,y.ORANGE],[.66,y.GREEN]],text:"\u0417\u0434\u043E\u0440\u043E\u0432\u044C\u0435",parent:this.container}),this.hungerBar=new _t({x:0,y:Te,maxValue:t.maxHunger,value:t.hunger,width:ee,height:ue,colorOptions:[[0,y.GREEN],[.5,y.ORANGE],[.8,y.RED]],text:"\u0413\u043E\u043B\u043E\u0434",parent:this.container}),this.selfControl=new _t({x:0,y:Te*2,maxValue:t.maxSelfControl,value:t.selfControl,width:ee,height:ue,colorOptions:[[0,y.RED],[.33,y.ORANGE],[.66,y.GREEN]],text:"\u0421\u0430\u043C\u043E\u043A\u043E\u043D\u0442\u0440\u043E\u043B\u044C",parent:this.container}),this.fear=new _t({x:0,y:Te*3,minValue:-m.TROLL_MAX_FEAR,maxValue:m.TROLL_MAX_FEAR,value:t.fear,width:ee,height:ue,colorOptions:[[0,y.GREEN],[.165,y.BLUE],[.33,y.WHITE],[.66,y.YELLOW],[.825,y.RED]],text:"\u0421\u0442\u0440\u0430\u0448\u043D\u043E\u0441\u0442\u044C",parent:this.container}),this.xpMeter=new Nu,this.xpMeter.updateVal(t.xp,t.getNextLvlReqs(),t.level)}update(t=!0){this.hungerBar.setMaxValue(this.troll.maxHunger),this.hpBar.setMaxValue(this.troll.maxHp),this.selfControl.setMaxValue(this.troll.maxSelfControl),this.hungerBar.setValue(this.troll.hunger,t),this.hpBar.setValue(this.troll.hp,t),this.selfControl.setValue(this.troll.selfControl,t),this.fear.setValue(this.troll.fear,t)}updateXp(t,e,i,a){return t?this.xpMeter.addTransition([e,i,a]):(this.xpMeter.updateVal(e,i,a),Promise.resolve())}showNewAbility(t){switch(t){case K.THROW_ROCK:break;case K.GRAPPLE:break;case K.MAN_EATER:break}const e=50,i=tt(),a=i.width/2,o=i.height/2;let c="",f="button_throw_rock";switch(t){case K.THROW_ROCK:c="\u041C\u0435\u0442\u043D\u0443\u0442\u044C \u043A\u0430\u043C\u0435\u043D\u044C",f="button_throw_rock";break;case K.GRAPPLE:c="\u0411\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0431 \u0437\u0435\u043C\u043B\u044E",f="button_throw_char";break;case K.MAN_EATER:c="\u0421\u043E\u0436\u0440\u0430\u0442\u044C",f="button_devour";break}let D=s.render.createSprite(f,a,o,{width:e,height:e}),_=s.render.createText("New ability: "+c,a,o+e,{align:"center",color:R.WHITE,fontStyle:"bold",fontSize:"22px",stroke:R.BLACK,strokeThickness:3});_.setOrigin(.5,0),s.layers.add(D,I.FIELD_BUTTONS),s.layers.add(_,I.FIELD_BUTTONS),setTimeout(()=>{s.render.fadeOut([D,_]).then(()=>{D.destroy(),_.destroy()})},3e3)}}class vu extends Jt{constructor(t,e){super(t);r(this,"key",O.BATTLE_ATTACK);r(this,"targetId");this.targetId=e.targetId}onStart(){this.host.strike(s.characters.getTraveller(this.targetId)).then(()=>this.host.goIdle())}}function Mu(){console.log("onEncounterStart"),s.interaction.disableEverything(),s.troll.goToBattlePosition(),s.characters.setPrisonersInteractive(!1),s.characters.travellersGoToTalk(),T.emit(g.ENCOUNTER_STARTED)}function Ae(){console.log("onEncounterEnd"),!s.game.isGameover&&(s.interaction.enableEverything(),s.characters.enableInteractivityOnBridge(),s.characters.setPrisonersInteractive(!0),T.emit(g.ENCOUNTER_ENDED))}function Me(){s.troll.location=v.BRIDGE,s.lair.mayButtonsBeClicked(!1),s.lair.mayBeMovedInto(!0),s.lair.menu.hide(),s.bridge.disableInterface(),T.emit(g.TROLL_LOCATION_CHANGED,v.BRIDGE)}function fe(){s.troll.location=v.LAIR,s.lair.mayButtonsBeClicked(!0),s.lair.mayBeMovedInto(!1),s.lair.menu.show(),s.bridge.enableInterface(),T.emit(g.TROLL_LOCATION_CHANGED,v.LAIR)}function Gu(){s.troll.location=v.LAIR,s.lair.mayBeMovedInto(!0),s.bridge.enableInterface()}function ku(u){const t=u.sprite||u.container;!t||(s.render.thrownTo(t,{x:t.x+we()*100,y:t.y},600),s.render.fadeOut(t,300),b(500).then(()=>u.destroy()),s.audio.playSound(E.BONK))}function Ge(u){const t=u.sprite||u.container;!t||(s.render.fadeOut(t,500),b(600).then(()=>u.destroy()))}class _e{register(){return s.entities.register(this.type,this)}deregister(){s.entities.deregister(this)}updateInteractive(){}setInteractive(t){}}var G;(function(u){u.MEAT="MEAT",u.GOLD="GOLD",u.ROCK="ROCK"})(G||(G={}));class Hu{constructor(){r(this,"entities",{[G.MEAT]:[],[G.GOLD]:[],[G.ROCK]:[]});r(this,"entityNextId",{[G.MEAT]:0,[G.GOLD]:0,[G.ROCK]:0});s.register.entities(this)}register(t,e){this.entities[t].push(e),this.entities[t];const i=this.entityNextId[t];return this.entityNextId[t]++,t+"_"+i}get(t){return this.entities[t]}deregister(t){ge(this.entities[t.type],t)||console.warn("entity",t.id,"was not found entityManager therefore not deregistered")}getAll(){return Object.values(this.entities).flat()}}class Uu extends _e{constructor(t){super();r(this,"type",G.ROCK);r(this,"id");r(this,"sprite");r(this,"subs",pt());r(this,"props",{});this.id=this.register(),this.sprite=s.render.createSprite("rock",t.x,t.y),this.sprite.setOrigin(0,.5),this.updateLayer()}updateLayer(){s.layers.add(this.sprite,I.FIELD_OBJECTS)}onTimePassed(){}destroy(){this.deregister(),this.subs.clear(),this.sprite.destroy()}throwTo(t){return s.render.thrownTo(this.sprite,t,700)}}const Z={RAW_MEAT_TIME_LIMIT:6,STALE_MEAT_TIME_LIMIT:6,FOOD_FOR_DISH:3,FOOD_FROM_CHARACTER:4,FOOD_FROM_DEVOURED_CHARACTER:3,FOOD:{[Tt.MEAT]:{ANIMAL:{hp:2,xp:6,hunger:-2,selfControl:-1},ANIMAL_STALE:{hp:1,xp:1,hunger:-2,selfControl:-2},HUMAN:{hp:4,xp:6,hunger:-3,selfControl:-5},HUMAN_STALE:{hp:2,xp:1,hunger:-3,selfControl:-10}},[Tt.DISH]:{ANIMAL:{hp:10,xp:24,hunger:-8,selfControl:0},ANIMAL_STALE:{hp:3,xp:4,hunger:-6,selfControl:-4},HUMAN:{hp:10,xp:24,hunger:-12,selfControl:-10},HUMAN_STALE:{hp:2,xp:4,hunger:-10,selfControl:-15}}}},Rt=36,St=5,me=10,Vu=100,Qt=Rt+St*2,ke=Rt+St*2+me+Vu,ju=u=>Rt+St*2+me+u,Wu=St+Rt+me;class He{constructor(t,e,i){r(this,"container");r(this,"notifications",[]);r(this,"deleteTimer");r(this,"numbersQueue",[]);r(this,"timer");this.parent=t,this.x=e,this.y=i,this.container=s.render.createContainer(e-ke/2,i-Qt,{parent:t})}show(t,e,i=R.GREEN){const a=-this.notifications.length*(Qt+St),o=s.render.createContainer(0,a-30,{parent:this.container});o.alpha=.5,s.render.fadeIn(o),s.render.flyWithBounceTo(o,{x:0,y:a},100);const c=s.render.createSprite("tile_black",0,0,{width:ke,height:Qt,parent:o});c.alpha=.3,c.setOrigin(0,0),s.render.createSprite(e,St,Qt/2,{width:Rt,height:Rt,parent:o}).setOrigin(0,.5);const D=s.render.createText(t,Wu,Qt/2,{color:i,fontStyle:"bold",fontSize:"20px"},{parent:o});D.setOrigin(0,.5),c.setWidth(ju(D.width),!0),this.notifications.push(o),this.updateDeleteTimer()}updateDeleteTimer(){clearTimeout(this.deleteTimer),this.deleteTimer=setTimeout(()=>{const t=this.notifications;s.render.fadeOut(t).then(()=>t.forEach(e=>e.destroy())),this.notifications=[]},2e3)}showCounterAttack(){this.show("counter-attack!","icon_crossed_swords",R.WHITE)}showBlock(){this.show("block!","icon_shield",R.WHITE)}showSurrender(){this.show("surrender!","icon_surrender",R.WHITE)}showRage(){this.show("Rage!","icon_rage",R.RED)}showRageStops(){this.show("Rage stops","status_change_self_control",R.WHITE)}showEvade(){this.show("Evade!","icon_speed",R.WHITE)}showHungerDmg(t){this.flyingNumbers("\u0413\u043E\u043B\u043E\u0434!",R.RED),this.showDmg(t)}showDmg(t,e){this.flyingNumbers(""+t,R.RED,e)}showHeal(t){this.flyingNumbers("+"+t,R.GREEN)}showMoraleDmg(t,e){this.flyingNumbers(""+t,R.BLUE,e)}flyingNumbers(t,e,i){let a=this.parent.x,o=this.parent.y-100;i&&(o+=50,a=i==="left"?a-30:a+30),this.numbersQueue.push([""+t,a,o,e,i]),!this.timer&&this.nextNumbers()}nextNumbers(){const t=this.numbersQueue.shift();if(!t){this.timer=null;return}zt(...t),this.timer=setTimeout(()=>{this.nextNumbers()},600)}showSelfControlReduce(t){this.flyingNumbers("\u0421\u0430\u043C\u043E\u043A\u043E\u043D\u0442\u0440\u043E\u043B\u044C: "+t,R.BLUE)}showSelfControlIncrease(t){this.flyingNumbers("\u0421\u0430\u043C\u043E\u043A\u043E\u043D\u0442\u0440\u043E\u043B\u044C: +"+t,R.BLUE)}showFearChange(t){const e="\u0421\u0442\u0440\u0430\u0448\u043D\u043E\u0441\u0442\u044C: "+(t>0?"+"+t:""+t);this.flyingNumbers(e,t>0?R.RED:R.WHITE)}}class Ku extends Jt{constructor(){super(...arguments);r(this,"key",O.UNCONSCIOUS)}onStart(){this.host.setAnimation(d.UNCONSCIOUS)}onEnd(){this.host.hp===0&&this.host.heal(1)}}class Ue{constructor(t,e=-15,i=-120,a=50,o=5){r(this,"bar");this.char=t,this.bar=new _t({x:e,y:i,width:a,height:o,maxValue:t.maxHp,value:t.hp,color:y.GREEN,colorOptions:[[0,y.RED],[.33,y.ORANGE],[.66,y.GREEN]],parent:t.container,withoutNumbers:!0}),this.hide()}update(){this.bar.setMaxValue(this.char.maxHp),this.bar.setValue(this.char.hp)}updateShowAndHide(){this.show(),b(1e3).then(()=>this.hide())}show(){this.update(),this.bar.setVisibility(!0)}hide(){this.bar.setVisibility(!1)}}const Ve={COUNTER_ATTACK_AGAINST_GRAPPLE_BONUS:1,GRAPPLE_COOLDOWN:3,GRAPPLE_STUN_MIN:1,GRAPPLE_STUN_MAX:3};class $u{constructor(){r(this,"location",v.LAIR);r(this,"isEnraged",!1);r(this,"xp",0);r(this,"level",1);r(this,"hp",1);r(this,"maxHp",1);r(this,"hunger",0);r(this,"maxHunger",m.TROLL_MAX_HUNGER);r(this,"selfControl",m.TROLL_MAX_SELF_CONTROL);r(this,"maxSelfControl",m.TROLL_MAX_SELF_CONTROL);r(this,"fear",0);r(this,"block",0);r(this,"dmg",[1,1]);r(this,"sprite");r(this,"container");r(this,"statusNotifications");r(this,"hpIndicator");r(this,"zzz");r(this,"speed",m.TROLL_SPEED);r(this,"state");r(this,"stats");r(this,"notificationTimer",null);r(this,"grappleCooldown",0);r(this,"notificationsQueue",[]);r(this,"fearLevel",W.UNPREDICTABLE);s.register.troll(this);const t=x.getLairPosition();this.container=s.render.createContainer(t.x+t.width/2,t.y+t.height/2),this.container.addPhysics(),this.sprite=s.render.createAnimatedSprite({atlasKey:"troll",animations:[{framesPrefix:d.WALK,repeat:-1,frameRate:8},{framesPrefix:d.FALL,repeat:-1,frameRate:4},{framesPrefix:d.IDLE,repeat:-1,frameRate:8},{framesPrefix:d.DEAD,repeat:-1,frameRate:8},{framesPrefix:d.DAMAGED,frameRate:8},{framesPrefix:d.DEVOUR,frameRate:8},{framesPrefix:d.GRAPPLE,frameRate:8},{framesPrefix:d.STRIKE,frameRate:8},{framesPrefix:d.STRIKE_DOWN,frameRate:4},{framesPrefix:d.THROW_STONE,frameRate:8},{framesPrefix:d.UNCONSCIOUS,frameRate:1}],x:0,y:0,parent:this.container}),this.setInitialSpriteOrigin(),s.layers.add(this.container,I.FIELD_OBJECTS),this.statusNotifications=new He(this.container,0,-this.sprite.height),this.zzz=new Bu(0,0),T.on(g.TIME_PASSED,()=>this.increaseHunger()),s.time.sub(i=>this.update(i)),this.state=this.getState(O.IDLE),this.state.onStart(),this.stats=new Pu(this),this.hp=m.TROLL_LEVELING[this.level].maxHp,this.onNewLevel(!1),this.hpIndicator=new Ue(this,-30,-100,50,10);let e=0;T.on(g.TIME_PASSED,()=>{e++,e>1&&(this.fear>0&&this.changeFear(m.FEAR_CHANGES.DAY_PASSED),e=0)}),T.on(g.BATTLE_STARTED,()=>this.hpIndicator.show()),T.on(g.BATTLE_END,()=>{this.hpIndicator.hide(),this.resetCooldownds()}),T.on(g.BATTLE_DEFEAT,()=>this.changeFear(m.FEAR_CHANGES.DEFEAT)),T.on(g.BATTLE_WON,i=>{i===h.LOW||i===h.NONE||this.changeFear(m.FEAR_CHANGES.VICTORY)}),T.on(g.CHAR_DEVOURED,()=>this.changeFear(m.FEAR_CHANGES.DEVOUR)),T.on(g.CHAR_DEVOURED_IN_BATTLE,()=>this.changeFear(m.FEAR_CHANGES.DEVOUR)),T.on(g.CHAR_TORN_APART,()=>this.changeFear(m.FEAR_CHANGES.DEVOUR)),fe(),lt(i=>this.addXp(i),"addXp"),lt(()=>{this.level=5,this.onNewLevel(!1)},"maxLevel"),lt(i=>this.changeFear(i),"changeFear"),lt(i=>this.heal(i),"heal")}setInitialSpriteOrigin(){this.sprite.setOrigin(.5,1)}get x(){return this.container.x}get y(){return this.container.y}onNewLevel(t=!0){const e=m.TROLL_LEVELING[this.level];this.xp=0,this.maxHp=e.maxHp,this.block=e.block,this.dmg=e.dmg,this.stats.update(t),t&&e.newAbilities.length&&setTimeout(()=>{this.stats.showNewAbility(e.newAbilities[0])},2e3)}getFearLevel(){for(let t=0;t<m.FEAR_LEVELS.length;t++){const e=m.FEAR_LEVELS[t];if(this.fear>=e[0])return e[1]}return console.error("cant map fear value "+this.fear+" to fear levels"),m.FEAR_LEVELS[m.FEAR_LEVELS.length-1][1]}getNextLvlReqs(){return m.TROLL_LEVELING[this.level].xp}getIsAlive(){return this.hp>0}increaseHunger(t=m.HUNGER_PER_TIME){if(this.hunger===m.TROLL_MAX_HUNGER){const e=-Math.ceil(this.maxHp*m.HP_MINUS_WHEN_HUNGRY);this.statusNotifications.showHungerDmg(e),this.changeTrollHp(e,"hunger"),this.hpIndicator.updateShowAndHide()}this.changeHunger(t)}eat(t,e=!1,i=!1){let a=i?"HUMAN":"ANIMAL";e&&(a+="_STALE");const o=Z.FOOD[t][a].hp,c=Z.FOOD[t][a].hunger,f=Z.FOOD[t][a].selfControl;this.heal(o),this.changeHunger(c),this.changeSelfControl(f),s.audio.playSound(X([E.EATING_0,E.EATING_1,E.EATING_2,E.EATING_3])),T.emit(g.TROLL_STATS_CHANGED)}changeHunger(t){this.hunger=Dt(this.hunger+t,0,this.maxHunger),this.stats.update()}getXpForSquad(t){let e=0;return t.forEach(i=>e+=m.TROLL_LEVELING[this.level].xpRewards[i]),e}getCurrentAbilities(){let t=[];for(let e=this.level;e>0;e--)t=t.concat(m.TROLL_LEVELING[e].newAbilities);return t}showNextNotification(){const t=this.notificationsQueue.shift();t?(zt(t[0],t[1],t[2],t[3]),this.notificationTimer=window.setTimeout(()=>{this.showNextNotification()},700)):this.notificationTimer=null}changeSelfControl(t){if(t!==0){if(t>0){if(this.selfControl===this.maxSelfControl)return;this.statusNotifications.showSelfControlIncrease(t)}else{if(this.selfControl===0)return;this.statusNotifications.showSelfControlReduce(t)}this.selfControl=Dt(this.selfControl+t,0,this.maxSelfControl),this.stats.update()}}heal(t){this.hp!==this.maxHp&&(t=Math.ceil(t),this.statusNotifications.showHeal(t),this.changeTrollHp(t),this.hpIndicator.updateShowAndHide())}changeFear(t){const e=Dt(this.fear+t,-m.TROLL_MAX_FEAR,m.TROLL_MAX_FEAR);if(e===this.fear)return;let i=this.fearLevel;for(let a=0;a<m.FEAR_LEVELS.length;a++){const o=m.FEAR_LEVELS[a],c=m.FEAR_LEVELS[a+1];if(!c||e>=o[0]&&e<c[0]){i=o[1];break}}i!==this.fearLevel&&(this.fearLevel=i,T.emit(g.FEAR_CHANGES,this.fearLevel)),this.fear=e,this.statusNotifications.showFearChange(t),this.stats.update()}changeTrollHp(t,e="hunger"){const i=this.hp+t;this.hp=Math.max(Math.min(i,this.maxHp),0),this.hpIndicator.update(),this.hp===0&&(this.setState(O.UNCONSCIOUS),this.hunger===this.maxHunger&&!s.game.isGameover&&s.game.gameOver("\u0422\u0440\u043E\u043B\u043B\u044C \u0443\u043C\u0435\u0440! (\u0433\u043E\u043B\u043E\u0434 \u043D\u0430 \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C\u0435, \u0437\u0434\u043E\u0440\u043E\u0432\u044C\u0435 \u043D\u0430 \u043D\u0443\u043B\u0435)")),this.stats.update()}setAnimation(t,e){this.sprite.play(t,{onComplete:e})}getState(t,e){switch(t){case O.IDLE:return new Iu(this);case O.GO_TO:return new Ru(this,e);case O.SLEEP:return new xu(this);case O.BATTLE_ATTACK:return new vu(this,e);case O.UNCONSCIOUS:return new Ku(this);default:throw Error("wrong state key "+t)}}getIsMaxLevelReached(){return Su===this.level}setState(t,e){return console.log("new troll state:",t),this.state.end(),this.state=this.getState(t,e),this.state.start()}goToBridge(){const t={x:0,y:0},e=x.bridgePosition();return t.x=e.x+e.width/2,t.y=e.y+e.height/2,this.setState(O.GO_TO,{target:t,onStart:Me,onEnd:Me})}goToLair(){const t={x:0,y:0},e=x.getLairPosition();t.x=e.x+e.width/2,t.y=e.y+e.height/2,this.setState(O.GO_TO,{target:t,onStart:fe,onEnd:fe})}goToBed(){const t={x:0,y:0},e=x.getBedPosition();return t.x=e.x,t.y=e.y,Gu(),this.setState(O.GO_TO,{target:t}).then(()=>this.goSleep())}goToChar(t){var e=s.characters.getTraveller(t);if(!e)throw Error("WTF");return this.isEnraged?this.jumpToChar(e):this.setState(O.GO_TO,{target:e.container,minDistance:50})}async jumpToChar(t){await this.jumpTo({x:t.container.x-50,y:t.container.y})}async jumpTo(t){await s.render.jumpTo(this.container,t)}moveToChar(t){return this.isEnraged?this.jumpToChar(t):this.goToChar(t.id)}moveToDefenderOfChar(t){const e={x:0,y:0},i=t.getDefenderPosition();return e.x=i.x,e.y=i.y,this.isEnraged?this.jumpTo(e):this.setState(O.GO_TO,{target:e})}getBattlePosition(){const t=x.bridgePosition();return{x:t.x+t.width/2,y:t.y+t.height/2}}async jumpToBattlePosition(){await this.jumpTo(this.getBattlePosition())}async goToBattlePosition(){this.isEnraged&&await this.jumpToBattlePosition(),await this.setState(O.GO_TO,{target:this.getBattlePosition()});const t=s.characters.getFighters();t.length&&this.directToTarget(t[0].container)}goIdle(){this.setState(O.IDLE)}goSleep(){this.setState(O.SLEEP)}goTo(t,e){return this.setState(O.GO_TO,{target:t,minDistance:e})}async devour(t){await this.runAnimationOnce(d.STRIKE_DOWN),this.eat(Tt.MEAT,!1,!0),s.characters.charEaten(t),await b(1e3),this.setAnimation(d.IDLE)}async devourAttack(t){const e=s.characters.getTraveller(t);await this.goTo(e.container,30),await this.runAnimationOnce(d.GRAPPLE);const i=100;await Promise.all([s.render.flyTo(this.container,{x:this.container.x-i,y:this.container.y},500),s.render.flyTo(e.container,{x:e.container.x-i,y:e.container.y},500)]),await this.devour(t)}getHit(t){t=Math.ceil(t),ut()<this.block?(s.audio.playSound(X([E.TROLL_BLOCK_0,E.TROLL_BLOCK_1,E.TROLL_BLOCK_2])),this.statusNotifications.showBlock()):(s.render.burstBlood(this.container.x,this.container.y-this.sprite.height/2),s.audio.playSound(E.HIT),b(100).then(()=>{s.audio.playSound(X([E.TROLL_WOUNDED_0,E.TROLL_WOUNDED_1,E.TROLL_WOUNDED_2]))}),this.changeTrollHp(-t,"battle"),this.statusNotifications.showDmg(t,"left"))}burstBlood(){s.render.burstBlood(this.container.x,this.container.y-this.sprite.height/2)}getLastHit(){this.burstBlood(),this.burstBlood(),this.burstBlood(),s.audio.playSound(E.TROLL_DEATH),s.game.gameOver("\u0422\u0440\u043E\u043B\u043B\u044C \u0443\u0431\u0438\u0442!")}moveTowards(t,e){s.render.moveTowards(this.container,t,e,this.speed),this.directToTarget({x:t,y:e})}directToTarget(t){s.render.directToTarget(this.sprite,t,this.container.x)}rageStopCheck(){we()<0&&this.setEnraged(!1)}rageStartCheck(){let t=(this.maxSelfControl-this.selfControl)/(100*2);const e=ut();console.log("chance of rage",t,"roll",e,e<=t),e<=t&&this.setEnraged(!0)}rollDmg(t=!1,e=!1){let i=B(this.dmg[0],this.dmg[1]);return this.isEnraged&&(i*=m.DMG_MODIFIER_RAGE),t&&(i*=m.DMG_MODIFIER_GRAPPLE),e&&(i*=m.DMG_MODIFIER_THROW_ROCK),Math.ceil(i)}getDmg(t=!1,e=!1){const i=[this.dmg[0],this.dmg[1]];return t&&(i[0]=Math.ceil(i[0]*m.DMG_MODIFIER_GRAPPLE),i[1]=Math.ceil(i[1]*m.DMG_MODIFIER_GRAPPLE)),e&&(i[0]=Math.ceil(i[0]*m.DMG_MODIFIER_THROW_ROCK),i[1]=Math.ceil(i[1]*m.DMG_MODIFIER_THROW_ROCK)),i}rollStun(){return 2}stop(){this.container.stop()}update(t){this.state.update(t)}addXpForCurrentFighters(t=1){const e=s.characters.getFighters(),i=this.getXpForSquad(e.map(a=>a.key));this.addXp(Math.ceil(t*i))}addXp(t){if(t===0)return;this.xp=Math.min(this.getNextLvlReqs(),this.xp+t);const e=this.getNextLvlReqs(),i=this.xp===e;this.stats.updateXp(!0,this.xp,e,this.level),i&&(this.level++,this.onNewLevel())}attack(t){return this.setState(O.BATTLE_ATTACK,{targetId:t.id})}async strike(t){s.audio.playSound(E.TROLL_ATTACK_VOICE);const e=t.isUnconscious?d.STRIKE_DOWN:d.STRIKE;await this.runAnimationOnce(e),s.characters.hitChar(t.id,this.rollDmg()),this.setAnimation(d.IDLE)}async runAnimationOnce(t){const e=F();return this.setAnimation(t,e.done),e.promise}async throwRockAt(t){const e=s.bridge.getClosestRockPlace(this);this.isEnraged&&await this.jumpTo(e),await this.setState(O.GO_TO,{target:e}),this.directToTarget(t.container),s.audio.playSound(E.TROLL_ATTACK_VOICE),e.ruin(!0);const i=F();this.setAnimation(d.THROW_STONE,i.done),await i.promise;const a=new Uu({x:this.x,y:this.container.y-this.container.height+10});this.setAnimation(d.IDLE),await s.render.flyTo(a.sprite,t.getCoordsToThrowInto(),1e3),a.destroy(),s.characters.hitChar(t.id,this.rollDmg(!1,!0))}async throwChar(t){await this.runAnimationOnce(d.GRAPPLE),t.setAnimation(d.UNCONSCIOUS);const e=F(),i=s.render.createJumpingTimeline([this.container,t.container],100,0);i.once("complete",e.done),i.play(),await e.promise,this.setAnimation(d.IDLE),s.characters.hitChar(t.id,this.rollDmg(!0),{grabbed:!0,stun:this.rollStun()}),await s.render.bounceOfGround(t.container,50,1e3),this.grappleCooldown=Ve.GRAPPLE_COOLDOWN}updateCooldowns(){this.grappleCooldown>0&&this.grappleCooldown--}resetCooldownds(){this.grappleCooldown=0}setEnraged(t){t!==this.isEnraged&&(this.isEnraged=t,t?(s.audio.playSound(E.TROLL_BREATHING),this.statusNotifications.showRage()):this.statusNotifications.showRageStops())}laugh(){s.audio.playSound(X([E.TROLL_LAUGH_0,E.TROLL_LAUGH_MEDIUM]))}laughHard(){s.audio.playSound(X([E.TROLL_LAUGH_HARD,E.TROLL_LAUGH_MEDIUM]))}hmm(){s.audio.playSound(X([E.TROLL_HM,E.TROLL_HEY,E.TROLL_OH]))}}const st={MAX_GOLD_IN_SPRITE:100,costs:{fix_bridge:10,drying_rack:25,bridge_ornament:200}};class Yu{constructor(){r(this,"sprite");r(this,"pos");r(this,"shakePosition");r(this,"isWithStatues",!1);r(this,"rockPlaces",[]);this.pos=x.bridgePosition(),this.sprite=s.render.createTiles("floor",this.pos.x,this.pos.y,this.pos.width,this.pos.height),this.sprite.setOrigin(0,0),this.sprite.addPhysics(),this.enableInterface(),this.sprite.onClick(()=>s.troll.goToBridge()),s.register.bridge(this),this.createRockPlaces(),this.shakePosition=s.game.getScene().plugins.get("rexshakepositionplugin").add(this.sprite.obj),s.upgrade.createUpgradeButton({x:this.pos.x+this.pos.width-150,y:this.pos.y+50},"\u0423\u043A\u0440\u0430\u0441\u0438\u0442\u044C \u043C\u043E\u0441\u0442",st.costs.bridge_ornament,()=>this.createStatues())}enableInterface(){this.sprite.setInteractive(!0,{cursor:"pointer"})}disableInterface(){this.sprite.setInteractive(!1)}updateMayBeMovedInto(){s.troll.location===v.BRIDGE?this.disableInterface():this.enableInterface()}createRockPlaces(){[[this.pos.x+this.pos.width/2+50,this.pos.y+50],[this.pos.x+this.pos.width/2-100,this.pos.y+100],[this.pos.x+this.pos.width/2-200,this.pos.y+120],[this.pos.x+this.pos.width/2-30,this.pos.y+this.pos.height-70],[this.pos.x+this.pos.width/2-130,this.pos.y+this.pos.height-70],[this.pos.x+this.pos.width/2-230,this.pos.y+this.pos.height-70]].forEach(e=>this.rockPlaces.push(new Xu(e[0],e[1])))}getRockPlaces(){return this.rockPlaces}getClosestRockPlace(t){const e=this.rockPlaces.filter(a=>!a.isRuined);return Eu(e,t)[0]}getHasAvailableRocks(){return this.getRockPlaces().some(t=>!t.isRuined)}onRuined(){this.getRockPlaces().filter(e=>e.isRuined).length>=4&&this.shake()}checkDestruction(){return this.getRockPlaces().filter(t=>t.isRuined).length,!1}shake(){this.shakePosition.shake()}fall(){this.shake(),s.interaction.disableEverything();const t=tt();s.render.moveTo(this.sprite,{x:0,y:t.height+100},300).promise.then(()=>{s.game.gameOver("\u041C\u043E\u0441\u0442 \u0440\u0443\u0445\u043D\u0443\u043B!")})}createStatues(){const t={width:100,height:100};s.render.createSprite("statue",this.pos.x+100,this.pos.y+10,t),s.render.createSprite("statue",this.pos.x+100,this.pos.y+this.pos.height-60,t);const e=s.render.createSprite("statue",this.pos.x+this.pos.width-100,this.pos.y+10,t),i=s.render.createSprite("statue",this.pos.x+this.pos.width-100,this.pos.y+this.pos.height-60,t);e.flipX(),i.flipX(),this.isWithStatues=!0}}class Xu{constructor(t,e){r(this,"x");r(this,"y");r(this,"crackSprite");r(this,"isRuined",!1);r(this,"btn");this.x=t,this.y=e,this.crackSprite=new Pe(s.game.getScene(),"bridge_crack",t,e),this.crackSprite.setVisibility(!1)}createUpgradeButton(t){this.btn=s.upgrade.createUpgradeButton(t,"\u041F\u043E\u0447\u0438\u043D\u0438\u0442\u044C \u043C\u043E\u0441\u0442\u043E\u0432\u0443\u044E",st.costs.fix_bridge,()=>{this.repair()})}repair(){this.crackSprite.setVisibility(!1),this.isRuined=!1}ruin(t){this.crackSprite.setVisibility(!0),this.isRuined=!0,this.createUpgradeButton({x:this.x,y:this.y}),t&&s.bridge.onRuined()}}class qu{constructor(){r(this,"bg");const t=tt();this.bg=s.render.createSprite("background",0,0,{width:t.width,height:t.height}),this.bg.setOrigin(0,0)}}var P;(function(u){u.GROUND="GROUND",u.STORAGE="STORAGE",u.LAIR="LAIR"})(P||(P={}));const Zt={ANIMAL:"meat_raw",HUMAN_HAND:"meat_human_hand",HUMAN_LEG:"meat_human_leg"};class se extends _e{constructor(t,e=P.GROUND,i=!1,a=Zt.ANIMAL){super();r(this,"type",G.MEAT);r(this,"id");r(this,"sprite");r(this,"location");r(this,"destroyed",!1);r(this,"timePassed",0);r(this,"subs",pt());r(this,"jumpTimeline");r(this,"jumpTimelineDirty",!1);r(this,"pot");r(this,"realPosition");r(this,"rottenGas");r(this,"props",{isHuman:!1,isStale:!1});r(this,"onClick");this.id=this.register(),this.location=e,this.props.isHuman=i,this.sprite=s.render.createSprite(a,t.x,t.y),this.sprite.setOrigin(.5,.5),s.layers.add(this.sprite,I.FIELD_OBJECTS),this.sprite.onClick(()=>{if(this.onClick)return this.onClick();this.onClickDefault()}),this.sprite.onRightClick(()=>{this.onRightClick()}),this.realPosition=this.updateRealPosition(),this.jumpTimeline=s.render.createJumpingTimeline(this.sprite),this.rottenGas=s.render.createGreenSmokeEmitter(),this.subs.on(g.TIME_PASSED,()=>this.onTimePassed()),this.updateInteractive()}onClickDefault(){this.bePlacedOrBeEaten()}onRightClick(){this.location===P.STORAGE?this.flyOnLairGround():ku(this)}flyOnLairGround(){this.flyTo(x.getRandomPlaceForMeat(this)).then(()=>s.audio.playSound(E.BONK)),this.setLocation(P.LAIR),s.lair.foodStorage.updateFood()}bePlacedOrBeEaten(){switch(this.location){case P.GROUND:s.lair.foodStorage.hasFreeSpace()?s.lair.foodStorage.placeFood(this):this.flyOnLairGround();break;case P.STORAGE:this.eat();break;case P.LAIR:s.lair.foodStorage.hasFreeSpace()?s.lair.foodStorage.placeFood(this):this.eat();break}}eat(){s.troll.eat(Tt.MEAT,this.props.isStale,this.props.isHuman),s.lair.foodStorage.updateFood(),this.destroy()}setJumping(t){t?this.jumpTimeline.play():(this.jumpTimeline.stop(),this.jumpTimeline.destroy(),this.jumpTimeline=s.render.createJumpingTimeline(this.sprite),this.sprite.move(this.realPosition.x,this.realPosition.y))}becomeRotten(){this.props.isStale=!0,this.timePassed=0,this.updateEmitters(),this.rottenGas.active=!0,this.sprite.obj.setTint(y.ROTTEN),this.location===P.LAIR&&this.flyOnLairGround()}updateEmitters(){var i,a;const t=((i=this.sprite.obj.parentContainer)==null?void 0:i.x)||0,e=((a=this.sprite.obj.parentContainer)==null?void 0:a.y)||0;this.rottenGas.setPosition({min:this.sprite.obj.x-10+t,max:this.sprite.x+10+t},{min:this.sprite.y-10+e,max:this.sprite.y+10+e})}onTimePassed(){if(this.timePassed++,this.location!==P.STORAGE&&(this.timePassed+=2,ut()>.9))return Ge(this);!this.props.isStale&&this.timePassed>Z.RAW_MEAT_TIME_LIMIT?this.becomeRotten():this.props.isStale&&this.timePassed>Z.STALE_MEAT_TIME_LIMIT&&Ge(this)}updateRealPosition(){return this.realPosition={x:this.sprite.x,y:this.sprite.y},this.realPosition}setChoosable(t){this.updateRealPosition(),this.pot=t,this.onClick=()=>this.setChosen(),this.setJumping(!0),this.setInteractive(!0)}setNotChoosable(){this.setJumping(!1),this.onClick=void 0}setChosen(){if(!this.pot)throw Error("cant choose food without pot");this.setJumping(!1),this.location===P.STORAGE&&s.lair.foodStorage.container.remove(this.sprite),s.layers.add(this.sprite,I.FIELD_BUTTONS);const t=this.pot.getFreePlaceForChosenFood();this.sprite.move(t.x,t.y),this.pot.choseThisFood(this),this.onClick=()=>this.unchoose(),this.updateEmitters()}unchoose(){if(!this.pot)throw Error("cant un-choose food without pot");this.pot.removeChosen(this),this.location===P.STORAGE&&s.lair.foodStorage.container.add(this.sprite),this.sprite.move(this.realPosition.x,this.realPosition.y),this.onClick=()=>this.setChosen(),this.setJumping(!0),s.layers.add(this.sprite,I.FIELD_OBJECTS),this.updateEmitters()}onLastAnimation(){this.setJumping(!1),this.setInteractive(!1),s.layers.add(this.sprite,I.FIELD_BUTTONS)}setInteractive(t){this.sprite.setInteractive(t,{cursor:"pointer"})}updateInteractive(){this.setInteractive(!s.battle.isBattle&&!s.negotiations.getIsNegotiationsInProgress())}setLocation(t){this.location=t}flyTo(t,e=1e3,i=500){return this.rottenGas.active&&this.rottenGas.pause(),this.location===P.STORAGE&&this.sprite.obj.parentContainer===s.lair.foodStorage.container.obj&&(s.lair.foodStorage.container.remove(this.sprite),this.sprite.x+=s.lair.foodStorage.container.x,this.sprite.y+=s.lair.foodStorage.container.y),s.render.flyTo(this.sprite,t,e,i).then(()=>{this.updateEmitters(),this.props.isStale&&!this.rottenGas.active&&this.rottenGas.resume()})}throwTo(t){this.setInteractive(!1),s.render.thrownTo(this.sprite,t,700).then(()=>this.updateInteractive())}destroy(){this.deregister(),this.destroyed=!0,this.rottenGas.remove(),this.subs.clear(),this.sprite.destroy(),s.lair.foodStorage.updateFood()}}lt((u=1)=>{for(let t=0;t<u;t++){const e=B(200,250),i=B(200,250);new se({x:e,y:i},P.GROUND,!0,hu(Zt.HUMAN_LEG,Zt.HUMAN_HAND))}},"spawnHumanMeat");lt((u=1)=>{for(let t=0;t<u;t++){const e=B(200,250),i=B(200,250);new se({x:e,y:i},P.GROUND,!1)}},"spawnMeat");const Et=60,dt=-70,mt=25;class zu{constructor(t){r(this,"position",{x:0,y:0});r(this,"sprite");r(this,"container");r(this,"subscriptions",pt());r(this,"upgraded",!1);r(this,"places",[[{x:Et,y:dt},null],[{x:Et+mt,y:dt},null],[{x:Et+mt*2,y:dt},null],[{x:Et+mt*3,y:dt},null]]);this.position=t,this.container=s.render.createContainer(t.x,t.y),s.layers.add(this.container,I.FIELD_OBJECTS),this.sprite=s.render.createSprite("drying_rack",0,0,{parent:this.container}),this.sprite.setOrigin(0,1),this.upgraded?this.upgrade():s.upgrade.createUpgradeButton({x:this.container.x+this.sprite.width+30,y:this.container.y-this.sprite.height/2},"\u0432\u0442\u043E\u0440\u0430\u044F \u0441\u0443\u0448\u0438\u043B\u043A\u0430 \u0434\u043B\u044F \u043C\u044F\u0441\u0430",st.costs.drying_rack,()=>this.upgrade())}upgrade(){if(this.upgraded)return;s.render.createSprite("drying_rack",this.sprite.width-30,0,{parent:this.container}).setOrigin(0,1),this.places=this.places.concat([[{x:Et+mt*6,y:dt},null],[{x:Et+mt*7,y:dt},null],[{x:Et+mt*8,y:dt},null],[{x:Et+mt*9,y:dt},null]])}placeFood(t){const e=this.getNextPlace();if(!e)return;const i=e[0];s.audio.playSound(E.PICK),e[1]=t,t.setLocation(P.STORAGE),t.flyTo({x:this.container.x+i.x,y:this.container.y+i.y}).then(()=>{this.container.add(t.sprite),t.sprite.move(i.x,i.y),t.updateRealPosition(),s.audio.playSound(E.PICK_BIG)})}hasFreeSpace(){return!!this.getNextPlace()}getNextPlace(){return console.log("getNextPlace",this.places.findIndex(t=>t[1]===null),this.places.map(t=>t[1])),this.places.find(t=>t[1]===null)}destroy(){this.subscriptions.clear()}updateFood(){this.places.forEach(t=>{var e,i;(((e=t[1])==null?void 0:e.destroyed)===!0||((i=t[1])==null?void 0:i.location)!==P.STORAGE)&&(t[1]=null)})}setEnabled(t){this.places.forEach(e=>{var i;return(i=e[1])==null?void 0:i.setInteractive(t)})}}class Ju{constructor(t){r(this,"sprite");r(this,"upgraded",!1);const e=this.upgraded?"bed_upgraded":"bed";this.sprite=s.render.createSprite(e,t.x,t.y),this.sprite.setInteractive(!0,{cursor:"pointer"}),this.sprite.setWidth(100),this.sprite.onClick(()=>this.onClick()),s.upgrade.createUpgradeButton({x:this.sprite.x,y:this.sprite.y},"\u043A\u0440\u043E\u0432\u0430\u0442\u044C",50,()=>this.upgrade())}upgrade(){this.sprite.setTexture("bed_upgraded"),this.upgraded=!0}setEnabled(t){this.sprite.setInteractive(t)}onClick(){s.troll.goToBed()}}var M;(function(u){u.NOT_EXIST="NOT_EXIST",u.EMPTY="EMPTY",u.PREPARING="PREPARING",u.READY="READY"})(M||(M={}));class Qu{constructor(t){r(this,"text");r(this,"sprite");r(this,"dishSprite");r(this,"state",M.EMPTY);r(this,"subs",pt());r(this,"isDishStale",!1);r(this,"isDishHuman",!1);r(this,"timePassed",0);r(this,"rottenGas");r(this,"textShowTimeout");r(this,"isChoosingFood",!1);r(this,"unsubFromRightClick",et);r(this,"chosenFood",[]);this.sprite=s.render.createAnimatedSprite({atlasKey:"pot",x:t.x,y:t.y,animations:[{framesPrefix:"empty",repeat:-1,frameRate:6},{framesPrefix:"full",repeat:-1,frameRate:6}]}),this.sprite.setOrigin(.5,1),s.layers.add(this.sprite,I.FIELD_OBJECTS),this.sprite.setInteractive(!0,{cursor:"pointer"}),this.sprite.onClick(()=>this.onClick()),this.sprite.onPointerOver(()=>this.onPointerOver()),this.sprite.onPointerOut(()=>this.onPointerOut()),this.dishSprite=s.render.createSprite("dish",t.x,t.y-50),s.layers.add(this.dishSprite,I.FIELD_BUTTONS),this.text=s.render.createText("\u041D\u0430 \u0431\u043B\u044E\u0434\u043E \u043D\u0443\u0436\u043D\u043E 3 \u0435\u0434\u0438\u043D\u0438\u0446\u044B \u043C\u044F\u0441\u0430",this.sprite.x,this.sprite.y-60,{color:R.WHITE}),this.text.setOrigin(.5,1),this.text.setVisibility(!1),s.layers.add(this.text,I.FIELD_OBJECTS),this.rottenGas=s.render.createGreenSmokeEmitter(),this.updateEmitters(),this.setState(M.NOT_EXIST),s.upgrade.createUpgradeButton({x:this.sprite.x,y:this.sprite.y},"\u041A\u043E\u0442\u0435\u043B",50,()=>this.upgrade()),this.subs.on(g.TIME_PASSED,()=>this.onTimePassed())}upgrade(){this.setState(M.EMPTY)}updateEmitters(){this.rottenGas.setPosition({min:this.sprite.obj.x-10,max:this.sprite.x+10},{min:this.sprite.y-60,max:this.sprite.y-40})}onTimePassed(){if(this.state===M.READY){if(this.timePassed++,!this.isDishStale&&this.timePassed>Z.RAW_MEAT_TIME_LIMIT)this.becomeRotten();else if(this.isDishStale&&this.timePassed>Z.STALE_MEAT_TIME_LIMIT){this.timePassed=0,this.setState(M.EMPTY);return}}else this.timePassed=0;this.state===M.PREPARING&&this.setState(M.READY)}showText(){this.text.setVisibility(!0),clearTimeout(this.textShowTimeout),this.textShowTimeout=setTimeout(()=>this.text.setVisibility(!1),3e3)}onPointerOver(){}onPointerOut(){}becomeRotten(){this.isDishStale=!0,this.timePassed=0,this.rottenGas.active=!0,this.rottenGas.setVisible(!0),this.dishSprite.obj.setTint(y.ROTTEN)}becomeFresh(){this.isDishStale=!1,this.timePassed=0,this.rottenGas.active=!1,this.rottenGas.setVisible(!1),this.dishSprite.obj.clearTint()}setState(t){switch(this.state=t,t){case M.NOT_EXIST:this.sprite.setVisibility(!1),this.dishSprite.setVisibility(!1);break;case M.EMPTY:this.sprite.setVisibility(!0),this.sprite.play("empty"),this.dishSprite.setVisibility(!1),this.becomeFresh(),this.isDishHuman=!1;break;case M.PREPARING:this.sprite.play("full"),this.dishSprite.setVisibility(!1),this.setInteractive(!1);break;case M.READY:s.render.burstYellow(this.sprite.x,this.sprite.y),this.sprite.play("empty"),this.dishSprite.setVisibility(!0),this.setInteractive(!0);break;default:throw Error("wrong pot state "+t)}}eat(){console.log(this.isDishHuman),s.troll.eat(Tt.DISH,this.isDishStale,this.isDishHuman),this.setState(M.EMPTY)}getFreePlaceForChosenFood(){return{x:this.sprite.x-30+30*this.chosenFood.length,y:this.sprite.y-70}}startChoosingFood(){const t=s.entities.get(G.MEAT);if(t.length<Z.FOOD_FOR_DISH){s.audio.playSound(E.CANCEL),this.showText();return}s.audio.playSound(E.BONK),this.isChoosingFood=!0,s.lair.mayBeMovedInto(!1),s.lair.mayButtonsBeClicked(!1),this.setInteractive(!0),s.bridge.disableInterface(),t.forEach(e=>{e.setChoosable(this)}),this.unsubFromRightClick=s.interaction.onRightClick(()=>{this.stopChoosingFood()})}choseThisFood(t){if(s.audio.playSound(E.PICK),this.chosenFood.push(t),this.chosenFood.length===Z.FOOD_FOR_DISH){const e=[...this.chosenFood];e.forEach(i=>i.updateRealPosition()),this.stopChoosingFood(),this.prepare(e)}}prepare(t){this.setInteractive(!1);const e=[];s.audio.playSound(E.COLLECT),t.forEach(i=>{i.props.isStale&&this.becomeRotten(),i.props.isHuman&&(this.isDishHuman=!0),i.onLastAnimation();const a={x:this.sprite.x,y:this.sprite.y-30};e.push(i.flyTo(a,50,500).then(()=>i.destroy()))}),Promise.all(e).then(()=>{s.audio.playSound(E.BUBBLE),this.setState(M.PREPARING)})}stopChoosingFood(){s.audio.playSound(E.CANCEL),this.unsubFromRightClick(),s.lair.updateMayBeMovedInto(),s.lair.mayButtonsBeClicked(!0),s.bridge.updateMayBeMovedInto(),s.entities.get(G.MEAT).forEach(t=>{t.setNotChoosable()}),this.isChoosingFood=!1,this.chosenFood=[]}removeChosen(t){s.audio.playSound(E.CANCEL),ge(this.chosenFood,t)}setInteractive(t){this.sprite.setInteractive(t)}interruptChoosing(){[...this.chosenFood].forEach(t=>t.unchoose()),this.stopChoosingFood()}onClick(){switch(this.state){case M.EMPTY:this.isChoosingFood?this.interruptChoosing():this.startChoosingFood();break;case M.PREPARING:break;case M.READY:this.eat();break}}}var it;(function(u){u.GROUND="GROUND",u.TREASURY="TREASURY"})(it||(it={}));class je extends _e{constructor(t,e,i=it.GROUND){super();r(this,"type",G.GOLD);r(this,"id");r(this,"location");r(this,"sprite");r(this,"subs",pt());r(this,"props",{amount:0});this.id=this.register(),this.props.amount=e,this.location=i,this.sprite=s.render.createSprite(this.getSpriteKey(),t.x,t.y),this.sprite.setOrigin(0,.5),this.sprite.setWidth(32),this.updateLayer(),i===it.GROUND&&(this.sprite.setInteractive(!0,{cursor:"pointer"}),this.sprite.onClick(()=>this.onClick())),this.subs.on(g.TIME_PASSED,()=>this.onTimePassed()),this.updateInteractive()}onClick(){s.lair.treasury.gatherGold([this])}flyToStorage(){switch(this.location){case it.GROUND:s.audio.playSound(E.PICK_THIN),this.sprite.setInteractive(!1);const t=s.lair.treasury.gold[s.lair.treasury.gold.length-1],e=t&&t.props.amount<st.MAX_GOLD_IN_SPRITE?t.sprite:s.lair.treasury.getNextPosition();return s.render.flyTo(this.sprite,e,500,300).then(()=>{this.destroy()});case it.TREASURY:return Promise.resolve()}}flyTo(t){return this.sprite.setInteractive(!1),s.render.flyTo(this.sprite,t,500,300)}updateSprite(){this.sprite.setTexture(this.getSpriteKey())}updateLayer(){this.props.amount<20?s.layers.add(this.sprite,I.FIELD_OBJECTS):s.layers.add(this.sprite,I.FIELD_OBJECTS)}getSpriteKey(){if(this.props.amount===1)return"gold-1";if(this.props.amount===2)return"gold-2";if(this.props.amount===3)return"gold-3";if(this.props.amount<10)return"gold-4-9";if(this.props.amount<20)return"gold-some";if(this.props.amount<50)return"gold-many";if(this.props.amount<st.MAX_GOLD_IN_SPRITE)return"gold-almost";if(this.props.amount===st.MAX_GOLD_IN_SPRITE)return"gold-chest";throw Error("wrong amount of gold "+this.props.amount)}onTimePassed(){}destroy(){this.deregister(),this.subs.clear(),this.sprite.destroy()}setAmount(t){this.props.amount=t,this.updateSprite(),this.updateLayer()}setInteractive(t){this.sprite.setInteractive(t)}updateInteractive(){this.setInteractive(this.location===it.GROUND&&!s.battle.isBattle&&!s.negotiations.getIsNegotiationsInProgress())}throwTo(t){this.setInteractive(!1),s.render.thrownTo(this.sprite,t,700).then(()=>this.updateInteractive())}}class Zu{constructor(t){r(this,"text");r(this,"sprite");r(this,"subs",pt());r(this,"amount",0);r(this,"gold",[]);r(this,"textShowTimeout");r(this,"numbersQueue",[]);r(this,"timer");this.sprite=s.render.createSprite("treasury",t.x,t.y),this.sprite.setOrigin(0,.5),this.sprite.setInteractive(!0),this.sprite.onPointerOver(()=>this.onPointerOver()),this.sprite.onPointerOut(()=>this.onPointerOut()),this.text=s.render.createText("\u0417\u043E\u043B\u043E\u0442\u043E: 0",this.sprite.x+50,this.sprite.y-40,{color:R.WHITE}),this.text.setOrigin(.5,1),this.text.setVisibility(!1),s.layers.add(this.text,I.FIELD_BUTTONS),this.subs.on(g.TIME_PASSED,()=>this.onTimePassed()),lt(e=>this.addGold(e),"addGold")}onTimePassed(){}showText(){this.text.setVisibility(!0)}hideText(){this.text.setVisibility(!1),clearTimeout(this.textShowTimeout)}onPointerOver(){this.showText()}onPointerOut(){this.hideText()}setState(){}setInteractive(t){this.sprite.setInteractive(t)}onClick(){this.addGold(10)}onGoldChanged(){this.amount=this.gold.reduce((t,e)=>t+e.props.amount,0),this.text.setText("\u0417\u043E\u043B\u043E\u0442\u043E: "+this.amount)}async gatherGold(t){let e=0;await Promise.all(t.map(i=>(e+=i.props.amount,i.flyToStorage()))),this.addGold(e)}getNextPosition(){var i;const t={x:this.sprite.x,y:this.sprite.y},e=(i=this.gold[this.gold.length-1])==null?void 0:i.sprite;return e&&(t.x=e.x+32+10),t}addGold(t){s.audio.playSound(E.PICK_BIG),this.flyingNumbers("+ "+t+" gold");const e=this.gold[this.gold.length-1];if(e&&e.props.amount<st.MAX_GOLD_IN_SPRITE){const i=Math.min(t,st.MAX_GOLD_IN_SPRITE-e.props.amount);e.setAmount(e.props.amount+i),t-=i}for(;t>0;){const i=Math.min(t,st.MAX_GOLD_IN_SPRITE);this.gold.push(new je(this.getNextPosition(),i,it.TREASURY)),t-=i}this.onGoldChanged()}flyingNumbers(t){this.numbersQueue.push(t),!this.timer&&this.nextNumbers()}nextNumbers(){const t=this.numbersQueue.shift();if(!t){this.timer=null;return}let e=this.sprite.x,i=this.sprite.y-20;zt(t,e,i,R.YELLOW),this.timer=setTimeout(()=>{this.nextNumbers()},300)}removeGold(t){for(zt("- "+t+" gold",this.sprite.x,this.sprite.y-20,R.RED);t>0;){if(this.gold.length===0){console.error("cant spend more gold that treasure has");break}const e=this.gold[this.gold.length-1],i=Math.min(t,e.props.amount);i===e.props.amount?(e.destroy(),this.gold.pop()):e.setAmount(e.props.amount-i),t-=i}this.onGoldChanged()}}const rt=64,ie=20,re=.5,t4=.75,e4=1,u4=.33,xt=ie,s4=xt*2+rt;class ae{constructor(t,e,i){r(this,"container");r(this,"selectedKey",null);r(this,"buttons",{});r(this,"containerX");this.templates=t,this.onClick=i;const a=this.getMenuHeight(),o=e.y-a/2;this.containerX=e.x-rt,this.container=s.render.createContainer(this.containerX,o),s.layers.add(this.container,I.FIELD_BUTTONS);const c=s.render.createSprite("tile_black",0,0,{width:s4,height:a,parent:this.container});c.alpha=.7,c.setOrigin(0,0),t.forEach((f,D)=>{const _=f.key,z=xt,gt=xt+D*(ie+rt),J=s.render.createSprite(f.resource,z,gt,{width:rt,height:rt,parent:this.container});J.setInteractive(!0,{cursor:"pointer"}),J.onPointerOver(()=>{this.selectedKey!==_&&(J.alpha=t4,nt.setVisibility(!0))}),J.onPointerOut(()=>{this.selectedKey!==_&&(J.alpha=re,nt.setVisibility(!1))}),J.onClick(()=>i(f.key)),J.setOrigin(0,0),J.alpha=re;const nt=s.render.createText(f.getText?f.getText():f.text,z-20,gt+rt/2,{color:R.WHITE},{parent:this.container});nt.setOrigin(1,.5),nt.setVisibility(!1);const he=s.render.createText("",z+rt/2,gt+rt/2,{color:R.WHITE,wordWrap:{width:rt*2},align:"center"},{parent:this.container});he.setOrigin(.5,.5),he.setVisibility(!1),this.buttons[f.key]={sprite:J,text:nt,key:_,disabledText:he,getDisabledAndReason:f.getDisabledAndReason||(()=>!1)}}),this.hide(!1)}getMenuHeight(){return this.templates.length*(rt+ie)-ie+xt*2}updateButtons(){Object.values(this.buttons).forEach(t=>{const e=t.getDisabledAndReason();e?this.disableButton(t.key,e):this.enableButton(t.key)})}deactivateAllButtons(){Object.values(this.buttons).forEach(t=>{t.sprite.setInteractive(!1)})}disableButton(t,e){this.deselectButton(t);const i=this.buttons[t],a=i.sprite;a.alpha=u4,a.setInteractive(!1),i.disabledText.setText(e),i.disabledText.setVisibility(!0)}enableButton(t){const e=this.buttons[t],i=e.sprite;i.alpha=re,i.setInteractive(!0),e.disabledText.setText(""),e.disabledText.setVisibility(!1)}deselectButton(t){const e=this.buttons[t],i=e.sprite;i.alpha=re,i.setInteractive(!0),s.render.flyTo(i,{x:xt,y:i.y},500),e.text.setVisibility(!1)}selectButton(t){if(this.selectedKey&&this.deselectButton(this.selectedKey),this.selectedKey=t,t){const e=this.buttons[t],i=e.sprite;i.alpha=e4,i.setInteractive(!1),s.game.getScene().input.setDefaultCursor("default"),s.render.flyTo(i,{x:xt+30,y:i.y},500),e.text.setVisibility(!0)}}show(t=!0){this.container.setVisibility(!0),t&&(this.container.x=this.container.x-50,s.render.fadeIn(this.container,200),this.container.x=this.containerX-50,s.render.flyTo(this.container,{x:this.containerX,y:this.container.y},200))}hide(t=!0){if(t){const e=F();return s.render.fadeOut(this.container,250).then(()=>{this.container.setVisibility(!1),this.container.x=this.containerX,this.selectButton(null),e.done()}),s.render.flyTo(this.container,{x:this.containerX+50,y:this.container.y},200),e.promise}else return this.container.setVisibility(!1),this.selectButton(null),Promise.resolve()}destroy(){this.container.destroy()}}var Ct;(function(u){u.WAIT="WAIT",u.UPGRADE="UPGRADE"})(Ct||(Ct={}));class i4{constructor(){r(this,"verticalMenu");const t=x.getLairPosition(),e=t.y+t.height/2,i=t.x-100;this.verticalMenu=new ae([{key:Ct.WAIT,text:"\u0416\u0434\u0430\u0442\u044C",resource:"button_wait"},{key:Ct.UPGRADE,text:"\u0421\u0442\u0440\u043E\u0438\u0442\u044C",resource:"button_upgrade"}],{x:i,y:e},a=>this.onClick(a))}onClick(t){switch(t){case Ct.WAIT:s.upgrade.hideButtons(),s.time.wait();break;case Ct.UPGRADE:s.upgrade.showButtons();break}}deselectUpgradeMenu(){this.verticalMenu.deselectButton(Ct.UPGRADE)}show(){this.verticalMenu.show(!1)}hide(){this.verticalMenu.hide(!1),s.characters.getSquadChars().forEach(t=>t.sprite.removeClickListener())}}class r4{constructor(){r(this,"foodStorage");r(this,"bed");r(this,"pot");r(this,"treasury");r(this,"sprite");r(this,"menu");s.register.lair(this);const t=x.getLairPosition();this.sprite=s.render.createTiles("grass",t.x,t.y,t.width,t.height),this.sprite.setOrigin(0,0),this.sprite.onClick(()=>s.troll.goToLair()),this.treasury=new Zu(x.getTreasuryPosition()),this.foodStorage=new zu(x.getFoodStoragePosition()),this.bed=new Ju(x.getBedPosition()),this.pot=new Qu(x.getPotPosition()),this.menu=new i4}updateMayBeMovedInto(){s.troll.location!==v.LAIR&&this.mayBeMovedInto(!0)}mayBeMovedInto(t){t?this.sprite.setInteractive(!0,{cursor:"pointer"}):this.sprite.setInteractive(!1)}mayButtonsBeClicked(t){this.bed.setEnabled(t),this.foodStorage.setEnabled(t),this.pot.setInteractive(t)}changeResource(t,e){T.emit(g.RESOURSES_CHANGED)}feedChar(t){this.changeResource(ft.FOOD,-1),s.characters.feedChar(t)}}const yt={[l.FARMER]:{name:"chars.peasant",hp:10,morale:20,moralePrice:[5,15],dmg:[1,2],resources:{gold:[1,5],food:[1,1]},isCombatant:!0,atlasKey:"peasant",isDefender:!1,isRanged:!1},[l.MILITIA]:{name:"chars.militia",hp:15,morale:40,moralePrice:[10,25],dmg:[1,4],resources:{gold:[5,10],food:[1,2]},isCombatant:!0,atlasKey:"pikeman",counterAttack:.75,isDefender:!1,isRanged:!1},[l.ARCHER]:{name:"chars.archer",hp:15,morale:30,moralePrice:[10,25],dmg:[5,8],resources:{gold:[5,10],food:[1,3]},isCombatant:!0,atlasKey:"archer",isDefender:!1,isRanged:!0},[l.SHIELDMAN]:{name:"chars.shieldman",hp:20,morale:100,moralePrice:[20,35],dmg:[4,6],block:.5,resources:{gold:[20,40],food:[1,3]},isCombatant:!0,atlasKey:"shieldman",isDefender:!0,isRanged:!1},[l.KNIGHT]:{name:"chars.knight",hp:50,morale:300,moralePrice:[50,200],dmg:[10,15],counterAttack:.5,block:.25,evade:.75,resources:{gold:[50,100],food:[3,6]},isCombatant:!0,atlasKey:"knight",isMounted:!0},[l.VIGILANTE]:{name:"chars.vigilante",hp:70,morale:300,moralePrice:[100,200],dmg:[10,15],counterAttack:.5,block:.25,evade:.75,resources:{gold:[100,200],food:[3,6]},isCombatant:!0,atlasKey:"knight",isMounted:!0},[l.KING]:{name:"chars.final_boss",hp:70,morale:300,moralePrice:[100,200],dmg:[10,15],counterAttack:.5,block:.25,evade:.75,resources:{gold:[500,600],food:[5,6]},isCombatant:!0,atlasKey:"knight",isMounted:!0}};class q{constructor(t){r(this,"char");r(this,"onEndPromise");r(this,"onEndCallback");r(this,"subs",pt());this.char=t;const{promise:e,done:i}=F();this.onEndPromise=e,this.onEndCallback=i}start(){return this.onStart(),this.onEndPromise}onStart(){}end(){this.subs.clear(),this.onEnd(),this.onEndCallback()}onEnd(){}update(t){}}class a4 extends q{constructor(){super(...arguments);r(this,"key",A.IDLE)}onStart(){this.char.setAnimation(d.IDLE),this.char.stop()}}class o4 extends q{constructor(){super(...arguments);r(this,"key",A.GO_ACROSS);r(this,"target",{x:0,y:this.char.getCoords().y})}onStart(){this.char.isDeMounted?this.char.acquireHorse().then(()=>this.startWalking()):this.startWalking()}startWalking(){this.char.setAnimation(d.WALK),this.char.moveTowards(this.target.x,this.target.y),this.char.directToTarget(this.target)}update(t){j(this.char.container,{x:0,y:this.char.getCoords().y})<10&&T.emit(g.CHAR_LEFT_BRIDGE,this.char.id)}}class n4 extends q{constructor(t,e){super(t);r(this,"key",A.SURRENDER);r(this,"p",null);r(this,"goBack");r(this,"showNotification");this.goBack=(e==null?void 0:e.goBack)||!1,this.showNotification=(e==null?void 0:e.showNotification)||!1}onStart(){this.char.isSurrender=!0,this.char.isFleeing=!0,this.char.speed=It.CHAR_VERY_FAST,this.char.setIndicatorsVisible(!1),this.showNotification&&this.char.statusNotifications.showSurrender(),this.p=this.char.goToSurrenderPosition(),this.p.promise.then(()=>{this.p=null,this.char.directToTarget(s.troll),this.char.setAnimation(d.SURRENDER)})}onEnd(){this.p&&this.p.stop()}}class h4 extends q{constructor(){super(...arguments);r(this,"key",A.DEAD);r(this,"rotTime",0)}rot(){this.rotTime++,this.rotTime>=3&&this.char.toBones()}onStart(){this.subs.on(g.TIME_PASSED,()=>this.rot()),this.char.isAlive=!1,this.char.setAnimation(d.DEAD)}}class l4 extends q{constructor(){super(...arguments);r(this,"key",A.BONES);r(this,"collapseTime",0);r(this,"unsub",-1)}collapse(){this.collapseTime++,this.collapseTime>=3&&(s.characters.removeChar(this.char.id),T.unsubscribe(g.TIME_PASSED,this.unsub))}onStart(){this.unsub=T.on(g.TIME_PASSED,()=>this.collapse()),this.char.isBones=!0,this.char.isAlive=!1,this.char.sprite.setVisibility(!1),this.char.bones.setVisibility(!0),this.char.disableInteractivity(),this.char.setIndicatorsVisible(!1)}onEnd(){T.unsubscribe(g.TIME_PASSED,this.unsub)}}class c4{constructor(t){r(this,"text");r(this,"timeout",null);this.container=t,this.text=s.render.createText("",-150,-50,{align:"center",color:R.WHITE,fontStyle:"italic",fontSize:"18px",wordWrap:{width:300}},{parent:t}),this.text.setOrigin(.5,1)}clearTimeout(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}showText(t,e){this.text.setText(t),e&&(this.clearTimeout(),this.timeout=window.setTimeout(()=>this.hideText(),e))}hideText(){this.text.setText("")}destroy(){this.clearTimeout()}}class E4 extends q{constructor(){super(...arguments);r(this,"key",A.GO_TO_TALK);r(this,"target",this.char.getBattleCoords())}onEnd(){this.char.onMoveEnd()}onStart(){this.char.speed=It.CHAR_VERY_FAST,this.char.setAnimation(d.WALK),this.char.moveTowards(this.target.x,this.target.y),this.char.directToTarget(this.target);const t=F();this.char.movePromise=t.promise,this.char.onMoveEnd=t.done}update(t){const e=this.char.speed/1e3*t;j(this.char.container,this.target)<=e&&(this.char.stop(),this.char.container.x=this.target.x,this.char.container.y=this.target.y,this.char.directToTarget(s.troll.container),this.char.readyToTalk())}}class d4 extends q{constructor(){super(...arguments);r(this,"key",A.BATTLE_IDLE)}onStart(){this.char.setAnimation(d.IDLE),this.char.hpIndicator.show(),this.char.mpIndicator.show()}}class g4 extends q{constructor(t,e){super(t);r(this,"key",A.BATTLE_ATTACK);r(this,"phase","forward");r(this,"beforeAttack",0);this.beforeAttack=e?e.beforeAttack:0}onStart(){this.char.moveTowards(s.troll.x,s.troll.y),this.char.setAnimation(d.WALK)}update(t){if(this.phase==="attacking")return;const e=this.char.getBattleCoords();if(this.phase==="forward")j(this.char.container,{x:s.troll.x,y:s.troll.y})<=100&&(this.char.stop(),this.phase="attacking",this.char.setAnimation(d.STRIKE,!1,()=>{this.attack(),this.phase="backward",this.char.moveTowards(e.x,e.y),this.char.setAnimation(d.WALK)}));else if(this.phase==="backward"){const i=this.char.speed/1e3*t;j(this.char.container,e)<=i&&(this.char.container.x=e.x,this.char.container.y=e.y,this.char.stop(),this.char.endAttack())}}attack(){s.troll.getHit(this.char.rollDmg())}}class p4{constructor(t){r(this,"bar");this.char=t,this.bar=new _t({x:-15,y:-110,width:50,height:5,maxValue:t.maxMorale,value:t.morale,color:y.LIGHT_BLUE,colorOptions:[[1,y.LIGHT_BLUE]],parent:t.container,withoutNumbers:!0}),this.hide()}update(){this.bar.setValue(this.char.morale)}show(){this.bar.setValue(this.char.morale),this.bar.setVisibility(!0)}hide(){this.bar.setVisibility(!1)}}class T4 extends q{constructor(t,e){super(t);r(this,"key",A.BATTLE_GO_DEFEND);r(this,"charToDefend");r(this,"target");this.charToDefend=e.target,this.target=this.charToDefend.getDefenderPosition();const{promise:i,done:a}=F();this.char.movePromise=i,this.char.onMoveEnd=a}onStart(){this.char.moveTowards(this.target.x,this.target.y),this.char.setAnimation(d.WALK)}onEnd(){this.char.onMoveEnd()}update(t){j(this.char.container,this.target)<=10&&(this.char.stop(),this.char.setState(A.IDLE))}}class A4 extends q{constructor(t){super(t);r(this,"key",A.GO_TO_BATTLE_POSITION);r(this,"target");this.target=t.getBattleCoords()}onEnd(){this.char.onMoveEnd()}onStart(){this.char.speed=It.CHAR_VERY_FAST,this.char.setAnimation(d.WALK),this.char.moveTowards(this.target.x,this.target.y);const t=F();this.char.movePromise=t.promise,this.char.onMoveEnd=t.done,this.char.directToTarget(this.target)}update(t){const e=this.char.speed/1e3*t;j(this.char.container,this.target)<=e&&(this.char.stop(),this.char.container.x=this.target.x,this.char.container.y=this.target.y,this.char.directToTarget(s.troll.container),this.char.setState(s.battle.isBattle?A.BATTLE_IDLE:A.IDLE))}}class f4 extends q{constructor(t,e){super(t);r(this,"key",A.GO_TO);r(this,"target");r(this,"speed");r(this,"directToTarget",!1);r(this,"maxDistance");this.directToTarget=e.directToTarget||!1,this.target=e.target,this.speed=e.speed||It.CHAR_VERY_FAST,this.maxDistance=e.maxDistance||null}onStart(){this.char.speed=this.speed,this.char.setAnimation(d.WALK),this.directToTarget&&this.char.directToTarget(this.target),this.char.moveTowards(this.target.x,this.target.y)}update(t){const e=this.char.speed/1e3*t,i=j(this.char.container,this.target);this.char.moveTowards(this.target.x,this.target.y),(i<=e||this.maxDistance&&i<=this.maxDistance)&&(this.char.stop(),this.maxDistance||(this.char.container.x=this.target.x,this.char.container.y=this.target.y),this.char.setState(A.IDLE))}}class We{constructor(t,e){r(this,"sprite");const i=s.render.createAnimatedSprite({atlasKey:"horse",animations:[{framesPrefix:d.WALK,repeat:-1,frameRate:8}],x:t,y:e});i.setOrigin(.5,1),i.addPhysics(),this.sprite=i}runAway(){this.sprite.play(d.WALK),this.runTo({x:s.bridge.pos.x+s.bridge.pos.width,y:this.sprite.y}).then(()=>this.sprite.destroy())}runToChar(t){return this.runTo({x:t.container.x,y:t.container.y}).then(()=>{this.sprite.destroy()})}runTo(t){return this.sprite.play(d.WALK),s.render.directToTarget(this.sprite,t),s.render.moveTo(this.sprite,t,It.horse.speed).promise}}const _4={runHeDoesNotSee:"\u0411\u0435\u0436\u0430\u0442\u044C, \u043F\u043E\u043A\u0430 \u043E\u043D \u043D\u0435 \u0432\u0438\u0434\u0438\u0442!"};class m4 extends q{constructor(t,e){super(t);r(this,"key",A.UNCONSCIOUS);r(this,"options");r(this,"turnsLeft");this.options=e,this.turnsLeft=this.options.duration,this.subs.on(g.BATTLE_WON,()=>this.char.surrender(!1))}onStart(){this.char.hp===0&&this.char.setIndicatorsVisible(!1),this.char.isUnconscious=!0,this.subs.on(g.BATTLE_TRAVELLERS_TURN_END,()=>this.onTurn()),this.subs.on(g.TROLL_LOCATION_CHANGED,t=>{t!==v.BRIDGE&&this.onTrollLeft()}),this.options.withAnimation?this.char.runAnimationOnce(d.FALL).then(()=>this.char.setAnimation(d.UNCONSCIOUS)):this.char.setAnimation(d.UNCONSCIOUS),s.battle.isBattle&&this.char.hp===0&&T.emit(g.CHAR_DEFEATED,this.char.key)}onEnd(){this.char.isUnconscious=!1}onTurn(){this.turnsLeft--,this.turnsLeft<=0&&this.wakeUp()}onTrollLeft(){this.char.say(_4.runHeDoesNotSee),this.char.setState(A.GO_ACROSS)}wakeUp(){s.battle.isBattle?this.char.goToBattlePosition():this.char.setState(A.IDLE)}}var Bt;(function(u){u.COMMON="COMMON",u.VIGILANTE="VIGILANTE",u.KING="KING"})(Bt||(Bt={}));class C4{constructor(t,e,i,a=Bt.COMMON){r(this,"key");r(this,"id");r(this,"hp");r(this,"maxHp");r(this,"morale");r(this,"maxMorale");r(this,"moralePrice");r(this,"name");r(this,"dmg",[1,1]);r(this,"speed",It.CHAR_SPEED);r(this,"food");r(this,"gold");r(this,"isRobbed",!1);r(this,"isReleased",!1);r(this,"isUnconscious",!1);r(this,"isAlive",!0);r(this,"isPrisoner",!1);r(this,"isFleeing",!1);r(this,"isSurrender",!1);r(this,"isBones",!1);r(this,"isMetTroll",!1);r(this,"isCombatant");r(this,"counterAttack",0);r(this,"evasion",0);r(this,"block");r(this,"isDefender");r(this,"isRanged");r(this,"isMounted");r(this,"isDeMounted",!1);r(this,"state");r(this,"timeWithoutFood",0);r(this,"speakText");r(this,"hpIndicator");r(this,"mpIndicator");r(this,"sprite");r(this,"bones");r(this,"container");r(this,"unsub",[]);r(this,"squad",null);r(this,"squadPlace",null);r(this,"statusNotifications");r(this,"behavior");r(this,"attackPromise",new Promise(()=>{}));r(this,"onAttackEnd",()=>{});r(this,"movePromise",new Promise(et));r(this,"onMoveEnd",et);const o=yt[t];this.id=au(t),this.key=t,this.behavior=a,this.hp=o.hp,this.maxHp=o.hp,this.morale=o.morale,this.maxMorale=o.morale,this.moralePrice=o.moralePrice,this.name=o.name,this.isCombatant=o.isCombatant,this.dmg=o.dmg,o.counterAttack&&(this.counterAttack=o.counterAttack),o.evade&&(this.evasion=o.evade),this.block=o.block,this.isDefender=!!o.isDefender,this.isRanged=!!o.isRanged,this.isMounted=!!o.isMounted,this.gold=B(o.resources.gold[0],o.resources.gold[1]),this.food=B(o.resources.food[0],o.resources.food[1]),this.container=s.render.createContainer(e,i),this.container.addPhysics(),this.sprite=this.createSprite(0,0),s.layers.add(this.container,I.FIELD_OBJECTS),this.bones=this.createBones(),this.bones.setVisibility(!1),this.speakText=new c4(this.container),this.hpIndicator=new Ue(this),this.mpIndicator=new p4(this),this.statusNotifications=new He(this.container,0,-130),this.state=this.behavior===Bt.VIGILANTE?this.getState(A.IDLE):this.getState(A.GO_ACROSS),this.state.start();const c=T.on(g.ENCOUNTER_ENDED,()=>{this.setIndicatorsVisible(!1)});this.unsub.push(()=>T.unsubscribe(g.ENCOUNTER_ENDED,c));const f=T.on(g.CHAR_DEFEATED,_=>this.onCharDefeated(_));this.unsub.push(()=>T.unsubscribe(g.CHAR_DEFEATED,f));const D=T.on(g.CHAR_DEVOURED_IN_BATTLE,_=>this.onCharDevoured(_));this.unsub.push(()=>T.unsubscribe(g.CHAR_DEVOURED_IN_BATTLE,D))}getIsNewTraveller(){return!this.isMetTroll}getIsTraveller(){return this.isAlive&&!this.isPrisoner}getIsAbleToFight(){return this.getIsTraveller()&&!this.isSurrender&&!this.isUnconscious}getIsPrisoner(){return this.isAlive&&this.isPrisoner}onCharDefeated(t){this.getIsAbleToFight()&&this.changeMp(-B(yt[t].moralePrice[0],yt[t].moralePrice[1]))}onCharDevoured(t){this.getIsAbleToFight()&&this.changeMp(-B(yt[t].moralePrice[0],yt[t].moralePrice[1]))}destroy(){this.unsub.forEach(t=>t()),this.state.end(),this.speakText.destroy(),this.container.destroy(),this.squad&&this.squad.removeChar(this)}update(t){this.state.update(t)}getState(t,e){switch(t){case A.IDLE:return new a4(this);case A.GO_ACROSS:return new o4(this);case A.SURRENDER:return new n4(this,e);case A.DEAD:return new h4(this);case A.BONES:return new l4(this);case A.GO_TO_TALK:return new E4(this);case A.BATTLE_IDLE:return new d4(this);case A.BATTLE_ATTACK:return new g4(this);case A.BATTLE_GO_DEFEND:return new T4(this,e);case A.GO_TO:return new f4(this,e);case A.GO_TO_BATTLE_POSITION:return new A4(this);case A.UNCONSCIOUS:return new m4(this,e);default:throw Error("wrong state key "+t)}}setState(t,e){return this.state.end(),console.log(this.key,this.state.key,"to",t),this.state=this.getState(t,e),this.state.start()}createSprite(t,e,i=yt[this.key].atlasKey){const a=s.render.createAnimatedSprite({atlasKey:i,animations:[{framesPrefix:d.WALK,repeat:-1,frameRate:8},{framesPrefix:d.IDLE,repeat:-1,frameRate:8},{framesPrefix:d.DEAD,repeat:-1,frameRate:8},{framesPrefix:d.FALL,frameRate:3},{framesPrefix:d.STRIKE,frameRate:8},{framesPrefix:d.DAMAGED,frameRate:8},{framesPrefix:d.BLOCK,frameRate:8},{framesPrefix:d.PRISONER,repeat:-1,frameRate:8},{framesPrefix:d.SURRENDER,repeat:-1,frameRate:8},{framesPrefix:d.UNCONSCIOUS,frameRate:1}],x:t,y:e,parent:this.container});return a.setOrigin(.5,1),this.sprite=a,a}disableInteractivity(){this.container.setInteractive(!1),this.sprite.setInteractive(!1)}enableInteractivity(){this.isBones||(this.container.setInteractive(!0),this.sprite.setInteractive(!0))}onSpriteClicked(t){this.sprite.onClick(()=>t(this))}setCursor(t){this.sprite.obj.input?this.sprite.obj.input.cursor=t:this.sprite.setInteractive(!0,{cursor:t})}onSpritePointerOver(t){this.sprite.onPointerOver(()=>t(this))}onSpritePointerOut(t){this.sprite.onPointerOut(()=>t(this))}createBones(){const t=s.render.createSprite("bones",0,0,{parent:this.container});return t.setOrigin(.5,.5),t}getCoords(){return this.container.getCoords()}changeResources(t,e){switch(t){case ft.GOLD:this.gold=Math.max(this.gold+e,0);break;case ft.FOOD:this.food=Math.max(this.food+e,0);break}}moveTowards(t,e){s.render.moveTowards(this.container,t,e,this.speed)}stop(){this.container.stop()}pay(){const t=Math.ceil(this.gold*.33),e=Math.ceil(this.food*.33);this.dropGold(t,!0),b(300).then(()=>this.dropFood(e,!0))}eat(){this.timeWithoutFood=0}dropAll(){this.dropGold(this.gold),this.dropFood(this.food)}giveAll(){this.dropGold(this.gold,!0),this.dropFood(this.food,!0)}giveGoldPayment(){return this.giveGold(Math.ceil(m.PASS_COST*this.gold))}giveGold(t){this.changeResources(ft.GOLD,-t);const e=[];for(;t;){const i=Math.min(t,st.MAX_GOLD_IN_SPRITE);t-=i,e.push(new je(this.getCoords(),i))}return e}dropGold(t,e){const i=this.giveGold(t);e?s.lair.treasury.gatherGold(i):i.forEach(a=>{let o=this.getCoords();o.x+=B(-40,40),o.y+=B(-40,40),a.throwTo(o)})}payFood(){this.dropFood(Math.ceil(this.food*m.PASS_COST),!0)}dropFood(t,e){for(this.changeResources(ft.FOOD,-t);t;){t--;const i=this.getCoords();i.x+=B(-80,80),i.y+=-this.sprite.height/2+B(-80,80);const a=new se(this.getCoords(),P.GROUND);e?a.bePlacedOrBeEaten():a.throwTo(i)}}dropSelfMeat(t){for(let e=0;e<t;e++){const i=this.getCoords();i.x+=B(-80,80),i.y+=-this.sprite.height/2+B(-80,80),new se(this.getCoords(),P.GROUND,!0,e<2?Zt.HUMAN_LEG:Zt.HUMAN_HAND).throwTo(i)}}takeGold(t){return t.flyTo({x:this.container.x,y:this.container.y-70}).then(()=>{s.audio.playSound(E.PICK),this.gold+=t.props.amount,t.destroy()})}takeMeat(t){return t.flyTo({x:this.container.x,y:this.container.y-70}).then(()=>{s.audio.playSound(E.BONK),this.food+=1,t.destroy()})}setIndicatorsVisible(t){t?(this.hpIndicator.show(),this.mpIndicator.show()):(this.hpIndicator.hide(),this.mpIndicator.hide())}surrender(t){return this.setIndicatorsVisible(!1),this.setState(A.SURRENDER,{goBack:!this.isUnconscious,showNotification:t})}becomeDevoured(){s.battle.isBattle?T.emit(g.CHAR_DEVOURED_IN_BATTLE,this.key):T.emit(g.CHAR_DEVOURED,this.key),s.audio.playSound(E.TORN),s.render.burstBlood(this.container.x,this.container.y),s.render.burstBlood(this.container.x,this.container.y-10),s.render.burstBlood(this.container.x,this.container.y-20),this.dropAll(),this.dropSelfMeat(Z.FOOD_FROM_DEVOURED_CHARACTER),this.toBones()}toBones(){this.setState(A.BONES)}setAnimation(t,e,i){this.sprite.play(t,i&&{onComplete:i})}goToTalk(){return this.setState(A.GO_TO_TALK),this.movePromise}readyToTalk(){this.isMetTroll=!0,this.setState(A.IDLE),T.emit(g.CHAR_READY_TO_TALK,this.id)}makeImprisoned(){}getKilled(){return this.setState(A.DEAD)}goAcrossBridge(){if(this.state.key!==A.GO_ACROSS)return this.setState(A.GO_ACROSS)}release(){this.isReleased=!0,this.goAcrossBridge()}startFighting(){this.isCombatant?this.setState(A.BATTLE_IDLE):this.setState(A.SURRENDER)}speak(t){this.speakText.showText(t,5e3)}clearText(){this.speakText.hideText()}rollDmg(){return B(this.dmg[0],this.dmg[1])}rollCounterAttack(t=0){return ut()<this.counterAttack+t}rollEvade(t=0){return ut()<this.evasion+t}rollBlock(){if(!this.block)return!1;const t=ut();return console.log("roll",t),t<this.block}changeMp(t){this.morale=Dt(this.morale+t,0,this.maxMorale),this.mpIndicator.update(),t<0&&this.statusNotifications.showMoraleDmg(-t,"right"),!this.isSurrender&&this.morale<=0&&this.surrender(!0)}changeHp(t){this.hp=Dt(this.hp+t,0,this.maxHp),this.hpIndicator.update()}tryToBlock(t,e){return!(e==null?void 0:e.grabbed)&&this.getIsAbleToFight()&&this.rollBlock()?(this.runAnimationOnce(d.BLOCK).then(()=>this.setAnimation(d.IDLE)),s.audio.playSound(E.BLOCK),this.statusNotifications.showBlock(),!0):!1}async getHit(t,e){this.tryToBlock(t,e)||(s.audio.playSound(E.HIT),s.render.burstBlood(this.container.x,this.container.y-70),this.changeHp(-t),this.statusNotifications.showDmg(t,"right"),this.hp>0?this.isMounted&&this.checkLooseHorse()?await this.looseHorse():(e==null?void 0:e.stun)?this.setUnconscious(e.stun,!1):this.isUnconscious||(await this.runAnimationOnce(d.DAMAGED),this.setAnimation(d.IDLE)):this.isUnconscious?this.setUnconscious(999,!1):this.setUnconscious(9999))}async looseHorse(){this.isMounted=!1,this.isDeMounted=!0,this.evasion=0,await this.runAnimationOnce(d.FALL),this.sprite.destroy(),this.createSprite(0,0,"shieldman"),this.setAnimation(d.IDLE),this.directToTarget(s.troll),new We(this.container.x,this.container.y).runAway()}async acquireHorse(){this.setAnimation(d.IDLE),await new We(x.bridgePosition().width+200,this.container.y).runToChar(this),this.isDeMounted=!1,this.isMounted=!0,this.sprite.destroy(),this.createSprite(0,0,"knight"),this.setAnimation(d.IDLE)}checkLooseHorse(){return!0}async runAnimationOnce(t){const e=F();return this.setAnimation(t,!1,e.done),e.promise}directToTarget(t){s.render.directToTarget(this.sprite,{x:t.x-this.container.x,y:t.y-this.container.y})}startAttack(t=!1){s.troll.hp>0||t?this.setState(A.BATTLE_ATTACK):this.endAttack()}endAttack(){this.onAttackEnd(),this.setState(A.BATTLE_IDLE)}tornApart(){this.dropAll(),this.dropSelfMeat(Z.FOOD_FROM_CHARACTER),s.characters.removeChar(this.id),T.emit(g.CHAR_TORN_APART,this.key),s.audio.playSound(E.TORN)}async performBattleAction(t=600,e=!1){if(await b(t),this.isRanged){const i=F();this.setAnimation(d.STRIKE,!1,i.done),await i.promise,this.setAnimation(d.IDLE,!1,i.done);const a=s.render.createSprite("arrow",this.container.x,this.container.y-70);s.render.directToTarget(a,s.troll),await s.render.flyTo(a,{x:s.troll.x,y:s.troll.y-50},750),s.troll.getHit(this.rollDmg()),a.destroy()}else this.attackPromise=new Promise(i=>this.onAttackEnd=i),this.startAttack(e),await this.attackPromise}async performFatality(){await this.setState(A.GO_TO,{target:s.troll,directToTarget:!0,maxDistance:70});const t=F();this.setAnimation(d.STRIKE,!1,t.done),await t.promise,s.troll.burstBlood(),s.audio.playSound(E.HIT),this.setAnimation(d.IDLE),await b(500);const e=F();this.setAnimation(d.STRIKE,!1,e.done),await e.promise,s.troll.burstBlood(),s.audio.playSound(E.HIT),this.setAnimation(d.IDLE),await b(500);const i=F();this.setAnimation(d.STRIKE,!1,i.done),await i.promise,s.troll.burstBlood(),s.audio.playSound(E.HIT),this.setAnimation(d.IDLE),await b(1e3),s.troll.getLastHit()}async performCounterAttack(){return this.statusNotifications.showCounterAttack(),this.performBattleAction(300)}async evade(){this.statusNotifications.showEvade();const t=this.speed;this.speed=this.speed*3,await this.setState(A.GO_TO,{target:{x:this.container.x+200,y:this.container.y},speed:this.speed,directToTarget:!0}),this.speed=t}canProtect(t){return this.getIsAbleToFight()&&this.isDefender&&t.id!==this.id&&t.key!==this.key}canCounterAttack(){return!!this.counterAttack&&!this.isUnconscious&&!this.isSurrender&&this.isAlive}getDefenderPosition(){return{x:this.container.x-100,y:this.container.y}}getCoordsToThrowInto(){return{x:this.container.x,y:this.container.y-80}}goDefend(t){return this.setState(A.BATTLE_GO_DEFEND,{target:t})}goToBattlePosition(){return this.setState(A.GO_TO_BATTLE_POSITION)}goToSurrenderPosition(){if(!this.squad||!this.squadPlace)return{promise:Promise.resolve(),stop:et};const t=this.squad.getSurrenderPositionForPlace(this.squadPlace);return this.setAnimation(d.WALK),s.render.moveTo(this.container,t,this.speed)}setUnconscious(t,e=!0){return this.setState(A.UNCONSCIOUS,{duration:t,withAnimation:e})}say(t){zt(t,this.container.x,this.container.y-100)}getBattleCoords(){if(this.squad===null||this.squadPlace===null)throw Error("no squad assigned, cant find battle coords");return this.squad.getBattleCoordsForPlace(this.squadPlace)}getIsCovered(){var t,e,i;if(!this.squad)return!1;if(this.squadPlace===null)throw Error("wtf");switch(this.squadPlace){case 0:return!1;case 1:return!1;case 2:return!1;case 3:return(t=this.squad.placeToChar[0])==null?void 0:t.getIsAbleToFight();case 4:return(e=this.squad.placeToChar[1])==null?void 0:e.getIsAbleToFight();case 5:return(i=this.squad.placeToChar[2])==null?void 0:i.getIsAbleToFight()}}}const Ke={0:[{text:"\u041E\u0434\u0438\u043D\u043E\u043A\u0438\u0439 \u043F\u0443\u0442\u043D\u0438\u043A",enemies:[[1,l.FARMER]]}],1:[{text:"\u0413\u0440\u0443\u043F\u043F\u0430 \u0444\u0435\u0440\u043C\u0435\u0440\u043E\u0432",enemies:[[1,l.FARMER],[2,l.FARMER]]},{text:"\u0413\u0440\u0443\u043F\u043F\u0430 \u0444\u0435\u0440\u043C\u0435\u0440\u043E\u0432",enemies:[[0,l.FARMER],[1,l.FARMER]]},{text:"\u0413\u0440\u0443\u043F\u043F\u0430 \u0444\u0435\u0440\u043C\u0435\u0440\u043E\u0432",enemies:[[0,l.FARMER],[1,l.FARMER],[2,l.FARMER]]}],2:[{text:"\u0413\u0440\u0443\u043F\u043F\u0430 \u0444\u0435\u0440\u043C\u0435\u0440\u043E\u0432",enemies:[[0,l.FARMER],[1,l.FARMER],[2,l.FARMER],[4,l.FARMER]]},{text:"\u041F\u0430\u0442\u0440\u0443\u043B\u044C \u043C\u0430\u043B\u044B\u0439",enemies:[[0,l.MILITIA],[1,l.MILITIA]]},{text:"\u041F\u0430\u0442\u0440\u0443\u043B\u044C \u043C\u0430\u043B\u044B\u0439 c \u043B\u0443\u0447\u043D\u0438\u043A\u043E\u043C",enemies:[[1,l.MILITIA],[4,l.ARCHER]]},{text:"C\u043E\u043B\u0434\u0430\u0442",enemies:[[1,l.SHIELDMAN]]}],3:[{text:"\u041F\u0430\u0440\u0430 \u0441\u043E\u043B\u0434\u0430\u0442",enemies:[[0,l.MILITIA],[1,l.SHIELDMAN]]},{text:"\u041C\u0430\u043B\u044B\u0439 \u043E\u0442\u0440\u044F\u0434 \u0441\u043E\u043B\u0434\u0430\u0442",enemies:[[0,l.MILITIA],[1,l.SHIELDMAN],[4,l.ARCHER]]},{text:"\u0422\u043E\u043B\u043F\u0430 \u043A\u0440\u0435\u0441\u0442\u044C\u044F\u043D",enemies:[[0,l.FARMER],[1,l.FARMER],[2,l.FARMER],[3,l.FARMER],[4,l.ARCHER],[5,l.FARMER]]},{text:"\u041F\u0430\u0442\u0440\u0443\u043B\u044C \u0441 \u043B\u0443\u0447\u043D\u0438\u043A\u043E\u043C",enemies:[[0,l.MILITIA],[1,l.MILITIA],[2,l.MILITIA],[4,l.ARCHER]]},{text:"\u0411\u043E\u043B\u044C\u0448\u043E\u0439 \u043F\u0430\u0442\u0440\u0443\u043B\u044C",enemies:[[0,l.FARMER],[1,l.MILITIA],[2,l.MILITIA],[3,l.ARCHER],[4,l.MILITIA],[5,l.ARCHER]]},{text:"\u0411\u043E\u043B\u044C\u0448\u043E\u0439 \u043F\u0430\u0442\u0440\u0443\u043B\u044C",enemies:[[0,l.MILITIA],[1,l.MILITIA],[2,l.FARMER],[3,l.ARCHER],[4,l.ARCHER],[5,l.ARCHER]]}],4:[{text:"\u041E\u0442\u0440\u044F\u0434 \u0441\u043E\u043B\u0434\u0430\u0442",enemies:[[0,l.MILITIA],[1,l.SHIELDMAN],[2,l.MILITIA],[3,l.ARCHER],[5,l.ARCHER]]},{text:"\u0411\u043E\u043B\u044C\u0448\u043E\u0439 \u043E\u0442\u0440\u044F\u0434 \u0441\u043E\u043B\u0434\u0430\u0442",enemies:[[0,l.SHIELDMAN],[1,l.MILITIA],[2,l.SHIELDMAN],[3,l.ARCHER],[4,l.MILITIA],[5,l.ARCHER]]}],5:[{text:"\u0420\u044B\u0446\u0430\u0440\u044C",enemies:[[1,l.KNIGHT]]},{text:"\u0420\u044B\u0446\u0430\u0440\u044C \u0441 \u043E\u0440\u0443\u0436\u0435\u043D\u043E\u0441\u0446\u0435\u043C",enemies:[[1,l.SHIELDMAN],[4,l.KNIGHT]]},{text:"\u0420\u044B\u0446\u0430\u0440\u044C \u0441 \u0434\u0432\u0443\u043C\u044F \u043E\u0440\u0443\u0436\u0435\u043D\u043E\u0441\u0446\u0430\u043C\u0438",enemies:[[0,l.SHIELDMAN],[2,l.SHIELDMAN],[4,l.KNIGHT]]}],6:[{text:"\u0420\u044B\u0446\u0430\u0440\u044C \u0441 \u043E\u0442\u0440\u044F\u0434\u043E\u043C",enemies:[[0,l.SHIELDMAN],[1,l.MILITIA],[2,l.SHIELDMAN],[3,l.ARCHER],[4,l.KNIGHT],[5,l.ARCHER]]}]},Ce=[{text:"\u0422\u043E\u043B\u043F\u0430 \u043A\u0440\u0435\u0441\u0442\u044C\u044F\u043D",enemies:[[0,l.FARMER],[1,l.FARMER],[2,l.FARMER],[3,l.FARMER],[4,l.ARCHER],[5,l.FARMER]],greetText:"\u041D\u0443 \u0432\u0441\u0435, \u0442\u0440\u043E\u043B\u043B\u044C! \u041D\u0430\u0448\u0438 \u0434\u0435\u0440\u0435\u0432\u043D\u0438 \u0440\u0435\u0448\u0438\u043B\u0438, \u0447\u0442\u043E \u043F\u043E\u0440\u0430 \u0442\u0435\u0431\u044F \u043E\u0442\u0441\u044E\u0434\u0430 \u0432\u044B\u0442\u0443\u0440\u0438\u0442\u044C!",type:Lt.VIGILANTE},{text:"\u0411\u043E\u043B\u044C\u0448\u043E\u0439 \u043E\u0442\u0440\u044F\u0434 \u0441\u043E\u043B\u0434\u0430\u0442",enemies:[[0,l.SHIELDMAN],[1,l.MILITIA],[2,l.SHIELDMAN],[3,l.ARCHER],[4,l.ARCHER],[5,l.ARCHER]],greetText:"\u0421\u0435\u0433\u043E\u0434\u043D\u044F, \u0442\u0440\u043E\u043B\u043B\u044C, \u0442\u044B \u043F\u0440\u0435\u043A\u0440\u0430\u0442\u0438\u0448\u044C \u0438\u0437\u0434\u0435\u0432\u0430\u0442\u044C\u0441\u044F \u043D\u0430\u0434 \u043F\u0443\u0442\u043D\u0438\u043A\u0430\u043C\u0438.",type:Lt.VIGILANTE},{text:"\u0420\u044B\u0446\u0430\u0440\u044C",enemies:[[0,l.VIGILANTE],[1,l.SHIELDMAN],[3,l.ARCHER]],greetText:"\u0418\u043C\u0435\u043D\u0435\u043C \u041A\u043E\u0440\u043E\u043B\u044F, \u0442\u044B \u043F\u0440\u0438\u0433\u043E\u0432\u043E\u0440\u0435\u043D \u043A \u0441\u043C\u0435\u0440\u0442\u0438 \u0437\u0430 \u0441\u0432\u043E\u0438 \u0437\u043B\u043E\u0434\u0435\u044F\u043D\u0438\u044F!",type:Lt.VIGILANTE}],D4={text:"\u041E\u0442\u0440\u044F\u0434 \u0415\u0433\u043E \u0412\u0435\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430",enemies:[[0,l.SHIELDMAN],[1,l.SHIELDMAN],[2,l.SHIELDMAN],[3,l.ARCHER],[4,l.KING],[5,l.ARCHER]],greetText:"\u0414\u043E\u0440\u043E\u0433\u0443 \u0415\u0433\u043E \u0412\u0435\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0443, \u0414\u043E\u0440\u043E\u0433\u0443 \u041A\u043E\u0440\u043E\u043B\u044E!",type:Lt.KING},L4=Math.max(...Object.keys(Ke).map(u=>+u));class $e{constructor(t,e){r(this,"speaker");r(this,"placeToChar",{});r(this,"chars",[]);r(this,"initialSize");e=e!=null?e:B(0,t.length-1),this.speaker=t.length?t[e][1]:null,this.initialSize=t.length,t.forEach(([i,a])=>{this.placeToChar[i]=a,this.chars.push(a),a.squad=this,a.squadPlace=i;const o=this.getStartCoordForPlace(i);a.container.x=o.x,a.container.y=o.y})}getStartCoordForPlace(t){const e=x.bridgePosition(),i=e.height/5+e.y+e.height/5,a=e.height/5,o=e.x+e.width-50,c=a;return{x:t<=2?o:o+c,y:i+t%3*a}}getBattleCoordsForPlace(t){const e=x.bridgePosition(),i=e.height/5+e.y+e.height/5,a=e.height/5,o=e.x+e.width*.7,c=100;return{x:t<=2?o:o+c,y:i+t%3*a}}getSurrenderPositionForPlace(t){const e=x.bridgePosition(),i=e.height/5+e.y+e.height/5,a=e.height/5,o=e.x+e.width*.7+150,c=a;return{x:t<=2?o:o+c,y:i+t%3*a}}removeChar(t){if(t.squadPlace===null)throw Error("wtf");delete this.placeToChar[t.squadPlace],t.squadPlace=null,t.squad=null;const e=this.chars.findIndex(i=>i===t);e!==-1&&(this.chars.splice(e,1),this.speaker===t&&(this.speaker=this.chars.length?X(this.chars):null))}getDefenderOf(t){if(t.squad===null||t.squadPlace===null)throw Error("wtf");const e=this.getPossibleDefendersOf(t.squadPlace).filter(i=>i.canProtect(t));return e.length===0?null:X(e)}getPossibleDefendersOf(t){let e=[];switch(t){case 0:e=[1];break;case 1:e=[0,2];break;case 2:e=[1];break;case 3:e=[0,1,4];break;case 4:e=[0,1,2,3,5];break;case 5:e=[1,2,4];break}return e.reduce((i,a)=>{const o=this.placeToChar[a];return o&&i.push(o),i},[])}say(t){this.speaker?this.speaker.say(t):console.error("no speaker")}}class I4{constructor(){r(this,"chars",[]);r(this,"encounterLevel",0);r(this,"squad",new $e([]));r(this,"vigilanteTimeLeft",0);r(this,"vigilantePlanned",!1);r(this,"nextVigilanteEncounter",0);r(this,"isVigilante",!1);r(this,"isKing",!1);T.on(g.CHAR_LEFT_BRIDGE,e=>this.onCharLeftBridge(e)),T.on(g.TIME_PASSED,()=>{this.chars.forEach(e=>{e.isPrisoner&&e.timeWithoutFood++})}),T.on(g.TIME_PASSED,()=>{this.removeTravellers(),this.createRandomEncounter()}),T.on(g.TROLL_LOCATION_CHANGED,e=>this.onTrollLocationChanged(e));const t=x.bridgePosition();t.x+t.width,s.time.sub(e=>this.update(e)),s.register.characters(this),lt(e=>this.planVigilante(e),"planVigilante")}onTrollLocationChanged(t){t===v.LAIR&&this.letAllTravellersPass()}getSquadChars(){return this.squad.chars}createRandomEncounter(){console.log("Create random encounter");const t=ut();if(console.log("vigilantePlanned",this.vigilantePlanned),console.log("vigilante may be planned",s.troll.fearLevel===W.HORRIFIC,Ce[this.nextVigilanteEncounter+1]),this.vigilantePlanned){if(this.vigilanteTimeLeft--,console.log("time till vigilante comes:",this.vigilanteTimeLeft),this.vigilanteTimeLeft<=0){this.vigilantePlanned=!1;const a=Ce[this.nextVigilanteEncounter++];console.log("vigilante appears!"),this.encounterLevel=999,this.isVigilante=!0,this.createTravellers(a.enemies,Bt.VIGILANTE),s.interaction.disableEverything(),s.troll.goToBridge(),this.travellersSpeak(a.greetText||"");return}}else s.troll.fearLevel===W.HORRIFIC&&Ce[this.nextVigilanteEncounter]&&(console.log("check to plan vigilante"),t>.9&&this.planVigilante(3));this.isVigilante=!1;let e;console.log("encounter roll",t,", encounter level:"),t<=.4?(e=s.troll.level,console.log("======= exact troll level",e)):t<=.8?(e=B(0,s.troll.level-1),console.log("======= lower",e)):t<=.95?(e=B(s.troll.level+1,s.troll.level+2),console.log("======= higher",e)):(e=s.troll.level+3,console.log("======= highest possible",e)),e=Dt(e,0,L4),console.log("after clamp",e);let i=X(Ke[e]);s.bridge.isWithStatues&&t<=.8&&t>=.7?(this.encounterLevel=999,this.isKing=!0,i=D4,console.log("King encounter")):this.isKing=!1,this.encounterLevel=e,this.createTravellers(i.enemies),this.travellersSpeak(i.greetText||"")}planVigilante(t){this.vigilantePlanned=!0,this.vigilanteTimeLeft=t,console.log("vigilante planned"),T.emit(g.VIGILANTE_PLANNED,this.vigilanteTimeLeft)}update(t){this.chars.forEach(e=>e.update(t))}onCharLeftBridge(t){if(!this.chars.find(i=>i.id===t)){console.error("no char with id "+t);return}this.removeChar(t),this.getTravellers().length===0}charEaten(t){const e=this.chars.findIndex(i=>i.id===t);if(e===void 0){console.error("no char with id "+t);return}this.chars[e].becomeDevoured()}charToBones(t){const e=this.chars.findIndex(i=>i.id===t);if(e===void 0){console.error("no char with id "+t);return}this.chars[e].toBones()}removeChar(t){const e=this.chars.findIndex(i=>i.id===t);if(e===void 0){console.error("no char with id "+t);return}this.chars[e].destroy(),this.chars.splice(e,1)[0]}createTravellers(t,e){const i=x.bridgePosition(),a=i.height/5+i.y+i.height/5,o=i.height/5,c=i.x+i.width-50,f=o,D=t.map(([_,z])=>{const gt=_<=2?c:c+f,J=a+_%3*o,nt=new C4(z,gt,J,e);return this.chars.push(nt),[_,nt]});this.squad=new $e(D),e===Bt.VIGILANTE&&this.squad.chars.forEach(_=>_.goToTalk()),T.emit(g.TRAVELLERS_APPEAR)}removeTravellers(){this.getTravellers().map(t=>this.removeChar(t.id))}getDangerKey(){if(this.encounterLevel===0)return h.NONE;const t=s.troll.level-this.encounterLevel;return t>1||t===1?h.LOW:t===0?h.MEDIUM:t===-1?h.HIGH:t===-2?h.VERY_HIGH:h.IMPOSSIBLE}travellersSpeak(t){return this.getTravellers()[0].speak(t)}getNewTravellers(){return this.chars.filter(t=>t.getIsNewTraveller())}getTravellers(){return this.chars.filter(t=>t.getIsTraveller())}getTravellersAfterBattle(){return this.chars.filter(t=>t.getIsTraveller()&&!t.isReleased)}getFighters(){return this.chars.filter(t=>t.getIsAbleToFight())}getPrisoners(){return this.chars.filter(t=>t.getIsPrisoner())}getTraveller(t){const e=this.chars.find(i=>i.id===t);if(!e)throw Error("WTF");return e}travellersGoToTalk(){this.getNewTravellers().forEach(t=>t.goToTalk())}stopAllTravellers(){}allSurrender(){this.getTravellers().forEach(t=>t.surrender())}letAllTravellersPass(){this.getTravellers().forEach(t=>t.goAcrossBridge())}startFighting(){this.getTravellers().forEach(t=>t.startFighting())}makeAllTravellersPay(){let t=[];this.getTravellers().forEach(e=>{t=t.concat(e.giveGoldPayment()),e.payFood()}),s.lair.treasury.gatherGold(t)}makeAllTravellersGiveAll(){let t=[];this.getTravellers().forEach(e=>{t=t.concat(e.giveGold(e.gold)),e.dropFood(e.food,!0)}),s.lair.treasury.gatherGold(t),s.troll.changeFear(m.FEAR_CHANGES.ALL_GIVEN)}travellersTakeResourcesOnBridge(){let t=0;const e=s.characters.getTravellers(),i=s.entities.get(G.GOLD).filter(a=>a.location===it.GROUND).map(a=>b(t++*50).then(()=>X(e).takeGold(a)));return s.entities.get(G.MEAT).filter(a=>a.location===P.GROUND&&!a.props.isStale&&!a.props.isHuman).forEach(a=>{i.push(b(t++*50).then(()=>X(e).takeMeat(a)))}),Promise.all(i)}releaseChar(t){t.release()}makeImprisoned(t){var e;(e=this.chars.find(i=>i.id===t))==null||e.makeImprisoned()}makeCharGiveAll(t){s.troll.changeFear(Math.ceil(m.FEAR_CHANGES.ALL_GIVEN/this.squad.initialSize)),t.giveAll()}makeCharPay(t){t.pay()}killChar(t){t.getKilled()}feedChar(t){let e=this.getTravellers().find(i=>i.id===t);if(!e)throw Error("wtf");e.eat()}hitChar(t,e,i){let a=this.getTravellers().find(o=>o.id===t);if(!a)throw Error("wtf");a.getHit(e,i)}transformToFood(t){t.tornApart()}disableInteractivityAll(){this.chars.forEach(t=>t.disableInteractivity())}enableInteractivityAll(){this.chars.forEach(t=>t.enableInteractivity())}enableInteractivityOnBridge(){this.chars.forEach(t=>{t.isPrisoner||t.enableInteractivity()})}setPrisonersInteractive(t){this.getPrisoners().forEach(e=>t?e.enableInteractivity():e.disableInteractivity())}counterAttack(t){let i=this.getFighters().find(a=>a.id===t);if(!i)throw Error("wtf");return i.performCounterAttack()}canCounterAttack(t){let i=this.getFighters().find(a=>a.id===t);if(!i)throw Error("wtf");return i.canCounterAttack()}getDefenderOf(t){return this.squad.getDefenderOf(t)}}const Ye={[L.DEMAND_PAY]:{key:L.DEMAND_PAY,text:"\u041F\u043E\u0442\u0440\u0435\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u043B\u0430\u0442\u0443",resource:"icon_pay",execute:()=>L.DEMAND_PAY},[L.DEMAND_ALL]:{key:L.DEMAND_ALL,text:"\u041F\u043E\u0442\u0440\u0435\u0431\u043E\u0432\u0430\u0442\u044C \u0432\u0441\u0435!",resource:"icon_give_all",execute:()=>L.DEMAND_ALL},[L.GO_IN_PEACE]:{key:L.GO_IN_PEACE,text:"\u041E\u0442\u043F\u0443\u0441\u0442\u0438\u0442\u044C",resource:"icon_speed",execute:()=>L.GO_IN_PEACE},[L.TO_BATTLE]:{key:L.TO_BATTLE,text:"\u041D\u0430\u043F\u0430\u0441\u0442\u044C",resource:"icon_crossed_swords_fire",execute:()=>L.TO_BATTLE}};class R4{constructor(t,e){r(this,"verticalMenu");r(this,"actions",Ye);this.onClick=e,this.verticalMenu=this.createVerticalMenu(t)}createVerticalMenu(t){const e=x.bridgePosition(),i=e.y+e.height/2,a=e.x+e.width/4,o=Object.values(Ye).filter(c=>t.includes(c.key));return this.verticalMenu=new ae(o,{x:a,y:i},c=>this.onClick(c)),this.verticalMenu}show(t){this.createVerticalMenu(t),this.verticalMenu.updateButtons(),this.verticalMenu.show()}hide(){return this.verticalMenu.deactivateAllButtons(),this.verticalMenu.hide().then(()=>{this.verticalMenu.container.destroy()})}}var n;(function(u){u.START="START",u.ALL_GIVEN="ALL_GIVEN",u.PAYMENT_GIVEN="PAYMENT_GIVEN",u.ALL_REFUSED="ALL_REFUSED",u.PAY_REFUSED="PAY_REFUSED",u.BATTLE="BATTLE",u.END="END"})(n||(n={}));const S4=200,x4=30,y4=u=>u*S4+(u-1)*x4;class B4{constructor(){r(this,"isNegotiationInProgress",!1);r(this,"currentStateKey",n.END);r(this,"encounterState");r(this,"danger",h.NONE);r(this,"container");r(this,"travellersReadyToTalk",[]);r(this,"negotiationMenu",new R4([],t=>this.onMessage(t)));T.on(g.TROLL_LOCATION_CHANGED,e=>this.onTrollLocationChange(e)),T.on(g.CHAR_READY_TO_TALK,e=>this.onTravellerReadyToTalk(e)),T.on(g.TRAVELLERS_APPEAR,()=>this.onTravellersAppear());const t=x.bridgePosition();this.container=s.render.createContainer(t.x+t.width/2,t.y+t.height-64),s.layers.add(this.container,I.FIELD_BUTTONS),s.register.negotiations(this)}getIsNegotiationsInProgress(){return this.isNegotiationInProgress}onEncounterStart(){this.isNegotiationInProgress=!0,Mu()}onTravellersAppear(){s.troll.location===v.BRIDGE&&this.onEncounterStart()}onTrollLocationChange(t){t===v.BRIDGE&&s.characters.getNewTravellers().length&&this.onEncounterStart()}onEncounterEnd(){this.isNegotiationInProgress=!1,this.encounterState=null,this.danger=h.NONE,this.negotiationMenu.hide(),s.characters.letAllTravellersPass(),Ae()}onTravellerReadyToTalk(t){this.travellersReadyToTalk.push(t),this.travellersReadyToTalk.length===s.characters.getTravellers().length&&(this.travellersReadyToTalk=[],console.log("==========================="),console.log("encounterLevel",s.characters.encounterLevel,"danger",s.characters.getDangerKey()),console.log("==========================="),this.startNegotiations(s.characters.getDangerKey()))}startNegotiations(t){if(s.characters.isVigilante){this.currentStateKey=n.BATTLE,this.onStateChange();return}this.danger=t,this.currentStateKey=n.START;const e=s.characters.isKing?Xe:qe;this.encounterState=e[this.currentStateKey],this.onStateChange(),s.characters.isKing?s.characters.travellersSpeak("\u041F\u0440\u043E\u0447\u044C \u0441 \u043F\u0443\u0442\u0438, \u0442\u0440\u043E\u043B\u043B\u044C!"):s.characters.travellersSpeak(b4[t][100])}onStateChange(t=""){switch(this.currentStateKey){case n.START:s.characters.stopAllTravellers();break;case n.ALL_GIVEN:s.characters.makeAllTravellersGiveAll(),b(700).then(()=>{s.troll.laughHard(),s.troll.addXpForCurrentFighters(.75)});break;case n.PAYMENT_GIVEN:s.characters.makeAllTravellersPay(),b(700).then(()=>{s.troll.laugh(),s.troll.addXpForCurrentFighters(.5)});break;case n.BATTLE:this.isNegotiationInProgress=!1,s.battle.startBattle();break;case n.END:this.onEncounterEnd();break;case n.ALL_REFUSED:case n.PAY_REFUSED:s.troll.hmm();break}t&&s.characters.travellersSpeak(t),this.updateDialogButtons()}updateDialogButtons(){if(!this.isNegotiationInProgress){this.negotiationMenu.hide();return}this.negotiationMenu.hide().then(()=>{const t=this.getDialogVariants();y4(t.length),this.negotiationMenu.show(t)})}getDialogVariants(){return Object.keys(this.encounterState)}onMessage(t){const e=ut()*100;if(console.log("onMessage roll",e),!this.encounterState[t])throw Error("wrong message "+t);t===L.GO_IN_PEACE&&(this.currentStateKey===n.PAY_REFUSED||this.currentStateKey===n.ALL_REFUSED)&&s.troll.changeFear(m.FEAR_CHANGES.LET_PASS_AFTER_ASKING),t===L.DEMAND_PAY&&this.currentStateKey===n.ALL_REFUSED&&s.troll.changeFear(m.FEAR_CHANGES.ASK_PAY_AFTER_ALL_REFUSED),t===L.GO_IN_PEACE&&this.currentStateKey===n.START&&s.troll.changeFear(m.FEAR_CHANGES.LET_PASS);const i=this.encounterState[t][this.danger],a=Object.keys(i).filter(D=>D!=="default").sort((D,_)=>+D-+_),o=s.troll.fear*m.FEAR_FACTOR;console.log("edges",i,a,"fearBonus",o);let c="default";for(let D=0;D<a.length;D++){const _=+a[D]+o;if(e<=_){c=+a[D];break}}console.log("new state key",c),this.currentStateKey=i[c].nextState;const f=s.characters.isKing?Xe:qe;this.encounterState=f[this.currentStateKey],this.onStateChange(i[c].text)}}const b4={[h.IMPOSSIBLE]:{100:"\u0427\u0442\u043E \u0437\u0430 \u043D\u0430\u0433\u043B\u043E\u0435 \u043E\u0442\u0440\u043E\u0434\u044C\u0435 \u0432\u044B\u043B\u0435\u0437\u043B\u043E \u043D\u0430 \u0434\u043E\u0440\u043E\u0433\u0443?"},[h.VERY_HIGH]:{100:"\u041C\u0435\u0440\u0437\u043A\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435. \u0423\u0431\u0438\u0440\u0430\u0439\u0441\u044F \u0441 \u043F\u0443\u0442\u0438."},[h.HIGH]:{100:"\u0417\u0435\u043B\u0435\u043D\u0430\u044F \u0442\u0432\u0430\u0440\u044C. \u0427\u0442\u043E \u0442\u044B \u0445\u043E\u0447\u0435\u0448\u044C?"},[h.MEDIUM]:{100:"\u0427\u0442\u043E \u0442\u0435\u0431\u0435 \u043D\u0430\u0434\u043E\u0431\u043D\u043E, \u0442\u0440\u043E\u043B\u043B\u044C?"},[h.LOW]:{100:"\u041E\u043F\u0430\u0441\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435! \u0427\u0442\u043E \u0436\u0435 \u0434\u0435\u043B\u0430\u0442\u044C?.."},[h.NONE]:{100:"\u041A\u043E\u0448\u043C\u0430\u0440... \u042D\u0442\u043E \u043A\u043E\u043D\u0435\u0446!"}},Xe={[n.START]:{[L.DEMAND_ALL]:{[h.IMPOSSIBLE]:{default:{nextState:n.ALL_REFUSED,text:"\u041D\u0435 \u0441\u043C\u0435\u0448\u0438 \u041A\u043E\u0440\u043E\u043B\u044F, \u0437\u0435\u043B\u0435\u043D\u044B\u0439 \u0437\u0432\u0435\u0440\u044C."}},[h.VERY_HIGH]:{default:{nextState:n.ALL_REFUSED,text:"\u041D\u0435 \u0441\u043C\u0435\u0448\u0438 \u041A\u043E\u0440\u043E\u043B\u044F, \u0437\u0435\u043B\u0435\u043D\u044B\u0439 \u0437\u0432\u0435\u0440\u044C."}},[h.HIGH]:{default:{nextState:n.ALL_REFUSED,text:"\u041D\u0435 \u0441\u043C\u0435\u0448\u0438 \u041A\u043E\u0440\u043E\u043B\u044F, \u0437\u0435\u043B\u0435\u043D\u044B\u0439 \u0437\u0432\u0435\u0440\u044C."}},[h.MEDIUM]:{default:{nextState:n.ALL_REFUSED,text:"\u041D\u0435 \u0441\u043C\u0435\u0448\u0438 \u041A\u043E\u0440\u043E\u043B\u044F, \u0437\u0435\u043B\u0435\u043D\u044B\u0439 \u0437\u0432\u0435\u0440\u044C."}},[h.LOW]:{default:{nextState:n.ALL_REFUSED,text:"\u041D\u0435 \u0441\u043C\u0435\u0448\u0438 \u041A\u043E\u0440\u043E\u043B\u044F, \u0437\u0435\u043B\u0435\u043D\u044B\u0439 \u0437\u0432\u0435\u0440\u044C."}},[h.NONE]:{default:{nextState:n.ALL_REFUSED,text:"\u041D\u0435 \u0441\u043C\u0435\u0448\u0438 \u041A\u043E\u0440\u043E\u043B\u044F, \u0437\u0435\u043B\u0435\u043D\u044B\u0439 \u0437\u0432\u0435\u0440\u044C."}}},[L.DEMAND_PAY]:{[h.IMPOSSIBLE]:{default:{nextState:n.PAY_REFUSED,text:"\u0422\u0440\u0435\u0431\u0443\u0435\u0448\u044C \u043F\u043B\u0430\u0442\u044B \u043E\u0442 \u0441\u0430\u043C\u043E\u0433\u043E \u0415\u0433\u043E \u0412\u0435\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430? \u0422\u044B \u043E\u0431\u0435\u0437\u0443\u043C\u0435\u043B?"}},[h.VERY_HIGH]:{default:{nextState:n.PAY_REFUSED,text:"\u0422\u0440\u0435\u0431\u0443\u0435\u0448\u044C \u043F\u043B\u0430\u0442\u044B \u043E\u0442 \u0441\u0430\u043C\u043E\u0433\u043E \u0415\u0433\u043E \u0412\u0435\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430? \u0422\u044B \u043E\u0431\u0435\u0437\u0443\u043C\u0435\u043B?"}},[h.HIGH]:{default:{nextState:n.PAY_REFUSED,text:"\u0422\u0440\u0435\u0431\u0443\u0435\u0448\u044C \u043F\u043B\u0430\u0442\u044B \u043E\u0442 \u0441\u0430\u043C\u043E\u0433\u043E \u0415\u0433\u043E \u0412\u0435\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430? \u0422\u044B \u043E\u0431\u0435\u0437\u0443\u043C\u0435\u043B?"}},[h.MEDIUM]:{default:{nextState:n.PAY_REFUSED,text:"\u0422\u0440\u0435\u0431\u0443\u0435\u0448\u044C \u043F\u043B\u0430\u0442\u044B \u043E\u0442 \u0441\u0430\u043C\u043E\u0433\u043E \u0415\u0433\u043E \u0412\u0435\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430? \u0422\u044B \u043E\u0431\u0435\u0437\u0443\u043C\u0435\u043B?"}},[h.LOW]:{default:{nextState:n.PAY_REFUSED,text:"\u0422\u0440\u0435\u0431\u0443\u0435\u0448\u044C \u043F\u043B\u0430\u0442\u044B \u043E\u0442 \u0441\u0430\u043C\u043E\u0433\u043E \u0415\u0433\u043E \u0412\u0435\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430? \u0422\u044B \u043E\u0431\u0435\u0437\u0443\u043C\u0435\u043B?"}},[h.NONE]:{default:{nextState:n.PAY_REFUSED,text:"\u0422\u0440\u0435\u0431\u0443\u0435\u0448\u044C \u043F\u043B\u0430\u0442\u044B \u043E\u0442 \u0441\u0430\u043C\u043E\u0433\u043E \u0415\u0433\u043E \u0412\u0435\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430? \u0422\u044B \u043E\u0431\u0435\u0437\u0443\u043C\u0435\u043B?"}}},[L.TO_BATTLE]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.VERY_HIGH]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.HIGH]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.MEDIUM]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.LOW]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.NONE]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}}},[L.GO_IN_PEACE]:{[h.IMPOSSIBLE]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.VERY_HIGH]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.HIGH]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.MEDIUM]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.LOW]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.NONE]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}}}},[n.ALL_REFUSED]:{[L.DEMAND_PAY]:{[h.IMPOSSIBLE]:{default:{nextState:n.PAY_REFUSED,text:"\u041A\u0430\u043A\u0430\u044F \u043D\u0435\u0432\u0435\u0440\u043E\u044F\u0442\u043D\u0430\u044F \u043D\u0430\u0433\u043B\u043E\u0441\u0442\u044C!"}},[h.VERY_HIGH]:{default:{nextState:n.PAY_REFUSED,text:"\u041A\u0430\u043A\u0430\u044F \u043D\u0435\u0432\u0435\u0440\u043E\u044F\u0442\u043D\u0430\u044F \u043D\u0430\u0433\u043B\u043E\u0441\u0442\u044C!"}},[h.HIGH]:{default:{nextState:n.PAY_REFUSED,text:"\u041A\u0430\u043A\u0430\u044F \u043D\u0435\u0432\u0435\u0440\u043E\u044F\u0442\u043D\u0430\u044F \u043D\u0430\u0433\u043B\u043E\u0441\u0442\u044C!"}},[h.MEDIUM]:{default:{nextState:n.PAY_REFUSED,text:"\u041A\u0430\u043A\u0430\u044F \u043D\u0435\u0432\u0435\u0440\u043E\u044F\u0442\u043D\u0430\u044F \u043D\u0430\u0433\u043B\u043E\u0441\u0442\u044C!"}},[h.LOW]:{default:{nextState:n.PAY_REFUSED,text:"\u041A\u0430\u043A\u0430\u044F \u043D\u0435\u0432\u0435\u0440\u043E\u044F\u0442\u043D\u0430\u044F \u043D\u0430\u0433\u043B\u043E\u0441\u0442\u044C!"}},[h.NONE]:{default:{nextState:n.PAY_REFUSED,text:"\u041A\u0430\u043A\u0430\u044F \u043D\u0435\u0432\u0435\u0440\u043E\u044F\u0442\u043D\u0430\u044F \u043D\u0430\u0433\u043B\u043E\u0441\u0442\u044C!"}}},[L.TO_BATTLE]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.VERY_HIGH]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.HIGH]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.MEDIUM]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.LOW]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.NONE]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}}},[L.GO_IN_PEACE]:{[h.IMPOSSIBLE]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.VERY_HIGH]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.HIGH]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.MEDIUM]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.LOW]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.NONE]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}}}},[n.PAY_REFUSED]:{[L.TO_BATTLE]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.VERY_HIGH]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.HIGH]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.MEDIUM]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.LOW]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.NONE]:{default:{nextState:n.BATTLE,text:"\u0423\u0441\u043F\u043E\u043A\u043E\u0438\u0442\u044C \u044D\u0442\u043E \u0437\u043B\u043E\u0431\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}}},[L.GO_IN_PEACE]:{[h.IMPOSSIBLE]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.VERY_HIGH]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.HIGH]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.MEDIUM]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.LOW]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.NONE]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}}}},[n.ALL_GIVEN]:{},[n.PAYMENT_GIVEN]:{},[n.BATTLE]:{},[n.END]:{}},qe={[n.START]:{[L.DEMAND_ALL]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u0427\u0442\u043E \u044D\u0442\u0430 \u0442\u0432\u0430\u0440\u044C \u0431\u043E\u0440\u043C\u043E\u0447\u0435\u0442? \u041F\u0440\u043E\u0443\u0447\u0438\u0442\u044C \u0435\u0435!"}},[h.VERY_HIGH]:{default:{nextState:n.BATTLE,text:"\u041C\u043E\u043D\u0441\u0442\u0440, \u0442\u044B \u043E\u0441\u043A\u043E\u0440\u0431\u0438\u043B \u043D\u0430\u0441 \u0442\u0430\u043A\u0438\u043C \u043D\u0430\u0433\u043B\u044B\u043C \u0442\u0440\u0435\u0431\u043E\u0432\u0430\u043D\u0438\u0435\u043C. \u0418 \u0441\u0435\u0439\u0447\u0430\u0441 \u0442\u044B \u0437\u0430 \u044D\u0442\u043E \u0437\u0430\u043F\u043B\u0430\u0442\u0438\u0448\u044C!"}},[h.HIGH]:{[50]:{nextState:n.ALL_REFUSED,text:"\u0422\u044B \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u043C\u043D\u043E\u0433\u043E\u0433\u043E \u0445\u043E\u0447\u0435\u0448\u044C, \u0442\u0440\u043E\u043B\u043B\u044C. \u041F\u0440\u043E\u043F\u0443\u0441\u0442\u0438 \u043D\u0430\u0441 \u0441\u0435\u0439\u0447\u0430\u0441 \u0436\u0435!"},default:{nextState:n.BATTLE,text:"\u0417\u0430 \u043A\u043E\u0433\u043E \u0442\u044B \u043D\u0430\u0441 \u043F\u0440\u0438\u043D\u0438\u043C\u0430\u0435\u0448\u044C, \u0442\u0440\u043E\u043B\u043B\u044C? \u041A\u0430\u043A \u0442\u044B \u043F\u043E\u0441\u043C\u0435\u043B? \u041C\u044B \u0437\u0430\u0441\u0442\u0430\u0432\u0438\u043C \u0442\u0435\u0431\u044F \u043C\u043E\u043B\u0438\u0442\u044C \u043E \u043F\u0440\u043E\u0449\u0435\u043D\u0438\u0438!"}},[h.MEDIUM]:{[10]:{nextState:n.ALL_GIVEN,text:"\u041D\u0435\u0432\u0435\u0440\u043E\u044F\u0442\u043D\u0430 \u0436\u0430\u0434\u043D\u043E\u0441\u0442\u044C \u0442\u0432\u043E\u044F. \u041B\u0430\u0434\u043D\u043E, \u0437\u0430\u0431\u0438\u0440\u0430\u0439 \u0432\u0441\u0435 \u0438 \u0434\u0430\u0439 \u043F\u0440\u043E\u0439\u0442\u0438."},[60]:{nextState:n.ALL_REFUSED,text:"\u041D\u0435\u0442, \u0442\u044B \u0442\u0440\u0435\u0431\u0443\u0435\u0448\u044C \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u043C\u043D\u043E\u0433\u043E\u0433\u043E."},default:{nextState:n.BATTLE,text:"\u0423\u0431\u0438\u0440\u0430\u0439\u0441\u044F \u043F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438, \u043C\u0435\u0440\u0437\u043A\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.LOW]:{[20]:{nextState:n.ALL_GIVEN,text:"\u041B\u0430\u0434\u043D\u043E, \u0442\u0440\u043E\u043B\u043B\u044C-\u0433\u0440\u0430\u0431\u0438\u0442\u0435\u043B\u044C, \u0437\u0430\u0431\u0438\u0440\u0430\u0439 \u0432\u0441\u0435. \u0427\u0442\u043E\u0431 \u0442\u0435\u0431\u044F!"},default:{nextState:n.ALL_REFUSED,text:"\u041E\u0442\u0434\u0430\u0442\u044C \u0432\u0441\u0435 \u0434\u043E \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0435\u0433\u043E? \u041D\u0438 \u0437\u0430 \u0447\u0442\u043E!"}},[h.NONE]:{[75]:{nextState:n.ALL_GIVEN,text:"\u0414\u0435\u0432\u0430\u0442\u044C\u0441\u044F \u043D\u0435\u043A\u0443\u0434\u0430. \u0417\u0430\u0431\u0438\u0440\u0430\u0439 \u0432\u0441\u0435 \u043F\u043E\u0436\u0438\u0442\u043A\u0438, \u0431\u0435\u0437\u0436\u0430\u043B\u043E\u0441\u0442\u043D\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435..."},default:{nextState:n.ALL_REFUSED,text:"\u041E\u0442\u0434\u0430\u0442\u044C \u0432\u0441\u0435 \u0442\u0435\u0431\u0435 \u0438 \u0443\u043C\u0435\u0440\u0435\u0442\u044C \u043E\u0442 \u0433\u043E\u043B\u043E\u0434\u0430 \u0438 \u0445\u043E\u043B\u043E\u0434\u0430? \u041D\u0438 \u0437\u0430 \u0447\u0442\u043E! \u041B\u0443\u0447\u0448\u0435 \u043D\u0430 \u043C\u0435\u0441\u0442\u0435 \u0435\u0448\u044C, \u0445\u043E\u0442\u044F \u0431\u044B \u0431\u044B\u0441\u0442\u0440\u0435\u0435 \u0431\u0443\u0434\u0435\u0442."}}},[L.DEMAND_PAY]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u041A\u0430\u043A\u0430\u044F \u043D\u0435\u0432\u0435\u0440\u043E\u044F\u0442\u043D\u0430\u044F \u043D\u0430\u0433\u043B\u043E\u0441\u0442\u044C. \u0423\u0431\u0435\u0440\u0435\u043C \u044D\u0442\u0443 \u0433\u0430\u0434\u043E\u0441\u0442\u044C \u0441 \u043C\u043E\u0441\u0442\u0430!"}},[h.VERY_HIGH]:{[10]:{nextState:n.PAYMENT_GIVEN,text:"\u0422\u0430\u043A \u0443\u0436 \u0438 \u0431\u044B\u0442\u044C, \u0432\u043E\u0437\u044C\u043C\u0438 \u043F\u043B\u0430\u0442\u0443 \u0438 \u0434\u0430\u0439 \u043F\u0440\u043E\u0439\u0442\u0438."},[70]:{nextState:n.PAY_REFUSED,text:"\u0422\u044B \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043F\u043E\u043B\u0443\u0447\u0438\u0448\u044C. \u041E\u0441\u0432\u043E\u0431\u043E\u0434\u0438 \u043F\u0443\u0442\u044C!"},default:{nextState:n.BATTLE,text:"\u0427\u0442\u043E \u043D\u0430 \u043D\u0430\u0445\u0430\u043B\u044C\u0441\u0442\u0432\u043E! \u042D\u0442\u043E \u043C\u043E\u0441\u0442 \u041A\u043E\u0440\u043E\u043B\u044F, \u0430 \u043D\u0435 \u0442\u0432\u043E\u0439. \u041D\u0443, \u0431\u0435\u0440\u0435\u0433\u0438\u0441\u044C!"}},[h.HIGH]:{[20]:{nextState:n.PAYMENT_GIVEN,text:"\u041B\u0430\u0434\u043D\u043E, \u0432\u043E\u0442 \u0442\u0432\u043E\u044F \u043F\u043B\u0430\u0442\u0430."},[80]:{nextState:n.PAY_REFUSED,text:"\u0422\u044B \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043F\u043E\u043B\u0443\u0447\u0438\u0448\u044C. \u0423\u0445\u043E\u0434\u0438."},default:{nextState:n.BATTLE,text:"\u0422\u044B \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u043C\u043D\u043E\u0433\u043E \u043D\u0430 \u0441\u0435\u0431\u044F \u0431\u0435\u0440\u0435\u0448\u044C, \u043D\u0435\u0447\u0435\u0441\u0442\u0438\u0432\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435!"}},[h.MEDIUM]:{[40]:{nextState:n.PAYMENT_GIVEN,text:"\u0421\u043F\u0440\u0430\u0432\u0435\u0434\u043B\u0438\u0432\u043E\u0435 \u0442\u0440\u0435\u0431\u043E\u0432\u0430\u043D\u0438\u0435. \u0414\u0435\u0440\u0436\u0438 \u043E\u043F\u043B\u0430\u0442\u0443."},[80]:{nextState:n.PAY_REFUSED,text:"\u041D\u0435\u0442, \u043F\u043B\u0430\u0442\u044B \u0442\u044B \u043D\u0435 \u0434\u043E\u0436\u0434\u0435\u0448\u044C\u0441\u044F. \u0414\u0430\u0439 \u043F\u0440\u043E\u0439\u0442\u0438!"},default:{nextState:n.BATTLE,text:"\u041F\u043E\u0436\u0430\u043B\u0443\u0439, \u043B\u0443\u0447\u0448\u0435 \u0431\u0443\u0434\u0435\u0442 \u043D\u0430\u043C\u044F\u0442\u044C \u0442\u0435\u0431\u0435 \u0431\u043E\u043A\u0430!"}},[h.LOW]:{[75]:{nextState:n.PAYMENT_GIVEN,text:"\u0414\u0430, \u043A\u043E\u043D\u0435\u0447\u043D\u043E. \u0412\u043E\u0442 \u043F\u043B\u0430\u0442\u0430."},default:{nextState:n.PAY_REFUSED,text:"\u0422\u044B, \u043A\u043E\u043D\u0435\u0447\u043D\u043E, \u0441\u0442\u0440\u0430\u0448\u0435\u043D. \u041D\u043E \u043F\u043B\u0430\u0442\u044B \u0442\u0435\u0431\u0435 \u043D\u0435 \u0432\u0438\u0434\u0430\u0442\u044C."}},[h.NONE]:{[90]:{nextState:n.PAYMENT_GIVEN,text:"\u041A\u043E\u043D\u0435\u0447\u043D\u043E, \u0432\u043E\u0442, \u044D\u0442\u043E \u0442\u0432\u043E\u0435."},default:{nextState:n.PAY_REFUSED,text:"\u041E\u0442\u0434\u0430\u0442\u044C \u0442\u0435\u0431\u0435 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0435\u0435 - \u043D\u0438 \u0437\u0430 \u0447\u0442\u043E! \u041E\u0442\u043F\u0443\u0441\u0442\u0438, \u0434\u0430\u0439 \u043F\u0440\u043E\u0439\u0442\u0438! \u0418\u043D\u0430\u0447\u0435 \u0411\u043E\u0433 \u043F\u043E\u043A\u0430\u0440\u0430\u0435\u0442 \u0442\u0435\u0431\u044F!"}}},[L.TO_BATTLE]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u0425\u0430-\u0445\u0430, \u044D\u0442\u0430 \u0436\u0430\u043B\u043A\u0430\u044F \u0442\u0432\u0430\u0440\u044C \u0441\u043E\u0431\u0438\u0440\u0430\u0435\u0442\u0441\u044F \u0431\u0440\u043E\u0441\u0438\u0442\u044C\u0441\u044F!"}},[h.VERY_HIGH]:{default:{nextState:n.BATTLE,text:"\u041C\u0435\u0440\u0437\u043A\u0430\u044F \u0442\u0432\u0430\u0440\u044C, \u0442\u0435\u0431\u0435 \u043D\u0435 \u0441\u0434\u043E\u0431\u0440\u043E\u0432\u0430\u0442\u044C."}},[h.HIGH]:{default:{nextState:n.BATTLE,text:"\u0417\u043B\u043E\u0431\u043D\u044B\u0439 \u0442\u0440\u043E\u043B\u043B\u044C, \u0442\u044B \u043F\u043E\u0436\u0430\u043B\u0435\u0435\u0448\u044C \u043E \u0442\u043E\u043C, \u0447\u0442\u043E \u043F\u043E\u0434\u043D\u0438\u043C\u0430\u0435\u0448\u044C \u043B\u0430\u043F\u0443 \u043D\u0430 \u043F\u0443\u0442\u043D\u0438\u043A\u043E\u0432."}},[h.MEDIUM]:{default:{nextState:n.BATTLE,text:"\u0422\u044B \u043F\u043E\u043B\u0443\u0447\u0438\u0448\u044C \u043E\u0442\u043F\u043E\u0440, \u0447\u0443\u0434\u0438\u0449\u0435!"}},[h.LOW]:{default:{nextState:n.BATTLE,text:"\u0410\u0430\u0430, \u0442\u0440\u043E\u043B\u043B\u044C \u043D\u0430\u043F\u0430\u0434\u0430\u0435\u0442!"}},[h.NONE]:{default:{nextState:n.BATTLE,text:"\u0421\u043F\u0430\u0441\u0438\u0442\u0435! \u041A\u0442\u043E-\u043D\u0438\u0431\u0443\u0434\u044C!"}}},[L.GO_IN_PEACE]:{[h.IMPOSSIBLE]:{default:{nextState:n.END,text:"\u041F\u043E\u0441\u0442\u043E\u0440\u043E\u043D\u0438\u0441\u044C, \u043E\u0442\u0440\u043E\u0434\u044C\u0435, \u0430 \u043D\u0435 \u0442\u043E \u0440\u0430\u0441\u0442\u043E\u043F\u0447\u0435\u043C."}},[h.VERY_HIGH]:{default:{nextState:n.END,text:"\u0421 \u0434\u043E\u0440\u043E\u0433\u0438, \u0442\u0440\u043E\u043B\u043B\u044C."}},[h.HIGH]:{default:{nextState:n.END,text:"\u0427\u0442\u043E \u044D\u0442\u043E \u0437\u0430 \u0437\u0432\u0435\u0440\u044C?"}},[h.MEDIUM]:{default:{nextState:n.END,text:"\u0417\u0435\u043B\u0435\u043D\u044B\u0439 \u043C\u043E\u043D\u0441\u0442\u0440 \u043D\u0435 \u043C\u0435\u0448\u0430\u0435\u0442, \u043C\u043E\u0436\u043D\u043E \u0438\u0434\u0442\u0438."}},[h.LOW]:{default:{nextState:n.END,text:"\u0411\u0443\u0434\u044C \u0437\u0434\u043E\u0440\u043E\u0432, \u0441\u043C\u043E\u0442\u0440\u0438\u0442\u0435\u043B\u044C \u043C\u043E\u0441\u0442\u0430."}},[h.NONE]:{default:{nextState:n.END,text:"\u0421\u043F\u0430\u0441\u0438\u0431\u043E, \u0447\u0442\u043E \u043D\u0435 \u0442\u0440\u043E\u043D\u0443\u043B, \u0434\u043E\u0431\u0440\u044B\u0439 \u0442\u0440\u043E\u043B\u043B\u044C."}}}},[n.ALL_REFUSED]:{[L.DEMAND_PAY]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u0414\u0430 \u043A\u0430\u043A \u0442\u044B \u0432\u043E\u043E\u0431\u0449\u0435 \u0441\u043C\u0435\u0435\u0448\u044C! \u0421\u0435\u0439\u0447\u0430\u0441 \u043F\u043E\u043F\u043B\u0430\u0442\u0438\u0448\u044C\u0441\u044F \u0437\u0430 \u0434\u0435\u0440\u0437\u043E\u0441\u0442\u044C!"}},[h.VERY_HIGH]:{[5]:{nextState:n.PAYMENT_GIVEN,text:"\u041B\u0430\u0434\u043D\u043E, \u043F\u0440\u043E\u0441\u0442\u043E \u043F\u043B\u0430\u0442\u0443 \u0442\u044B, \u0442\u0430\u043A \u0443\u0436 \u0438 \u0431\u044B\u0442\u044C, \u043F\u043E\u043B\u0443\u0447\u0438\u0448\u044C."},[65]:{nextState:n.PAY_REFUSED,text:"\u0421\u043E\u0431\u0438\u0440\u0430\u0435\u0448\u044C\u0441\u044F \u0441\u043E\u0434\u0440\u0430\u0442\u044C \u0445\u043E\u0442\u044C \u0447\u0442\u043E-\u0442\u043E? \u041D\u0435 \u0442\u0443\u0442-\u0442\u043E \u0431\u044B\u043B\u043E. \u0423\u0431\u0438\u0440\u0430\u0439\u0441\u044F \u0441 \u0434\u043E\u0440\u043E\u0433\u0438!"},default:{nextState:n.BATTLE,text:"\u0422\u0435\u0431\u0435 \u0431\u044B\u043B \u0434\u0430\u043D \u0448\u0430\u043D\u0441, \u0443\u043F\u0440\u044F\u043C\u0430\u044F \u0442\u0432\u0430\u0440\u044C!"}},[h.HIGH]:{10:{nextState:n.PAYMENT_GIVEN,text:"\u042D\u0442\u043E \u0435\u0449\u0435 \u043A\u0443\u0434\u0430 \u043D\u0438 \u0448\u043B\u043E. \u0414\u0435\u0440\u0436\u0438 \u0438 \u0434\u0430\u0439 \u043F\u0440\u043E\u0439\u0442\u0438."},75:{nextState:n.PAY_REFUSED,text:"\u0418 \u043F\u043B\u0430\u0442\u044B \u0442\u044B \u0442\u043E\u0436\u0435 \u043D\u0435 \u043F\u043E\u043B\u0443\u0447\u0438\u0448\u044C."},default:{nextState:n.BATTLE,text:"\u0414\u0430 \u0447\u0442\u043E \u0442\u044B \u0437\u0430 \u043D\u0430\u0433\u043B\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435! \u041D\u0443 \u0432\u0441\u0435, \u0431\u0435\u0440\u0435\u0433\u0438\u0441\u044C!"}},[h.MEDIUM]:{20:{nextState:n.PAYMENT_GIVEN,text:"\u042D\u0442\u043E \u0431\u043E\u043B\u0435\u0435 \u0441\u043F\u0440\u0430\u0432\u0435\u0434\u043B\u0438\u0432\u043E\u0435 \u0442\u0440\u0435\u0431\u043E\u0432\u0430\u043D\u0438\u0435."},60:{nextState:n.PAY_REFUSED,text:"\u041D\u0435\u0442, \u0436\u0430\u0434\u043D\u044B\u0439 \u0442\u0440\u043E\u043B\u043B\u044C, \u0442\u044B \u043D\u0435 \u043F\u043E\u043B\u0443\u0447\u0438\u0448\u044C \u0438 \u043F\u0440\u043E\u0441\u0442\u043E \u043F\u043B\u0430\u0442\u044B."},default:{nextState:n.BATTLE,text:"\u0414\u0430 \u0447\u0442\u043E \u0442\u044B \u0437\u0430 \u043D\u0430\u0433\u043B\u043E\u0435 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0435! \u041D\u0443 \u0432\u0441\u0435, \u0431\u0435\u0440\u0435\u0433\u0438\u0441\u044C!"}},[h.LOW]:{75:{nextState:n.PAYMENT_GIVEN,text:"\u0422\u0430\u043A \u0431\u044B \u0441\u0440\u0430\u0437\u0443. \u0412\u043E\u0442, \u044D\u0442\u043E \u0442\u0432\u043E\u0435."},default:{nextState:n.PAY_REFUSED,text:"\u0422\u0440\u043E\u043B\u043B\u044C, \u0431\u0443\u0434\u044C \u0434\u043E\u0431\u0440, \u043F\u0440\u043E\u043F\u0443\u0441\u0442\u0438 \u0437\u0430 \u0442\u0430\u043A?"}},[h.NONE]:{75:{nextState:n.PAYMENT_GIVEN,text:"\u041E\u0445, \u043B\u0430\u0434\u043D\u043E, \u0442\u0440\u043E\u043B\u043B\u044C. \u0412\u043E\u0442 \u043F\u043B\u0430\u0442\u0430."},default:{nextState:n.PAY_REFUSED,text:"\u041D\u0435 \u043E\u0442\u043D\u0438\u043C\u0430\u0439 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0435\u0435, \u043F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430..."}}},[L.TO_BATTLE]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u0421\u0435\u0439\u0447\u0430\u0441 \u043F\u043E\u043F\u043B\u0430\u0442\u0438\u0448\u044C\u0441\u044F \u0437\u0430 \u0434\u0435\u0440\u0437\u043E\u0441\u0442\u044C!"}},[h.VERY_HIGH]:{default:{nextState:n.BATTLE,text:"\u041F\u0440\u0438\u0433\u043E\u0442\u043E\u0432\u044C\u0441\u044F \u0431\u044B\u0442\u044C \u0443\u043D\u0438\u0436\u0435\u043D\u043D\u044B\u043C!"}},[h.HIGH]:{default:{nextState:n.BATTLE,text:"\u0422\u044B \u0431\u0443\u0434\u0435\u0448\u044C \u043F\u043E\u0432\u0435\u0440\u0436\u0435\u043D!"}},[h.MEDIUM]:{default:{nextState:n.BATTLE,text:"\u0422\u0440\u043E\u043B\u043B\u044C \u043D\u0430\u043F\u0430\u0434\u0430\u0435\u0442!"}},[h.LOW]:{default:{nextState:n.BATTLE,text:"\u041E\u0439-\u0435\u0439!"}},[h.NONE]:{default:{nextState:n.BATTLE,text:"\u041D\u0435\u0442! \u041F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430, \u043D\u0435 \u0442\u0440\u043E\u0433\u0430\u0439!"}}},[L.GO_IN_PEACE]:{[h.IMPOSSIBLE]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.VERY_HIGH]:{default:{nextState:n.END,text:"\u0422\u043E-\u0442\u043E \u0436\u0435."}},[h.HIGH]:{default:{nextState:n.END,text:"\u041E\u0441\u0432\u043E\u0431\u043E\u0434\u0438 \u043F\u0443\u0442\u044C."}},[h.MEDIUM]:{default:{nextState:n.END,text:"\u0421\u0440\u0430\u0437\u0443 \u0431\u044B \u0442\u0430\u043A."}},[h.LOW]:{default:{nextState:n.END,text:"\u041D\u0443, \u0437\u043D\u0430\u0447\u0438\u0442, \u043C\u043E\u0436\u043D\u043E \u0438\u0434\u0442\u0438..."}},[h.NONE]:{default:{nextState:n.END,text:"\u0421\u043F\u0430\u0441\u0438\u0431\u043E, \u0447\u0442\u043E \u043D\u0435 \u0437\u043B\u0438\u0448\u044C\u0441\u044F."}}}},[n.ALL_GIVEN]:{[L.GO_IN_PEACE]:{[h.IMPOSSIBLE]:{default:{nextState:n.END,text:"..."}},[h.VERY_HIGH]:{default:{nextState:n.END,text:"\u0422\u0432\u043E\u0439 \u0441\u0447\u0430\u0441\u0442\u043B\u0438\u0432\u044B\u0439 \u0434\u0435\u043D\u044C."}},[h.HIGH]:{default:{nextState:n.END,text:"\u0417\u0435\u043B\u0435\u043D\u044B\u0439 \u0433\u0440\u0430\u0431\u0438\u0442\u0435\u043B\u044C..."}},[h.MEDIUM]:{default:{nextState:n.END,text:"\u0422\u0435\u0431\u0435 \u044D\u0442\u043E \u0430\u0443\u043A\u043D\u0435\u0442\u0441\u044F..."}},[h.LOW]:{default:{nextState:n.END,text:"\u0423\u0431\u0440\u0430\u0442\u044C\u044F \u0431\u044B \u043E\u0442\u0441\u044E\u0434\u0430 \u043F\u043E\u0441\u043A\u043E\u0440\u0435\u0439..."}},[h.NONE]:{default:{nextState:n.END,text:"\u041A\u0430\u043A \u0431\u044B \u0442\u0435\u043F\u0435\u0440\u044C \u043D\u0435 \u0443\u043C\u0435\u0440\u0435\u0442\u044C \u0441 \u0433\u043E\u043B\u043E\u0434\u0443..."}}}},[n.PAYMENT_GIVEN]:{[L.GO_IN_PEACE]:{[h.IMPOSSIBLE]:{default:{nextState:n.END,text:"..."}},[h.VERY_HIGH]:{default:{nextState:n.END,text:"\u0412 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0439 \u0440\u0430\u0437 \u043D\u0435 \u0436\u0434\u0438 \u0442\u0430\u043A\u043E\u0439 \u0449\u0435\u0434\u0440\u043E\u0441\u0442\u0438."}},[h.HIGH]:{default:{nextState:n.END,text:"\u0414\u0435\u0440\u0436\u0438 \u043C\u043E\u0441\u0442 \u0432 \u043F\u043E\u0440\u044F\u0434\u043A\u0435, \u0442\u0440\u043E\u043B\u043B\u044C."}},[h.MEDIUM]:{default:{nextState:n.END,text:"\u041E\u0442\u043B\u0438\u0447\u043D\u044B\u0439 \u043C\u043E\u0441\u0442, \u0434\u0440\u0443\u0433. \u0414\u0430\u0432\u0430\u0439, \u043D\u0435 \u0431\u043E\u043B\u0435\u0439 \u0442\u0443\u0442!"}},[h.LOW]:{default:{nextState:n.END,text:"\u0427\u0435\u0441\u0442\u043D\u0430\u044F \u043F\u043B\u0430\u0442\u0430 \u0437\u0430 \u0447\u0435\u0441\u0442\u043D\u0443\u044E \u0442\u0440\u043E\u043B\u043B\u044C\u044E \u0440\u0430\u0431\u043E\u0442\u0443, \u0432\u0435\u0440\u043D\u043E? \u0425\u043E\u0440\u043E\u0448\u0435\u0433\u043E \u0434\u043D\u044F!"}},[h.NONE]:{default:{nextState:n.END,text:"\u0425\u043E\u0440\u043E\u0448\u0435\u0433\u043E \u0434\u043D\u044F, \u043C\u0438\u0441\u0442\u0435\u0440 \u0442\u0440\u043E\u043B\u043B\u044C."}}}},[n.PAY_REFUSED]:{[L.TO_BATTLE]:{[h.IMPOSSIBLE]:{default:{nextState:n.BATTLE,text:"\u0421\u0435\u0439\u0447\u0430\u0441 \u043F\u043E\u043F\u043B\u0430\u0442\u0438\u0448\u044C\u0441\u044F \u0437\u0430 \u0434\u0435\u0440\u0437\u043E\u0441\u0442\u044C!"}},[h.VERY_HIGH]:{default:{nextState:n.BATTLE,text:"\u041F\u0440\u0438\u0433\u043E\u0442\u043E\u0432\u044C\u0441\u044F \u0431\u044B\u0442\u044C \u0443\u043D\u0438\u0436\u0435\u043D\u043D\u044B\u043C!"}},[h.HIGH]:{default:{nextState:n.BATTLE,text:"\u0422\u044B \u0431\u0443\u0434\u0435\u0448\u044C \u043F\u043E\u0432\u0435\u0440\u0436\u0435\u043D!"}},[h.MEDIUM]:{default:{nextState:n.BATTLE,text:"\u0422\u0440\u043E\u043B\u043B\u044C \u043D\u0430\u043F\u0430\u0434\u0430\u0435\u0442!"}},[h.LOW]:{default:{nextState:n.BATTLE,text:"\u041E\u0439-\u0435\u0439!"}},[h.NONE]:{default:{nextState:n.BATTLE,text:"\u041D\u0435\u0442! \u041F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430, \u043D\u0435 \u0442\u0440\u043E\u0433\u0430\u0439!"}}},[L.GO_IN_PEACE]:{[h.IMPOSSIBLE]:{default:{nextState:n.END,text:"\u041F\u0440\u043E\u0447\u044C \u0441 \u0434\u043E\u0440\u043E\u0433\u0438."}},[h.VERY_HIGH]:{default:{nextState:n.END,text:"\u0422\u043E-\u0442\u043E \u0436\u0435."}},[h.HIGH]:{default:{nextState:n.END,text:"\u041E\u0441\u0432\u043E\u0431\u043E\u0434\u0438 \u043F\u0443\u0442\u044C."}},[h.MEDIUM]:{default:{nextState:n.END,text:"\u0421\u0440\u0430\u0437\u0443 \u0431\u044B \u0442\u0430\u043A."}},[h.LOW]:{default:{nextState:n.END,text:"\u041D\u0443, \u0437\u043D\u0430\u0447\u0438\u0442, \u043C\u043E\u0436\u043D\u043E \u0438\u0434\u0442\u0438... \u0424\u0443\u0445."}},[h.NONE]:{default:{nextState:n.END,text:"\u0421\u043F\u0430\u0441\u0438\u0431\u043E, \u0447\u0442\u043E \u043D\u0435 \u0437\u043B\u0438\u0448\u044C\u0441\u044F."}}}},[n.BATTLE]:{},[n.END]:{}};let ze=0;class O4{constructor(){r(this,"listeners",[]);r(this,"day",1);r(this,"time",At.MORNING);s.register.time(this)}sub(t){const e=ze;return ze++,this.listeners.push([e,t]),e}unsub(t){this.listeners=this.listeners.filter(e=>e[0]!==t)}onUpdate(t){this.listeners.forEach(e=>e[1](t))}wait(){const t=te.indexOf(this.time);t===te.length-1?(this.day=this.day+1,this.time=te[0]):this.time=te[t+1],T.emit(g.TIME_PASSED)}}var De;(function(u){u.FEED="FEED"})(De||(De={}));var at;(function(u){u.RELEASE="RELEASE",u.ROB="ROB",u.TAKE_ALL="TAKE_ALL",u.MAKE_FOOD="MAKE_FOOD"})(at||(at={}));var ot;(function(u){u.BATTLE_HIT="BATTLE_HIT",u.BATTLE_DEVOUR="BATTLE_DEVOUR",u.BATTLE_THROW_ROCK="BATTLE_THROW_ROCK",u.BATTLE_THROW_CHAR="BATTLE_THROW_CHAR"})(ot||(ot={}));const N4=[{key:De.FEED,text:"\u041D\u0430\u043A\u043E\u0440\u043C\u0438\u0442\u044C",resource:"button_feed",onClick:u=>s.lair.feedChar(u)}];N4.reduce((u,t)=>(u[t.key]=t,u),{});const oe={[ot.BATTLE_HIT]:{key:ot.BATTLE_HIT,text:"\u0423\u0434\u0430\u0440\u0438\u0442\u044C",resource:"button_strike",execute:u=>s.battle.trollGoAttack(u),getIsActive:u=>u.hp>0&&!u.getIsCovered()&&!u.isSurrender,getText:()=>{const u=s.troll.getDmg();return`\u0423\u0434\u0430\u0440\u0438\u0442\u044C (${u[0]}-${u[1]})`}},[ot.BATTLE_THROW_ROCK]:{key:ot.BATTLE_THROW_ROCK,text:"\u041C\u0435\u0442\u043D\u0443\u0442\u044C \u043A\u0430\u043C\u0435\u043D\u044C",resource:"button_throw_rock",abilityKey:K.THROW_ROCK,execute:u=>s.battle.trollThrowRock(u),getIsActive:u=>u.hp>0&&!(u.isUnconscious&&u.getIsCovered())&&!u.isSurrender,getDisabledAndReason:()=>s.bridge.getHasAvailableRocks()?!1:"\u043D\u0435\u0442 \u043A\u0430\u043C\u043D\u0435\u0439, \u043D\u0430\u0434\u043E \u043F\u043E\u0447\u0438\u043D\u0438\u0442\u044C \u043C\u043E\u0441\u0442",getText:()=>{const u=s.troll.getDmg(!1,!0);return`\u041C\u0435\u0442\u043D\u0443\u0442\u044C \u043A\u0430\u043C\u0435\u043D\u044C (${u[0]}-${u[1]})`}},[ot.BATTLE_THROW_CHAR]:{key:ot.BATTLE_THROW_CHAR,text:"\u0411\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0431 \u0437\u0435\u043C\u043B\u044E",resource:"button_throw_char",abilityKey:K.GRAPPLE,execute:u=>s.battle.trollGoThrowChar(u),getIsActive:u=>u.hp>0&&!u.getIsCovered()&&!u.isMounted&&!u.isSurrender,getDisabledAndReason:()=>s.troll.grappleCooldown>0?"Cooldown: "+s.troll.grappleCooldown:!1,getText:()=>{const u=s.troll.getDmg(!0);return`\u0411\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0431 \u0437\u0435\u043C\u043B\u044E (${u[0]}-${u[1]})`}},[ot.BATTLE_DEVOUR]:{key:ot.BATTLE_DEVOUR,abilityKey:K.MAN_EATER,text:"\u0421\u043E\u0436\u0440\u0430\u0442\u044C \u043B\u0435\u0436\u0430\u0447\u0435\u0433\u043E",resource:"button_devour",execute:u=>s.battle.trollGoDevour(u),getIsActive:u=>u.isUnconscious&&!u.getIsCovered()}};class F4{constructor(){r(this,"verticalMenu");r(this,"actions",oe)}createVerticalMenu(){const t=x.bridgePosition(),e=t.y+t.height/2,i=t.x+t.width/4,a=s.troll.getCurrentAbilities(),o=Object.values(oe).filter(c=>c.abilityKey===void 0||a.includes(c.abilityKey));return this.verticalMenu=new ae(o,{x:i,y:e},c=>this.onClick(c)),this.verticalMenu}onClick(t){this.verticalMenu.selectButton(t),s.characters.getSquadChars().forEach(e=>{oe[t].getIsActive(e)?(e.onSpriteClicked(a=>{oe[t].execute(a),this.verticalMenu.selectButton(null)}),e.setCursor("pointer")):(e.sprite.removeClickListener(),e.setCursor("not-allowed"))})}show(){this.createVerticalMenu(),this.verticalMenu.updateButtons(),this.verticalMenu.show()}hide(){this.verticalMenu.deactivateAllButtons(),this.verticalMenu.hide().then(()=>{this.verticalMenu.destroy()}),s.characters.getSquadChars().forEach(t=>t.sprite.removeClickListener())}}const Le={[at.RELEASE]:{key:at.RELEASE,text:"\u041E\u0442\u043F\u0443\u0441\u0442\u0438\u0442\u044C",resource:"button_release",execute:u=>s.characters.releaseChar(u),getIsActive:u=>!0},[at.ROB]:{key:at.ROB,text:"\u041E\u0442\u043E\u0431\u0440\u0430\u0442\u044C \u043F\u043B\u0430\u0442\u0443",resource:"icon_pay",execute:u=>{u.dropGold(Math.ceil(u.gold*.33),!0),s.characters.releaseChar(u)},getIsActive:u=>!u.isRobbed},[at.TAKE_ALL]:{key:at.TAKE_ALL,text:"\u041E\u0442\u043E\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0435",resource:"icon_give_all",execute:u=>{s.characters.makeCharGiveAll(u),s.characters.releaseChar(u)},getIsActive:u=>u.gold>0||u.food>0},[at.MAKE_FOOD]:{key:at.MAKE_FOOD,text:"\u0420\u0430\u0437\u043E\u0440\u0432\u0430\u0442\u044C",resource:"button_make_food",execute:u=>s.characters.transformToFood(u),getIsActive:u=>!0}};class w4{constructor(){r(this,"verticalMenu");const t=x.bridgePosition(),e=t.y+t.height/2,i=t.x+t.width/4,a=Object.values(Le);this.verticalMenu=new ae(a,{x:i,y:e},o=>this.onButtonClick(o))}onButtonClick(t){this.verticalMenu.selectButton(t),s.characters.getTravellersAfterBattle().forEach(e=>{Le[t].getIsActive(e)?(e.onSpriteClicked(a=>{Le[t].execute(a),this.checkEnd()}),e.setCursor("pointer")):(e.sprite.removeClickListener(),e.setCursor("not-allowed"))})}checkEnd(){s.characters.getTravellersAfterBattle().length===0&&(this.hide(),Ae())}show(){s.characters.enableInteractivityOnBridge(),this.verticalMenu.show()}hide(){s.characters.getSquadChars().forEach(t=>t.sprite.removeClickListener()),this.verticalMenu.hide()}}class P4{constructor(){r(this,"unsub",[]);r(this,"isBattle",!1);r(this,"actionsMenu");r(this,"afterBattleMenu");r(this,"xpForBattle",0);s.register.battle(this),this.actionsMenu=new F4,this.afterBattleMenu=new w4}startBattle(){this.isBattle=!0;const t=s.characters.getFighters();if(t.length===0)return s.characters.allSurrender();const e=T.on(g.TROLL_TURN_END,()=>this.travellersTurn());this.unsub.push(()=>T.unsubscribe(g.TROLL_TURN_END,e)),T.emit(g.BATTLE_STARTED),this.xpForBattle=s.troll.getXpForSquad(t.map(i=>i.key)),s.characters.startFighting(),b(1e3).then(()=>this.trollTurn())}async trollTurn(){s.troll.updateCooldowns(),s.troll.rageStartCheck(),s.troll.isEnraged?(await b(1e3),this.trollGoCrazy()):(s.characters.enableInteractivityAll(),this.actionsMenu.show())}async travellersTurn(){if(console.log("travellers Turn"),this.actionsMenu.hide(),this.getIsWin())return this.win();s.troll.rageStopCheck(),s.characters.disableInteractivityAll();const t=s.characters.getFighters();for(let e=0;e<t.length&&(await t[e].performBattleAction(),!!s.troll.getIsAlive());e++);T.emit(g.BATTLE_TRAVELLERS_TURN_END),s.troll.getIsAlive()?this.trollTurn():this.fail()}getIsWin(){return s.characters.getFighters().length===0}fail(){if(this.isBattle&&T.emit(g.BATTLE_DEFEAT,s.negotiations.danger),this.onBattleEnd(),s.characters.isVigilante){s.characters.getFighters()[0].say("\u041D\u0430\u0441\u0442\u0430\u043B \u0442\u0432\u043E\u0439 \u043A\u043E\u043D\u0435\u0446!"),s.characters.getFighters()[0].performFatality().then(()=>{s.characters.letAllTravellersPass()});return}s.characters.travellersTakeResourcesOnBridge().then(()=>{s.characters.letAllTravellersPass(),Ae()})}win(){if(this.isBattle&&T.emit(g.BATTLE_WON,s.negotiations.danger),this.onBattleEnd(),s.characters.isKing){s.game.gameWin("\u041E\u0442\u0440\u044F\u0434 \u0441\u0430\u043C\u043E\u0433\u043E \u043A\u043E\u0440\u043E\u043B\u044F \u043F\u043E\u0431\u0435\u0436\u0434\u0435\u043D. \u0422\u0435\u043F\u0435\u0440\u044C \u043D\u0438\u043A\u0442\u043E \u043D\u0435 \u043F\u043E\u0441\u043C\u0435\u0435\u0442 \u043F\u0435\u0440\u0435\u0447\u0438\u0442\u044C \u0442\u0440\u043E\u043B\u043B\u044E!");return}this.afterBattleMenu.show(),s.troll.addXp(this.xpForBattle),this.xpForBattle=0}onBattleEnd(){T.emit(g.BATTLE_END),this.actionsMenu.hide(),s.troll.setEnraged(!1),this.isBattle=!1,this.unsub.forEach(t=>t())}onBridgeDestroyed(){const t=tt();this.actionsMenu.hide(),s.render.moveTo(s.troll.container,{x:s.troll.container.x,y:t.height+100},B(400,600)),s.characters.getTravellers().forEach(e=>s.render.moveTo(e.container,{x:e.container.x,y:t.height+100},B(400,600))),s.entities.get(G.MEAT).filter(e=>e.location===P.GROUND).forEach(e=>e.destroy()),s.entities.get(G.GOLD).filter(e=>e.location===it.GROUND).forEach(e=>e.destroy())}async trollThrowRock(t){s.characters.disableInteractivityAll();const e=s.characters.squad.getDefenderOf(t);if(e)await this.defendAgainstThrow(t,e,i=>s.troll.throwRockAt(i));else{if(await s.troll.throwRockAt(t),s.bridge.checkDestruction())return this.onBridgeDestroyed();if(this.getIsWin())return this.win();await s.troll.goToBattlePosition()}return s.troll.directToTarget(t.container),this.travellersTurn()}trollGoCrazy(){s.troll.setEnraged(!0);const t=s.characters.getTravellers(),e=t.find(o=>this.actionsMenu.actions.BATTLE_DEVOUR.getIsActive(o));if(e)return this.trollGoDevour(e);const i=[],a=s.troll.getCurrentAbilities();return Object.values(this.actionsMenu.actions).filter(o=>{var c;return(o.abilityKey===void 0||a.includes(o.abilityKey))&&!((c=o.getDisabledAndReason)==null?void 0:c.call(o))}).map(o=>{t.forEach(c=>{o.getIsActive(c)&&i.push(()=>o.execute(c))})}),X(i)()}async trollGoAttack(t){s.characters.disableInteractivityAll();const e=t.rollCounterAttack(),i=t.rollEvade(),a=s.characters.getDefenderOf(t);if(a)await this.defendAgainstHit(t,a,c=>s.troll.attack(c));else if(i)await s.troll.moveToChar(t),await t.evade(),await Promise.all([s.troll.goToBattlePosition(),t.goToBattlePosition()]);else if(e){if(await s.troll.moveToChar(t),await s.characters.counterAttack(t.id),await b(500),!s.troll.getIsAlive())return this.fail();if(await s.troll.attack(t),this.getIsWin())return this.win();await s.troll.goToBattlePosition()}else{if(await s.troll.moveToChar(t),await s.troll.attack(t),this.getIsWin())return this.win();await s.troll.goToBattlePosition()}const o=s.characters.getFighters();return s.troll.directToTarget(o[0].container),this.travellersTurn()}async trollGoThrowChar(t){s.characters.disableInteractivityAll();const e=t.rollCounterAttack(Ve.COUNTER_ATTACK_AGAINST_GRAPPLE_BONUS),i=s.characters.getDefenderOf(t);if(i)await this.defendAgainstHit(t,i,a=>s.troll.throwChar(a));else{if(await s.troll.moveToChar(t),e&&(await s.characters.counterAttack(t.id),await b(500),!s.troll.getIsAlive()))return this.fail();if(await s.troll.throwChar(t),this.getIsWin())return this.win();await s.troll.goToBattlePosition()}return this.travellersTurn()}async trollGoDevour(t){s.characters.disableInteractivityAll();const e=s.characters.getDefenderOf(t);return e?await this.defendAgainstHit(t,e,i=>s.troll.attack(i)):(await s.troll.moveToChar(t),await s.troll.devourAttack(t.id)),s.troll.getIsAlive()?this.getIsWin()?this.win():(await s.troll.goToBattlePosition(),this.travellersTurn()):this.fail()}async defendAgainstHit(t,e,i){if(await Promise.all([e.goDefend(t),s.troll.moveToDefenderOfChar(t)]),await i(e),this.getIsWin())return this.win();const a=[];e.getIsAbleToFight()&&a.push(e.goToBattlePosition()),a.push(s.troll.goToBattlePosition()),await Promise.all(a)}async defendAgainstThrow(t,e,i){if(await Promise.all([e.goDefend(t),i(e)]),s.bridge.checkDestruction())return this.onBridgeDestroyed();if(this.getIsWin())return this.win();const o=[];e.getIsAbleToFight()&&o.push(e.goToBattlePosition()),o.push(s.troll.goToBattlePosition()),await Promise.all(o)}}class v4 extends Y.Renderer.WebGL.Pipelines.MultiPipeline{constructor(t){super({game:t,fragShader:`
precision mediump float;
uniform sampler2D uMainSampler[%count%];
uniform float gray;
varying vec2 outTexCoord;
varying float outTexId;
varying vec4 outTint;
varying vec2 fragCoord;
void main()
{
    vec4 texture;
    %forloop%
    gl_FragColor = texture;
    gl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.2126 * gl_FragColor.r + 0.7152 * gl_FragColor.g + 0.0722 * gl_FragColor.b), gray);
}
`,uniforms:["uProjectionMatrix","uMainSampler","gray"]});r(this,"_gray",1);this._gray=1}onPreRender(){this.set1f("gray",this._gray)}get gray(){return this._gray}set gray(t){this._gray=t}}class M4{constructor(t){r(this,"layerUnderButtons");r(this,"rightClickEmitter",Fe());r(this,"leftClickEmitter",Fe());r(this,"onClick",t=>{t.rightButtonDown()?this.rightClickEmitter.emit(t):this.leftClickEmitter.emit(t)});this.scene=t,s.register.interaction(this),window.addEventListener("contextmenu",i=>i.preventDefault()),t.input.on("pointerdown",this.onClick);const e=tt();this.layerUnderButtons=s.render.createSprite("empty_sprite",0,0,e),this.layerUnderButtons.setOrigin(0,0),this.layerUnderButtons.setInteractive(!1),s.layers.add(this.layerUnderButtons,I.UNDER_BUTTONS),this.layerUnderButtons.setVisibility(!1)}setLayerUnderButtonsActive(t){this.layerUnderButtons.setVisibility(!0),this.layerUnderButtons.setInteractive(!0),this.layerUnderButtons.onClick(()=>{t()})}setLayerUnderButtonsUnactive(){this.layerUnderButtons.setInteractive(!1),this.layerUnderButtons.setVisibility(!1)}onRightClick(t){const e=this.rightClickEmitter.sub(t);return()=>this.rightClickEmitter.unsub(e)}onLeftClick(t){const e=this.leftClickEmitter.sub(t);return()=>this.leftClickEmitter.unsub(e)}disableEverything(){s.lair.mayButtonsBeClicked(!1),s.lair.mayBeMovedInto(!1),s.bridge.disableInterface(),s.lair.menu.hide(),this.disableEntities(),console.log("disableEverything")}disableEntities(){s.entities.getAll().forEach(t=>t.setInteractive(!1))}enableEverything(){console.log("enableEverything"),s.lair.mayButtonsBeClicked(s.troll.location===v.LAIR),s.lair.mayBeMovedInto(s.troll.location!==v.LAIR),s.troll.location===v.BRIDGE?s.bridge.disableInterface():s.bridge.enableInterface(),s.troll.location===v.LAIR&&s.lair.menu.show(),s.entities.getAll().forEach(t=>t.updateInteractive())}}class G4{constructor(t){r(this,"options");r(this,"text");r(this,"container");r(this,"disabled",!1);r(this,"PADDING",10);r(this,"oldAlpha",1);this.options=ye({},t),this.container=s.render.createContainer(t.x||0,t.y||0,t&&{parent:t.parent}),this.text=s.render.createText(t.text,0,0,t.style||{fontFamily:"serif",color:R.BLACK},{parent:this.container}),this.text.setOrigin(0,0);const e=this.getRect();this.container.setInteractive(!0,{cursor:"pointer",hitArea:new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height),hitAreaCallback:Phaser.Geom.Rectangle.Contains}),this.container.onClick(()=>this.onClick())}getRect(){const t=10;return{x:-t,y:-t,width:this.text.obj.width+t*2,height:this.text.obj.height+t*2}}onClick(){this.options.onClick()}move(t,e){this.container.move(t,e)}enable(){!this.disabled||(this.disabled=!1,this.container.setInteractive(!0),this.container.alpha=this.oldAlpha)}disable(){this.disabled||(this.disabled=!0,this.container.setInteractive(!1),this.oldAlpha=this.container.alpha,this.container.alpha=.3)}destroy(){this.container.destroy()}setVisible(t){this.container.setVisibility(t)}}class k4 extends G4{constructor(t){t.style||(t.style={});super(t);r(this,"sprite");r(this,"visiblyDisabled");this.visiblyDisabled=!1,this.container.setInteractive(!1),this.sprite=s.render.createSprite(t.img,0,0,{parent:this.container}),this.sprite.alpha=.75,this.sprite.setInteractive(!0,{cursor:"pointer"}),this.sprite.onClick(()=>this.onClick()),t.width&&this.sprite.setWidth(t.width),t.height&&this.sprite.setHeight(t.height),this.sprite.onPointerOver(()=>{this.visiblyDisabled||(this.sprite.alpha=1)}),this.sprite.onPointerOut(()=>{this.visiblyDisabled||(this.sprite.alpha=.75)}),this.text.y=this.text.y-30,this.text.setOrigin(.5,1)}enable(){!this.disabled||(this.disabled=!1,this.sprite.setInteractive(!0),this.sprite.alpha=this.oldAlpha)}disable(){this.disabled||(this.disabled=!0,this.sprite.setInteractive(!1),this.oldAlpha=this.sprite.alpha,this.sprite.alpha=.3)}visiblyDisable(){this.visiblyDisabled=!0,this.oldAlpha=this.sprite.alpha,this.sprite.alpha=.3}visiblyEnable(){this.visiblyDisabled=!1,this.oldAlpha=this.sprite.alpha,this.sprite.alpha=this.oldAlpha}}class H4{constructor(t,e,i,a){r(this,"button");r(this,"cost");r(this,"isEnabled",!0);this.onClickCb=a,this.cost=e,this.button=new k4({img:"button_upgrade",x:t.x,y:t.y,width:32,height:32,text:i+", \u0441\u0442\u043E\u0438\u043C\u043E\u0441\u0442\u044C: "+e+" \u0437\u043E\u043B\u043E\u0442\u0430",onClick:()=>this.onClick()}),this.button.text.obj.setWordWrapWidth(200)}onClick(){this.isEnabled&&this.onClickCb(this)}destroy(){this.button.destroy()}setVisible(t){this.button.setVisible(t),s.lair.treasury.amount<this.cost?(this.isEnabled=!1,this.button.visiblyDisable()):(this.isEnabled=!0,this.button.visiblyEnable())}}class U4{constructor(){r(this,"buttons",[]);r(this,"upgradeButtonsShown",!1);r(this,"unsubFromLClick",et);r(this,"unsubFromRClick",et);r(this,"onClose",null);s.register.upgrade(this)}showButtons(t){s.audio.playSound(E.BONK),this.onClose=t;const e=()=>this.hideButtons();s.interaction.setLayerUnderButtonsActive(e),this.unsubFromRClick=s.interaction.onRightClick(e),s.interaction.disableEverything(),this.setButtonsShown(!0)}hideButtons(){var t,e,i;!this.upgradeButtonsShown||(s.audio.playSound(E.BONK),(t=this.onClose)==null||t.call(this),this.onClose=null,s.interaction.setLayerUnderButtonsUnactive(),s.interaction.enableEverything(),(e=this.unsubFromRClick)==null||e.call(this),this.unsubFromRClick=et,(i=this.unsubFromLClick)==null||i.call(this),this.unsubFromLClick=et,this.setButtonsShown(!1))}setButtonsShown(t){this.upgradeButtonsShown=t,this.buttons.forEach(e=>e.setVisible(t))}onUpgraded(t){s.audio.playSound(E.COLLECT),s.lair.treasury.removeGold(t.cost),t.destroy(),ge(this.buttons,t),this.hideButtons()}createUpgradeButton(t,e,i,a){const o=new H4(t,i,e,c=>{s.audio.playSound(E.UPGRADE),a(),this.onUpgraded(c)});return o.setVisible(!1),s.layers.add(o.button.container,I.FIELD_BUTTONS),this.buttons.push(o),o}}class V4{constructor(t){r(this,"isGameover",!1);r(this,"gameOverReason","");this.scene=t,s.register.game(this)}getScene(){return this.scene}gameOver(t){s.interaction.disableEverything(),this.isGameover=!0,this.gameOverReason=t,b(1500).then(()=>T.emit(g.GAME_OVER))}gameWin(t){this.isGameover=!0,b(1500).then(()=>{s.audio.playMusic(w.MARCH),T.emit(g.GAME_WIN,t)})}}const j4=[[g.GAME_OVER,w.GAMEOVER],[g.BATTLE_STARTED,[w.BATTLE_STARTED_0,w.BATTLE_STARTED_1]],[g.BATTLE_WON,[w.BATTLE_WON_0,w.BATTLE_WON_1]],[g.ENCOUNTER_STARTED,[w.TIME_PASSED_0,w.TIME_PASSED_1,w.TIME_PASSED_2]]];class W4{constructor(){s.register.music(this),j4.forEach(([t,e])=>{T.on(t,()=>{this.play(Array.isArray(e)?X(e):e)})})}play(t){s.audio.playMusic(t)}}const bt=64,K4=10,Ot=20,Ie=10,Re=350,ne=bt+Ot*2,Je=bt+Ot*2+Ie+Re,$4=-(Ot+bt+Ie);class Y4{constructor(){r(this,"container");r(this,"notifications",[]);r(this,"deleteTimer");const t=tt();this.container=s.render.createContainer(t.width,K4),s.layers.add(this.container,I.FIELD_BUTTONS),T.on(g.FEAR_CHANGES,e=>this.onFearChanges(e)),T.on(g.VIGILANTE_PLANNED,e=>this.onVigilantePlanned(e))}show(t,e,i=R.GREEN){const a=this.notifications.length*(ne+Ot),o=s.render.createContainer(0,a+50,{parent:this.container});o.alpha=.5,s.render.fadeIn(o),s.render.flyWithBounceTo(o,{x:0,y:a},100);const c=s.render.createSprite("tile_black",0,0,{width:Je,height:ne,parent:o});c.alpha=.3,c.setOrigin(1,0),s.render.createSprite(e,-Ot,ne/2,{width:bt,height:bt,parent:o}).setOrigin(1,.5);const D=s.render.createText(t,$4,ne/2,{color:i,fontStyle:"bold",fontSize:"20px",wordWrap:{width:Re},stroke:R.BLACK,strokeThickness:3},{parent:o});D.setOrigin(.5,.5),D.x=-(Ot+bt+Ie+Re/2),c.setWidth(Je,!0),this.notifications.push(o),this.updateDeleteTimer(1e4)}updateDeleteTimer(t){clearTimeout(this.deleteTimer),this.deleteTimer=setTimeout(()=>{const e=this.notifications;s.render.fadeOut(e).then(()=>e.forEach(i=>i.destroy())),this.notifications=[]},t)}onFearChanges(t){let e="",i="icon_fear_lowest";switch(t){case W.HARMLESS:e="\u0413\u043E\u0432\u043E\u0440\u044F\u0442, \u0442\u0440\u043E\u043B\u043B\u044C \u0441\u043E\u0432\u0441\u0435\u043C \u0431\u0435\u0437\u043E\u0431\u0438\u0434\u0435\u043D!",i="icon_fear_lowest";break;case W.NOT_SERIOUS:e="\u041F\u043E\u0433\u043E\u0432\u0430\u0440\u0438\u0432\u0430\u044E\u0442, \u0447\u0442\u043E \u0442\u0440\u043E\u043B\u043B\u044C \u043D\u0435 \u0441\u0438\u043B\u044C\u043D\u043E \u043E\u043F\u0430\u0441\u0435\u043D.",i="icon_fear_low";break;case W.UNPREDICTABLE:e="\u041B\u044E\u0434\u0438 \u043D\u0435 \u0437\u043D\u0430\u044E\u0442, \u0447\u0442\u043E \u043E\u0436\u0438\u0434\u0430\u0442\u044C \u043E\u0442 \u0442\u0440\u043E\u043B\u043B\u044F \u043D\u0430 \u043C\u043E\u0441\u0442\u0443.",i="icon_fear_medium";break;case W.DANGEROUS:e="\u0412\u0441\u0435 \u0432 \u043E\u043A\u0440\u0435\u0441\u0442\u043D\u043E\u0441\u0442\u044F\u0445 \u043E\u043F\u0430\u0441\u0430\u044E\u0442\u0441\u044F \u0442\u0440\u043E\u043B\u043B\u044F",i="icon_fear_high";break;case W.HORRIFIC:e="\u041B\u044E\u0434\u0438 \u0432 \u0443\u0436\u0430\u0441\u0435 \u043E\u0442 \u0436\u0435\u0441\u0442\u043E\u043A\u043E\u0441\u0442\u0438 \u0442\u0440\u043E\u043B\u043B\u044F!",i="icon_fear_highest";break}this.show(e,i,R.WHITE)}onVigilantePlanned(t){this.show("\u041B\u044E\u0434\u0438 \u0440\u0435\u0448\u0438\u043B\u0438 \u0438\u0441\u0442\u0440\u0435\u0431\u0438\u0442\u044C \u0436\u0435\u0441\u0442\u043E\u043A\u043E\u0433\u043E \u0442\u0440\u043E\u043B\u043B\u044F. \u041A \u043D\u0435\u043C\u0443 \u043F\u0440\u0438\u0434\u0443\u0442 \u0447\u0435\u0440\u0435\u0437: "+t+" \u0445\u043E\u0434\u043E\u0432","icon_angry_people",R.RED)}}const Qe=tt();var X4={type:Y.WEBGL,width:Qe.width,height:Qe.height,pixelArt:!0,physics:{default:"arcade",arcade:{gravity:{y:0}}},scene:{preload:function(){this.load.plugin("rexshakepositionplugin","https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexshakepositionplugin.min.js",!0),nu.load(this),q4(this)},create:function(){z4(this)}},pipeline:{Gray:v4}};const q4=u=>{Object.keys(Q.images).forEach(e=>u.load.image(e,Q.images[e]))},z4=u=>{new V4(u);const t=new O4;new _u(u),new mu(u),new M4(u),new Hu,new Lu(u),new U4,new qu,new I4,new r4,new Yu,new B4,new P4,new $u,new W4,new Y4,u.update=function(e,i){t.onUpdate(i)}},J4=()=>new Y.Game(X4);var Nt;(function(u){u.EN="en",u.RU="ru"})(Nt||(Nt={}));uu.init({resources:{[Nt.EN]:{translation:{"Main Menu":"Main Menu",Settings:"Settings",Pause:"Pause","Start Game":"Start Game",Resume:"Resume",Language:"Language",Back:"Back",Loading:"Loading","Sound Volume":"Sound Volume","Music Volume":"Music Volume",Chars:{Farmer:"peasant"},wait:"Wait"}},[Nt.RU]:{translation:{"Main Menu":"\u0413\u043B\u0430\u0432\u043D\u043E\u0435 \u041C\u0435\u043D\u044E",Settings:"\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438",Pause:"\u041F\u0430\u0443\u0437\u0430","Start Game":"\u041D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443",Resume:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",Language:"\u042F\u0437\u044B\u043A",Back:"\u041D\u0430\u0437\u0430\u0434",Loading:"\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430","Sound Volume":"\u0413\u0440\u043E\u043C\u043A\u043E\u0441\u0442\u044C \u0437\u0432\u0443\u043A\u0430","Music Volume":"\u0413\u0440\u043E\u043C\u043A\u043E\u0441\u0442\u044C \u043C\u0443\u0437\u044B\u043A\u0438",Chars:{Farmer:"\u043A\u0440\u0435\u0441\u0442\u044C\u044F\u043D\u0438\u043D"},wait:"\u0416\u0434\u0430\u0442\u044C"}}},lng:Nt.EN,fallbackLng:Nt.EN,interpolation:{escapeValue:!1}});const Q4=()=>{const[u,t]=Xt.exports.useState("");return Xt.exports.useEffect(()=>{const e=T.on(g.GAME_WIN,i=>t(i));return()=>T.unsubscribe(g.GAME_WIN,e)},[t]),u?V("div",{id:"gamewin",children:[N("div",{className:"title",children:"\u041F\u043E\u0431\u0435\u0434\u0430!"}),N("div",{className:"reason",children:u})]}):null},Z4=()=>{const[u,t]=Xt.exports.useState(!0);return V("div",{className:"how-to-play",children:[N("button",{className:"how-to-play__open",onClick:e=>{t(!u)},children:u?"?":"X"}),!u&&N("div",{className:"how-to-play__instructions-overlay",children:V("div",{className:"how-to-play__instructions",children:[N("h2",{children:"\u0425\u0430\u0440\u0430\u043A\u0442\u0435\u0440\u0438\u0441\u0442\u0438\u043A\u0438 \u0442\u0440\u043E\u043B\u043B\u044F:"}),V("ul",{children:[V("li",{children:[N("b",{children:"\u0423\u0440\u043E\u0432\u0435\u043D\u044C"}),": \u043C\u0430\u043A\u0441\u0438\u043C\u0443\u043C 5. \u041E\u043F\u044B\u0442 \u0443\u0432\u0435\u043B\u0438\u0447\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u043E\u0442 \u0443\u0441\u043F\u0435\u0448\u043D\u043E\u0433\u043E \u0433\u0440\u0430\u0431\u0435\u0436\u0430 \u043F\u0443\u0442\u043D\u0438\u043A\u043E\u0432."]}),V("li",{children:[N("b",{children:"\u0417\u0434\u043E\u0440\u043E\u0432\u044C\u0435"}),": \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0435\u0434\u043E\u0439 \u0438 \u0441\u043D\u043E\u043C"]}),V("li",{children:[N("b",{children:"\u0413\u043E\u043B\u043E\u0434"}),": \u0435\u0441\u043B\u0438 \u043E\u043F\u0443\u0441\u0442\u0438\u0442\u0441\u044F \u0434\u043E \u043D\u0443\u043B\u044F \u0432\u043C\u0435\u0441\u0442\u0435 \u0441\u043E \u0437\u0434\u043E\u0440\u043E\u0432\u044C\u0435\u043C - \u0432\u044B \u043F\u0440\u043E\u0438\u0433\u0440\u0430\u0435\u0442\u0435"]}),V("li",{children:[N("b",{children:"\u0421\u0430\u043C\u043E\u043A\u043E\u043D\u0442\u0440\u043E\u043B\u044C"}),": \u0443\u043C\u0435\u043D\u044C\u0448\u0430\u0435\u0442\u0441\u044F \u043E\u0442 \u043F\u043E\u0435\u0434\u0430\u043D\u0438\u044F \u0441\u044B\u0440\u043E\u0433\u043E \u0438 \u0447\u0435\u043B\u043E\u0432\u0435\u0447\u0435\u0441\u043A\u043E\u0433\u043E \u043C\u044F\u0441\u0430. \u0427\u0435\u043C \u043C\u0435\u043D\u044C\u0448\u0435 - \u0442\u0435\u043C \u0432\u044B\u0448\u0435 \u0448\u0430\u043D\u0441 \u0432\u043F\u0430\u0434\u0435\u043D\u0438\u044F \u0432 \u044F\u0440\u043E\u0441\u0442\u044C."]}),V("li",{children:[N("b",{children:'"\u0421\u0442\u0440\u0430\u0448\u043D\u043E\u0441\u0442\u044C"'}),": \u043D\u0430\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u0432\u0430\u0441 \u0431\u043E\u044F\u0442\u0441\u044F \u0432 \u043E\u043A\u0440\u0443\u0433\u0435. \u0427\u0435\u043C \u0432\u044B\u0448\u0435 - \u0442\u0435\u043C \u0431\u043E\u043B\u044C\u0448\u0435 \u0448\u0430\u043D\u0441 \u0442\u043E\u0433\u043E, \u0447\u0442\u043E \u043F\u0443\u0442\u043D\u0438\u043A\u0438 \u0437\u0430\u043F\u043B\u0430\u0442\u044F\u0442 \u0431\u0435\u0437 \u0431\u043E\u044F. \u041D\u043E \u0442\u0430\u043A\u0436\u0435 \u0438 \u0442\u043E\u0433\u043E, \u0447\u0442\u043E \u0442\u0440\u043E\u043B\u043B\u044F \u043F\u0440\u0438\u0434\u0443\u0442 \u0438\u0441\u0442\u0440\u0435\u0431\u043B\u044F\u0442\u044C."]})]}),N("h2",{children:"\u041A\u0430\u043A \u043C\u0430\u043D\u0438\u043F\u0443\u043B\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0435\u0434\u043E\u0439 (\u043F\u043E\u043A\u0430 \u0447\u0442\u043E \u043D\u0435\u0443\u0434\u043E\u0431\u043D\u043E, \u0434\u0430):"}),V("ul",{children:[N("li",{children:"\u041B\u041A\u041C - \u043F\u043E\u043B\u043E\u0436\u0438\u0442\u044C \u043D\u0430 \u0441\u0443\u0448\u0438\u043B\u043A\u0443 \u0438\u043B\u0438 \u0441\u044A\u0435\u0441\u0442\u044C"}),N("li",{children:"\u041F\u041A\u041C - \u0441\u043D\u044F\u0442\u044C \u0441 \u0441\u0443\u0448\u0438\u043B\u043A\u0438 \u0438\u043B\u0438 \u0432\u044B\u043A\u0438\u043D\u0443\u0442\u044C"})]}),N("h2",{children:"\u041F\u043E\u0441\u0442\u0440\u043E\u0439\u043A\u0438"}),V("ul",{children:[V("li",{children:[N("b",{children:"\u041A\u043E\u0442\u0435\u043B"}),": \u043F\u043E\u0437\u0432\u043E\u043B\u044F\u0435\u0442 \u0433\u043E\u0442\u043E\u0432\u0438\u0442\u044C \u0435\u0434\u0443. \u0421\u0432\u0435\u0436\u0430\u044F \u043F\u0440\u0438\u0433\u043E\u0442\u043E\u0432\u043B\u0435\u043D\u043D\u0430\u044F \u0435\u0434\u0430 \u0434\u0430\u0435\u0442 \u0431\u043E\u043B\u044C\u0448\u0435 HP \u0438 \u043D\u0435 \u0443\u043C\u0435\u043D\u044C\u0448\u0430\u0435\u0442 \u0441\u0430\u043C\u043E\u043A\u043E\u043D\u0442\u0440\u043E\u043B\u044C, \u0435\u0441\u043B\u0438 \u0432 \u043D\u0435\u0439 \u043D\u0435\u0442 \u0447\u0435\u043B\u043E\u0432\u0435\u0447\u0438\u043D\u044B."]}),V("li",{children:[N("b",{children:"\u041A\u0440\u043E\u0432\u0430\u0442\u044C"}),": \u0442\u0440\u043E\u043B\u043B\u044C \u0432\u043E \u0441\u043D\u0435 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u0442 \u0431\u043E\u043B\u044C\u0448\u0435 \u0437\u0434\u043E\u0440\u043E\u0432\u044C\u044F"]}),V("li",{children:[N("b",{children:"\u0423\u043A\u0440\u0430\u0448\u0435\u043D\u0438\u044F \u0434\u043B\u044F \u043C\u043E\u0441\u0442\u0430"}),": \u043F\u043E \u0443\u043A\u0440\u0430\u0448\u0435\u043D\u043D\u043E\u043C\u0443 \u043C\u043E\u0441\u0442\u0443 \u0438\u043D\u043E\u0433\u0434\u0430 \u0431\u0443\u0434\u0435\u0442 \u043F\u0440\u043E\u0435\u0437\u0436\u0430\u0442\u044C \u041A\u043E\u0440\u043E\u043B\u044C."]})]}),N("h2",{children:"\u0423\u0441\u043B\u043E\u0432\u0438\u044F \u043F\u043E\u0431\u0435\u0434\u044B"}),"\u041E\u0433\u0440\u0430\u0431\u0438\u0442\u044C \u043E\u0442\u0440\u044F\u0434 \u041A\u043E\u0440\u043E\u043B\u044F!"]})})]})};window.game=J4();const Se=document.createElement("app");Se.id="app";document.body.appendChild(Se);const t0=()=>V("div",{id:"temp-interface",children:[N(ru,{}),N(Q4,{}),N(Z4,{})]});setTimeout(()=>{su.exports.render(N(t0,{}),Se)},2e3);
